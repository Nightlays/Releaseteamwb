
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Regress Dashboard ‚Äî –î–∞—à–±–æ—Ä–¥</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- ExcelJS (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é, –æ—Å—Ç–∞–≤–ª—è—é –∫–∞–∫ –±—ã–ª–æ) -->
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
<!-- SheetJS (Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- XlsxPopulate (—Å—Ç–∏–ª–∏ Excel –≤ –±—Ä–∞—É–∑–µ—Ä–µ) -->
<script src="https://unpkg.com/xlsx-populate/browser/xlsx-populate.min.js"></script>


<!-- INLINE FILTERS OVERRIDE: keep controls on one line -->

  <link rel="stylesheet" href="dashboard_run.css">
</head>

<body class="authed">


<div class="wrap">
  <h1>–û—Å—Ç–∞—Ç–æ–∫ –∫–µ–π—Å–æ–≤ –Ω–∞ —Ä–µ–≥—Ä–µ—Å—Å v.3.2</h1>

 <div class="tabs">
  <button id="tabDashBtn" class="active">–î–∞—à–±–æ—Ä–¥</button>
</div>

  <!-- ======= –ü–ê–ù–ï–õ–¨ –ü–ê–†–ê–ú–ï–¢–†–û–í ======= -->
  <div class="panel card" style="grid-template-columns:repeat(12,minmax(0,1fr));">
    <div class="field" style="grid-column:span 3"><label>Base URL</label><input id="baseUrl" placeholder="https://allure-testops.wb.ru"></div>
    <div class="field" style="grid-column:span 2"><label>Project ID</label><input id="projectId" placeholder="7"></div>
    <div class="field" style="grid-column:span 2"><label>–í–µ—Ä—Å–∏—è (–ø—Ä–∏–º–µ—Ä: 7.2.6)</label><input id="version" placeholder="7.2.6"></div>
    <div class="field" style="grid-column:span 3"><label>API —Ç–æ–∫–µ–Ω</label><input id="token" placeholder="–≤—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω"></div>
    <div style="grid-column:span 4;display:flex;gap:8px;align-items:end;flex-wrap:wrap">
      <button id="runBtn" class="btn primary">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
      <button id="saveSettingsBtn" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    </div>

    <div style="grid-column:span 12;display:flex;flex-wrap:wrap;gap:8px;align-items:end">
      <button id="dataPick" class="btn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö</button>
      <button id="dataCreate" class="btn">–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –¥–∞–Ω–Ω—ã—Ö</button>
      <button id="dataSave" class="btn success" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª</button>

      <input id="dataImport" type="file" accept="application/json" style="display:none">
      <button id="dataImportBtn" class="btn">–ò–º–ø–æ—Ä—Ç JSON</button>
      <button id="dataExportBtn" class="btn">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button id="dataExportCsv" class="btn">–≠–∫—Å–ø–æ—Ä—Ç CSV (—Å—Ä–µ–∑—ã)</button>

      <div class="auto" style="margin-left:auto;display:grid;grid-auto-flow:column;gap:10px;align-items:center">
        <div class="nums" id="autoState">–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫: –≤—ã–∫–ª—é—á–µ–Ω</div>
        <div class="field" style="display:grid;grid-template-columns:auto"><label>–ò–Ω—Ç–µ—Ä–≤–∞–ª (–º–∏–Ω)</label><input id="autoMins" value="20"></div>
        <button id="autoStart" class="btn success">–°—Ç–∞—Ä—Ç</button>
        <button id="autoStop" class="btn danger" disabled>–°—Ç–æ–ø</button>
      </div>
    </div>
  </div>

  <!-- ====================== –î–ê–®–ë–û–†–î ====================== -->
  <div id="tabDash" class="tab-section">
    <!-- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ–ª–∏–∑—É (Android + iOS) -->
    <div class="card" id="releaseWrap" style="margin-bottom:16px">
      <div class="head">
        <div>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ–ª–∏–∑—É</div>
        <div class="nums" id="releaseHeadVer">–í–µ—Ä—Å–∏—è: ‚Äî</div>
      </div>
      <div class="release-row" id="releaseRow"></div>
    </div>

    <!-- –ú–∏–Ω–∏-–¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ –ª–∞—É–Ω—á–∞–º -->
    <div class="card" id="miniLaunchCard" style="margin-bottom:16px">
      <div class="head">
        <div>–ú–∏–Ω–∏-–¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ –ª–∞—É–Ω—á–∞–º</div>

        <div class="export" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <button id="miniToggleBtn" class="mini">–ü–æ–∫–∞–∑–∞—Ç—å</button>

          <label class="nums">–ü–æ–∫–∞–∑–∞—Ç—å</label>
          <input id="miniCount" class="mini" type="number" value="150" min="1" max="300" style="width:70px">

          <label class="nums">–°–æ—Ä—Ç</label>
          <select id="miniSortKey" class="mini">
            <option value="pct" selected>% –ø—Ä–æ–π–¥–µ–Ω–æ</option>
            <option value="finished">–ü—Ä–æ–π–¥–µ–Ω–æ (—à—Ç)</option>
            <option value="total">–í—Å–µ–≥–æ (—à—Ç)</option>
            <option value="created">–°–≤–µ–∂–µ—Å—Ç—å</option>
          </select>
          <select id="miniSortDir" class="mini">
            <option value="desc" selected>DESC</option>
            <option value="asc">ASC</option>
          </select>

          <label class="nums">–û—Ç–¥–µ–ª</label>
          <select id="miniDept" class="mini">
            <option value="all" selected>–í—Å–µ</option>
            <option value="–ö–æ—Ä–∑–∏–Ω–∞">–ö–æ—Ä–∑–∏–Ω–∞</option>
            <option value="–§–∏–Ω—Ç–µ—Ö">–§–∏–Ω—Ç–µ—Ö</option>
            <option value="–ß–∞—Ç—ã">–ß–∞—Ç—ã</option>
            <option value="–í–•">–í–•</option>
            <option value="–û—Å—Ç–∞–ª—å–Ω—ã–µ">–û—Å—Ç–∞–ª—å–Ω—ã–µ</option>
          </select>

          <!-- —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ -->
          <label class="nums">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</label>
          <select id="miniPlatform" class="mini">
            <option value="all" selected>–í—Å–µ</option>
            <option value="android">Android</option>
            <option value="ios">iOS</option>
          </select>
        </div>
      </div>
      <div id="miniWrap" style="display:none">
        <div class="nums" id="miniInfo">‚Äî</div>
        <div class="mini-grid" id="miniGrid"></div>
      </div>
    </div>

    <!-- –°–≤–æ–¥–Ω—ã–π –±–∞—Ä—á–∞—Ä—Ç -->
    <div class="card">
      <div class="head">
        <div>–°–≤–æ–¥–Ω—ã–π –±–∞—Ä—á–∞—Ä—Ç</div>
        <div class="export">
          <button id="expBarPng" class="mini">PNG</button>
          <button id="expBarSvg" class="mini">SVG</button>
          <button id="expAggCsv" class="mini">CSV</button>
          <button id="expAggJson" class="mini">JSON</button>
        </div>
      </div>
      <div id="chartFiltersWrap" style="margin:8px 0 -4px; padding:6px 10px; background:rgba(255,255,255,.6); border:1px solid #eee; border-radius:10px; display:flex; flex-wrap:wrap; gap:14px; align-items:center;">
        <div>
          <span style="font-weight:600;color:#444;margin-right:6px;">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</span>
          <label style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;"><input type="checkbox" id="fltPlatIOS" checked> iOS</label>
          <label style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;"><input type="checkbox" id="fltPlatAndroid" checked> Android</label>
        </div>
        <div>
          <span style="font-weight:600;color:#444;margin:0 6px 0 2px;">–¢–∏–ø:</span>
          <label style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;"><input type="checkbox" id="fltTypeSmoke" checked> Smoke</label>
          <label style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;"><input type="checkbox" id="fltTypeSelective" checked> Selective</label>
          <label style="display:inline-flex;align-items:center;gap:6px;margin-right:10px;"><input type="checkbox" id="fltTypeHB" checked> High/Blocker</label>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px;">
          <button type="button" id="fltAll"  class="mini" style="padding:6px 12px;">–í—Å–µ</button>
          <button type="button" id="fltNone" class="mini" style="padding:6px 12px;">–°–±—Ä–æ—Å</button>
        </div>
      </div>
    
      <div class="nums" id="summaryInfo">‚Äî</div>
      <div class="chart-wrap"><canvas id="barAll" class="chart"></canvas></div>
    </div>

    <div class="grid" id="cards"></div>

    <div class="split">
      <div class="card">
        <div class="head">
          <div>–õ–æ–≥</div>
          <div class="nums" id="logInfo">‚Äî</div>
        </div>

        <div id="logProgressWrap" style="margin:4px 0 8px 0">
          <div class="nums" id="logProgressCaption"></div>
          <div class="progress"><div id="logProgressBar"></div></div>
        </div>

        <div class="log" id="log"></div>
      </div>

      <div class="card">
        <div class="head">
          <div>–ê–ª–ª–µ—Ä—Ç –ø–æ –ª–∞—É–Ω—á–∞–º</div>
          <div class="export">
            <label class="nums">–§–∏–ª—å—Ç—Ä:</label>
            <select id="alertFilter" class="mini">
              <option value="all" selected>–í—Å–µ</option>
              <option value="passed">–ï—Å—Ç—å –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–µ</option>
              <option value="none">–ù–µ—Ç –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö</option>
              <option value="empty">–ë–µ–∑ –∫–µ–π—Å–æ–≤</option>
            </select>
          </div>
        </div>
        <div class="log" id="alertLog">–ü–æ–∫–∞ –∞–ª–ª–µ—Ä—Ç–æ–≤ –Ω–µ—Ç.</div>
      </div>
    </div>

    <!-- ====== –°—Ä–µ–∑—ã: –û–±—â–∏–µ –∏ –ü–æ —Å—Ç—Ä–∏–º—É ====== -->
    <div class="card" style="margin-top:16px">
      <div class="head">
        <div>–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ä–µ–∑—ã</div>
        <div class="subtabs">
          <button id="subtabGeneral" class="mini active">–û–±—â–∏–µ</button>
          <button id="subtabStream" class="mini">–ü–æ —Å—Ç—Ä–∏–º—É</button>
        </div>
      </div>

      <!-- === –û–±—â–∏–µ === -->
      <div id="snapGeneralSection">
        <div class="export" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
          <label class="nums">–ú–µ—Ç—Ä–∏–∫–∞</label>
          <select id="dashMetric" class="mini">
            <option value="finished" selected>–ü—Ä–æ–π–¥–µ–Ω–æ</option>
            <option value="total">–í—Å–µ–≥–æ</option>
            <option value="remaining_total">–û—Å—Ç–∞–ª–æ—Å—å</option>
            <option value="remaining">–ù–∞–∑–Ω–∞—á–µ–Ω–æ</option>
            <option value="in_progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
          </select>
          <label class="nums">–¢–∏–ø</label>
          <select id="dashKind" class="mini">
            <option value="all" selected>–í—Å–µ —Ç–∏–ø—ã</option>
            <option value="sm_sel">Smoke + Selective</option>
            <option value="hb_only">High/Blocker</option>
          </select>
          <button id="dashSnapSave" class="mini">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ä–µ–∑</button>
          <button id="dashSnapBuild" class="mini">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
          <button id="dashSnapClear" class="mini">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>
        <div id="snapListDash" class="snap-list"></div>
        <div class="kpis" id="dashDelta" style="margin-top:8px"></div>
        <div class="chart-wrap" style="height:320px"><canvas id="dashPrevCurr" class="chart"></canvas></div>
        <div class="chart-wrap" style="height:320px"><canvas id="dashMultiBar" class="chart"></canvas></div>
      </div>

      <!-- === –ü–æ —Å—Ç—Ä–∏–º—É (Smoke / Selective) === -->
      <div id="snapStreamSection" style="display:none">
        <div class="export" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
          <label class="nums">–°—Ç—Ä–∏–º</label>
          <select id="streamKind" class="mini">
            <option value="Smoke" selected>Smoke</option>
            <option value="Selective">Selective</option>
            <option value="High/Blocker">High/Blocker</option>
          </select>
          <label class="nums">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∏–º–∞</label>
<select id="streamName" class="mini">
  <option value="__all__" selected>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∏–º ‚Äî</option>
</select>
          <label class="nums">–ú–µ—Ç—Ä–∏–∫–∞</label>
          <select id="dashMetricStream" class="mini">
            <option value="finished" selected>–ü—Ä–æ–π–¥–µ–Ω–æ</option>
            <option value="total">–í—Å–µ–≥–æ</option>
            <option value="remaining_total">–û—Å—Ç–∞–ª–æ—Å—å</option>
            <option value="remaining">–ù–∞–∑–Ω–∞—á–µ–Ω–æ</option>
            <option value="in_progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
          </select>
          <button id="dashStreamSnapSave" class="mini">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ä–µ–∑ (—Å—Ç—Ä–∏–º)</button>
          <button id="dashStreamSnapBuild" class="mini">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ</button>
          <button id="dashStreamSnapClear" class="mini">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>
        <div id="snapListDashStream" class="snap-list"></div>
        <div class="kpis" id="dashDeltaStream" style="margin-top:8px"></div>
        <div class="chart-wrap" style="height:320px"><canvas id="dashPrevCurrStream" class="chart"></canvas></div>
        <div class="chart-wrap" style="height:320px"><canvas id="dashMultiBarStream" class="chart"></canvas></div>
      </div>
    </div>
  </div>

  <div class="title">Regress Dashboard by Iliasov D.S n Rusakov A.G</div>

  </div>

<div id="toast" class="toast"></div>

<script>
(function(){
  /* ===== —É—Ç–∏–ª–∏—Ç—ã DOM/—Å—Ç–∏–ª—è ===== */
  function $(s){ return document.querySelector(s); }
  function $all(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
  function toast(msg){ var t=$('#toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(function(){ t.classList.remove('show'); },1600); }
  function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function hexA(hex, a){ var c=hex.replace('#',''); var n=parseInt(c,16); var r=(n>>16)&255,g=(n>>8)&255,b=n&255; return 'rgba('+r+','+g+','+b+','+a+')'; }
  function fitHiDPICanvas(canvas){ var dpr=Math.max(1,window.devicePixelRatio||1); var rect=canvas.getBoundingClientRect(); var w=Math.round(rect.width*dpr), h=Math.round(rect.height*dpr); if(canvas.width!==w||canvas.height!==h){ canvas.width=w; canvas.height=h; } }
  function makeCtx(canvas){ fitHiDPICanvas(canvas); return canvas.getContext('2d'); }
  function escapeHtml(str){
    return String(str||'').replace(/[&<>"']/g, s=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[s]));
  }

  /* ===== –≥–ª–æ–±–∞–ª—å–Ω—ã–µ ===== */
  window.__charts={}; window.addEventListener('resize', function(){ for(var k in window.__charts){ if(window.__charts[k].maker) window.__charts[k].maker(); } });

  Chart.defaults.devicePixelRatio=Math.max(1,window.devicePixelRatio||1);
  Chart.defaults.font.family="Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
  Chart.defaults.font.size=13;
  Chart.defaults.color=getComputedStyle(document.documentElement).getPropertyValue('--text').trim()||'#2a1446';
  Chart.defaults.plugins.legend.labels.usePointStyle=true;

  // –ú–∏–Ω–∏-–¥–∏–∞–≥—Ä–∞–º–º—ã: —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ + –æ–ø—Ü–∏–∏
  window.__mini_last = null;
  const MINI_DEFAULTS = { count: 24, sortKey: 'pct', sortDir: 'desc', dept: 'all', platform: 'all' };

  function readMiniOpts(){
    const count = Math.max(1, Math.min(120, parseInt($('#miniCount')?.value||MINI_DEFAULTS.count,10)||MINI_DEFAULTS.count));
    const sortKey = ($('#miniSortKey')?.value)||MINI_DEFAULTS.sortKey;
    const sortDir = ($('#miniSortDir')?.value)||MINI_DEFAULTS.sortDir;
    const dept = ($('#miniDept')?.value)||MINI_DEFAULTS.dept;
    const platform = ($('#miniPlatform')?.value)||MINI_DEFAULTS.platform;
    return {count, sortKey, sortDir, dept, platform};
  }

  function rebuildMini(){
    if(!window.__mini_last) return;
    const {launches, perLaunchFinished, perLaunchTotal} = window.__mini_last;
    buildMiniLaunchCharts(launches, perLaunchFinished, perLaunchTotal, readMiniOpts());
  }

  /* –¶–µ–Ω—Ç—Ä–æ–≤–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è doughnut */
  const DoughnutCenterText = {
    id: 'doughnutCenterText',
    afterDraw(chart){
      const ds = chart.data.datasets?.[0];
      if(!ds || typeof ds.__pct !== 'number') return;
      const {ctx, chartArea} = chart;
      const x = (chartArea.left + chartArea.right)/2;
      const y = (chartArea.top + chartArea.bottom)/2;
      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = getCSS('--text');
      ctx.font = '700 16px ' + Chart.defaults.font.family;
      ctx.fillText(ds.__pct + '%', x, y);
      ctx.restore();
    }
  };

  var COLORS={ total:getCSS('--c1'), finished:getCSS('--c2'), remaining_total:getCSS('--c3'), remaining:getCSS('--c3'), in_progress:getCSS('--c4') };
  var ORDER = ["[iOS][Smoke]","[iOS][Selective]","[Android][Smoke]","[Android][Selective]","[iOS][High/Blocker]","[Android][High/Blocker]"];

  // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Ç–∏–ø—É (dashKind) ---
  function allowByKind(label){
    label = String(label||'');
    var sel = document.getElementById('dashKind');
    var v = sel ? sel.value : 'all';

    var isHB = label.indexOf('[High/Blocker]') !== -1;

    if (v === 'hb_only') return isHB;
    if (v === 'sm_sel')  return !isHB;
    return true; // 'all' –∏–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ
  }
  var CURRENT_BASE_URL = '';
  var barAllChartRef = null;

  /* ===== –º–∏–∫—Ä–æ-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ===== */
  const now = ()=> performance.now();

  // –ü–∞–∫–µ—Ç–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  const logBuf=[]; let logTimer=null;
  function flushLog(){
    if(!logBuf.length) return;
    const el=$('#log'); if(!el) { logBuf.length=0; return; }
    el.textContent += (el.textContent ? '\n' : '') + logBuf.join('\n');
    el.scrollTop = el.scrollHeight;
    logBuf.length=0; logTimer=null;
  }
  function appendLogLine(line){
    logBuf.push(line);
    if(!logTimer) logTimer=setTimeout(flushLog, 80);
  }
  function logDash(msg){ appendLogLine(msg); }

  // –ö–µ—à GET-–∑–∞–ø—Ä–æ—Å–æ–≤
  const GET_CACHE = new Map();
  const UWU_CACHE = new Map();
  function cacheKey(url, params, headers){
    const qs=params?new URLSearchParams(params).toString():'';
    return url + (qs?('?'+qs):'') + '|' + (headers?.Authorization||'');
  }

  // –ü—É–ª –ø—Ä–æ–º–∏—Å–æ–≤
  async function pMap(arr, mapper, {concurrency=8, onProgress}={}){
    return new Promise((resolve,reject)=>{
      if(!arr || arr.length===0){ resolve([]); return; }
      let i=0, done=0, out=new Array(arr.length), active=0, stopped=false;
      const next=()=>{
        if(stopped) return;
        while(active<concurrency && i<arr.length){
          const idx=i++, val=arr[idx]; active++;
          Promise.resolve().then(()=>mapper(val, idx)).then(res=>{
            out[idx]=res; active--; done++; if(onProgress) onProgress(done, arr.length); (done===arr.length)?resolve(out):next();
          }).catch(e=>{ stopped=true; reject(e); });
        }
      };
      next();
    });
  }

  async function safeJson(resp){ try{ return await resp.json(); }catch(_){ return null; } }

/* ===== —Ä–µ–Ω–¥–µ—Ä –≥—Ä–∞—Ñ–∏–∫–æ–≤ ===== */
function makeBarChart(canvasId, labels, datasets){
  var canvas = document.getElementById(canvasId);
  if (!canvas) return;

  var maker = function(){
    fitHiDPICanvas(canvas);
    var ctx = makeCtx(canvas);

    if (window.__charts[canvasId] && window.__charts[canvasId].chart){
      try { window.__charts[canvasId].chart.destroy(); } catch(e){}
    }

    function colorFor(key){
      return key==='total' ? COLORS.total
           : key==='finished' ? COLORS.finished
           : key==='remaining_total' ? COLORS.remaining_total
           : key==='remaining' ? COLORS.remaining
           : key==='in_progress' ? COLORS.in_progress
           : COLORS.finished;
    }

    // 1) –õ–µ–π–±–ª—ã-–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–≤–µ—Ä—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ (—á–∏—Ç–∞–±–µ–ª—å–Ω–æ –∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ)
    const valueLabelsPlugin = {
      id: 'valueLabels',
      afterDatasetsDraw(chart){
        const {ctx, chartArea} = chart;
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'bottom';
        ctx.font = Chart.helpers.toFont(Chart.defaults.font).string;

        chart.data.datasets.forEach((ds, di)=>{
          const meta = chart.getDatasetMeta(di);
          if (!meta || !meta.data) return;

          meta.data.forEach((bar, i)=>{
            if (!bar) return;
            const val = Number(ds.data?.[i] || 0);
            if (val === 0) return;

            const {x, y} = bar.getProps(['x','y'], true);
            // –¥–µ—Ä–∂–∏–º –ø–æ–¥–ø–∏—Å—å –≤–Ω—É—Ç—Ä–∏ –æ–±–ª–∞—Å—Ç–∏ –≥—Ä–∞—Ñ–∏–∫–∞
            const yy = Math.min(Math.max(y - 6, chartArea.top + 6), chartArea.bottom - 6);

            ctx.fillStyle = getCSS('--ink');
            ctx.fillText(val.toLocaleString('ru-RU'), x, yy);
          });
        });
        ctx.restore();
      }
    };

    // 2) –î–µ–ª—å—Ç–∞ –Ω–∞–¥ ¬´–¢–µ–∫—É—â–∏–º¬ª –≤ prev/curr
    const deltaPlugin = {
      id: 'deltaInside',
      afterDatasetsDraw(chart) {
        if (chart.canvas.id !== 'dashPrevCurr' && chart.canvas.id !== 'dashPrevCurrStream') return;

        const dsCurr = chart.data.datasets[1];
        const deltas = (dsCurr && dsCurr.__delta) || [];
        const meta = chart.getDatasetMeta(1);
        if (!meta || !meta.data) return;

        const { ctx, chartArea } = chart;
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = '700 12px ' + Chart.defaults.font.family;

        // helper: —Å–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
        function rrect(x, y, w, h, r){
          const rr = Math.min(r, h/2, w/2);
          ctx.beginPath();
          ctx.moveTo(x+rr, y);
          ctx.arcTo(x+w, y,   x+w, y+h, rr);
          ctx.arcTo(x+w, y+h, x,   y+h, rr);
          ctx.arcTo(x,   y+h, x,   y,   rr);
          ctx.arcTo(x,   y,   x+w, y,   rr);
          ctx.closePath();
        }

        meta.data.forEach((elem, i) => {
          if (!elem) return;
          const d = Number(deltas[i] || 0);
if (d === 0) return;  // üî¥ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –¥–µ–ª—å—Ç—ã
const txt = (d > 0 ? '+' : '') + d.toLocaleString('ru-RU');

          const { x, y, base } = elem.getProps(['x','y','base'], true);
          let cy = y + (base - y) / 2;               // —Ü–µ–Ω—Ç—Ä —Å—Ç–æ–ª–±—Ü–∞
          const pad = 12;
          cy = Math.max(chartArea.top + pad, Math.min(chartArea.bottom - pad, cy));

          const w = ctx.measureText(txt).width + 10;
          const h = 18;
          ctx.fillStyle = 'rgba(255,255,255,.85)';
          rrect(x - w/2, cy - h/2, w, h, 8);
          ctx.fill();

          ctx.fillStyle = getCSS('--ink') || getCSS('--text') || '#2a1446';
          ctx.fillText(txt, x, cy);
        });

        ctx.restore();
      }
    };

    const isPrevCurr = (canvasId==='dashPrevCurr' || canvasId==='dashPrevCurrStream');

    var cfg = {
      type: 'bar',
      data: {
        labels: labels,
        datasets: datasets.map(function(ds){
          return {
            label: ds.label,
            data: ds.data,
            backgroundColor: ds.backgroundColor || hexA(colorFor(ds.key), ds.key==='total' ? .45 : .85),
            borderColor: ds.borderColor || colorFor(ds.key),
            borderWidth: 1.5,
            borderRadius: 6,
            borderSkipped: false,
            barThickness: 'flex',
            maxBarThickness: 46,
            categoryPercentage: 0.7,
            barPercentage: 0.9
          };
        })
      },
      options: {
        maintainAspectRatio: false,
        animation: false,
        layout: { padding: { top: 8, bottom: 8 } },
        plugins: {
          legend: { position: 'bottom' },
          // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –≥–∞—Å–∏–º chartjs-plugin-datalabels, –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ
          datalabels: false
        },
        scales: {
          x: { grid: { display: false } },
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(148,163,184,.2)' },
            ticks: { stepSize: 500 }
          }
        }
      },
      // –ü–æ–¥–∫–ª—é—á–∞–µ–º –ø–ª–∞–≥–∏–Ω—ã —É—Å–ª–æ–≤–Ω–æ
      plugins: isPrevCurr ? [valueLabelsPlugin, deltaPlugin] : [valueLabelsPlugin]
    };

    var chart = new Chart(ctx, cfg);
    window.__charts[canvasId] = { chart: chart, maker: maker };
    if (canvasId === 'barAll') barAllChartRef = chart;
  };

  maker();
}

  function makeDonut(canvas, values){
  // values –æ–∂–∏–¥–∞–µ—Ç: [finished, remaining_total]
  var maker=function(){
    fitHiDPICanvas(canvas);
    var ctx=makeCtx(canvas);

    if(window.__charts[canvas.id] && window.__charts[canvas.id].chart){
      try{ window.__charts[canvas.id].chart.destroy(); }catch(e){}
    }

    const percentCenter = {
      id: 'percentCenter',
      afterDraw(chart){
        const data = (chart.data.datasets?.[0]?.data || []).map(Number);
        const finished = data[0] || 0;
        const rest     = data[1] || 0;
        const total    = Math.max(1, finished + rest);

        const donePct  = (finished / total) * 100;
        const leftPct  = (rest     / total) * 100;

        const {ctx} = chart;
        const {left, right, top, bottom} = chart.chartArea;
        const x = (left + right) / 2;
        const y = (top  + bottom) / 2;

        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const baseSize = Math.max(14, Math.min(chart.width, chart.height) * 0.18);
        ctx.fillStyle = getCSS('--ink') || getCSS('--text') || '#2a1446';
        ctx.font = `700 ${Math.round(baseSize)}px Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif`;
        ctx.fillText(`${donePct.toFixed(1)}%`, x, y - baseSize*0.03);

        ctx.fillStyle = getCSS('--muted') || '#8d77a6';
        ctx.font = `600 ${Math.round(baseSize*0.37)}px Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif`;
        ctx.fillText(`–æ—Å—Ç–∞–ª–æ—Å—å ${leftPct.toFixed(1)}%`, x, y + baseSize*0.75);
        ctx.restore();
      }
    };

    var chart=new Chart(ctx,{
      type:'doughnut',
      data:{
        labels:['–ü—Ä–æ–π–¥–µ–Ω–æ','–û—Å—Ç–∞–ª–æ—Å—å'],
        datasets:[{
          data:values,
          backgroundColor:[COLORS.finished, COLORS.remaining_total],
          borderColor:'#ffffff',
          borderWidth:2,
          spacing:3,
          hoverOffset:4
        }]
      },
      options:{
        maintainAspectRatio:false,
        animation:false,
        plugins:{
          legend:{ position:'bottom', labels:{ padding:10, boxWidth:10, boxHeight:10 } },
          tooltip:{
            callbacks:{
              label: (ct)=>{
                const ds = (ct.dataset.data||[]).map(Number);
                const total = ds.reduce((s,v)=>s+v,0) || 1;
                const val = Number(ct.raw||0);
                const pct = (val/total*100).toFixed(1);
                return `${ct.label}: ${val.toLocaleString('ru-RU')} (${pct}%)`;
              }
            }
          }
        },
        cutout:'68%'
      },
      plugins:[percentCenter]
    });

    window.__charts[canvas.id]={chart:chart, maker:maker};
  };
  return maker;
}
  /* ===== —Å–µ—Ç—å/–≤—ã–∑–æ–≤—ã API ===== */
  function b64Utf8(str){ return btoa(unescape(encodeURIComponent(str))); }
  function makeSearchValue(kind, version){
    try{
      const arr = [
        { id:'name', type:'string', value:`[${kind}]` },
        { id:'name', type:'string', value:String(version) }
      ];
      return b64Utf8(JSON.stringify(arr));
    }catch(_){ 
      return b64Utf8(JSON.stringify([{id:'name', type:'string', value:`[${kind}] –†–µ–≥—Ä–µ—Å—Å ${version}`} ]));
    }
  }  function searchB64NameContains(str){
    return btoa(unescape(encodeURIComponent(JSON.stringify([{id:'name', type:'string', value:String(str)}]))));
  }
  function getSmokeKey(){
    const val = (document.querySelector('#smokeKey')?.value || '').trim();
    return val || 'Smoke';
  }
  function getSelectiveKey(){
    const val = (document.querySelector('#selectiveKey')?.value || '').trim();
    return val || 'Selective';
  }
  async function fetchJson(url, params, headers){
    const qs=params?new URLSearchParams(params).toString():'';
    const full=qs?(url+'?'+qs):url;
    const key = cacheKey(url, params, headers);
    if(GET_CACHE.has(key)) return GET_CACHE.get(key);

    const fetchOnce = async (hdrs)=> {
      const r = await fetch(full,{headers:hdrs});
      if(!r.ok) return {status:r.status, data:await safeJson(r)};
      return {status:r.status, data:await r.json()};
    };

    let res = await fetchOnce(headers);
    if(res.status===401 && headers?.Authorization?.startsWith('Api-Token ')){
      const h2={...headers, Authorization: headers.Authorization.replace('Api-Token ','Bearer ')};
      res = await fetchOnce(h2);
    }
    if(!res || (res.status<200 || res.status>=300)) throw new Error('HTTP '+(res?.status||''));
    GET_CACHE.set(key, res.data);
    return res.data;
  }

  async function fetchPaginated(baseUrl, paramsBase, headers, {size=100, maxPages=8, window=4, logger}={}){
    const out = [];
    let active = 0, stopped = false, i = 0;

    return await new Promise((resolve, reject)=>{
      const run = ()=>{
        if (stopped) return;
        while (active < window && i < maxPages) {
          const page = i++;
          active++;
          const params = { ...paramsBase, page, size };
          fetchJson(baseUrl + '/api/launch', params, headers).then(data=>{
            const items = (data && data.content) || [];
            if (logger) logger('[launch] page=' + page + ' items=' + items.length);
            for (let k = 0; k < items.length; k++) out.push(items[k]);
            if (items.length < size) stopped = true;
          }).catch(reject).finally(()=>{
            active--;
            if ((stopped || i >= maxPages) && active === 0) resolve(out);
            else run();
          });
        }
      };
      run();
    });
  }

  async function fetchLaunches(baseUrl, projectId, version, includeSmoke, includeSelective, headers, pages, size, logger){
    const maxPages = pages==null?8:pages;
    const pageSize = size==null?100:size;

    const kinds=[];
    if(includeSmoke) kinds.push(getSmokeKey());
    if(includeSelective) kinds.push(getSelectiveKey());

    // –í—Å–µ–≥–¥–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ–º High/Blocker, —á—Ç–æ–±—ã –ø–æ—Å—Ç—Ä–∏–º–æ–≤—ã–µ —Å—Ä–µ–∑—ã
    // —Ä–∞–±–æ—Ç–∞–ª–∏ –∏ –¥–ª—è HB. –î–ª—è Smoke/Selective –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —á–µ—Ä–µ–∑
    // getSmokeKey()/getSelectiveKey().
    const kindsAll = kinds.concat(['High/Blocker']);

    const tasks = kindsAll.map(kind=>{
      const search = version ? makeSearchValue(kind,version) : undefined;
      const paramsBase = { projectId, preview:'true', sort:'createdDate,desc' };
      if (search) paramsBase.search = search;
      return fetchPaginated(baseUrl, paramsBase, headers, {size:pageSize, maxPages, window:4, logger});
    });

    const result = (await Promise.all(tasks)).flat();

    const seen=new Set(); const uniq=[];
    for(const it of result){
      if(!it || seen.has(it.id)) continue;
      seen.add(it.id); uniq.push(it);
    }
    return uniq;
  }

  function fetchStat(baseUrl, id, headers, elog){
    return fetchJson(baseUrl+'/api/launch/'+id+'/statistic', null, headers).then(function(stat){ return Array.isArray(stat)?stat:[]; })
      .catch(function(e){ if(elog) elog('[stat '+id+'] '+e.message); return []; });
  }

  async function fetchMemberStats(baseUrl, id, headers){
    return fetchJson(baseUrl+'/api/launch/'+id+'/memberstats', {size:1000,page:0}, headers).then(function(d){
      if(Array.isArray(d)) return d;
      return (d&&d.content)||[];
    }).catch(()=>[]);
  }

  async function fetchLeafCount(baseUrl, id, headers, searchFilter){
    const urlLeaf = baseUrl + '/api/testresulttree/leaf';
    const size = 2000;
    let page = 0;
    const uniq = new Set();
    while (true){
      const params = { launchId:id, treeId:14, sort:'duration,asc', size, page };
      if (searchFilter) params.search = searchFilter;
      const data = await fetchJson(urlLeaf, params, headers).catch(()=>null);
      const content = (data && data.content) || [];
      if (!content.length) break;
      for (const leaf of content){
        const uid = leaf?.uid ?? leaf?.id ?? leaf?.testCaseId ?? leaf?.entityId;
        if (uid != null) uniq.add(String(uid));
        else uniq.add('p'+page+'_'+uniq.size);
      }
      if (content.length < size) break;
      if (uniq.size > 250000) break;
      page += 1;
    }
    return uniq.size;
  }

  async function fetchLeafItems(baseUrl, id, headers){
    const urlLeaf = baseUrl + '/api/testresulttree/leaf';
    const size = 1000;
    let page = 0;
    let out = [];
    while (true){
      const params = { launchId:id, sort:'name,asc', size, page };
      const data = await fetchJson(urlLeaf, params, headers).catch(()=>null);
      const content = (data && data.content) || [];
      if (!content.length) break;
      out = out.concat(content);
      if (content.length < size) break;
      page += 1;
    }
    return out;
  }

  function parseUwUNumber(raw){
    if (raw == null) return 0;
    const s = String(raw).trim();
    if (!s || s === '0') return 0;
    const num = parseFloat(s.replace(',', '.'));
    return Number.isFinite(num) ? num : 0;
  }

  async function getUwUInfo(baseUrl, tcid, headers){
    if (UWU_CACHE.has(tcid)) return UWU_CACHE.get(tcid);
    let uwuNum = 0;
    let platformVal = null;
    try{
      const data = await fetchJson(baseUrl + '/api/testcase/' + tcid + '/overview', null, headers);
      const fields = (data && data.customFields) || [];
      for (let i = 0; i < fields.length; i++){
        const cf = fields[i] || {};
        const cfInfo = cf.customField || {};
        const cfName = String(cfInfo.name || '').trim();

        if (cfName === 'UwU') {
          let v = cf.name;
          if (!v) {
            const vals = cf.values || [];
            if (vals.length && vals[0]) v = vals[0].name;
          }
          uwuNum = parseUwUNumber(v);
        } else if (cfName === 'Platform') {
          let p = cf.name;
          if (!p) {
            const vals = cf.values || [];
            if (vals.length && vals[0]) p = vals[0].name;
          }
          if (p) platformVal = String(p);
        }
      }
    }catch(e){
      uwuNum = 0;
      platformVal = null;
    }
    const result = { uwuNum, platform: platformVal };
    UWU_CACHE.set(tcid, result);
    return result;
  }

  function getUwuStatsFromAgg(uwuAgg, label){
    const a = (uwuAgg && uwuAgg[label]) || {};
    let sumDone = null;
    let sumLeft = null;
    let sumTotal = null;

    if (a.uwu && typeof a.uwu === 'object'){
      sumDone = a.uwu.sumDone ?? a.uwu.done ?? a.uwu.sum_done;
      sumLeft = a.uwu.sumLeft ?? a.uwu.left ?? a.uwu.sum_left;
      sumTotal = a.uwu.sum ?? a.uwu.uwuSum ?? a.uwu.totalUwu;
    } else {
      sumDone = a.sum_done ?? a.sumDone ?? a.done;
      sumLeft = a.sum_left ?? a.sumLeft ?? a.left;
      sumTotal = a.sum ?? a.uwu_sum ?? a.uwuSum;
    }

    if (sumDone == null && sumLeft == null && sumTotal == null) return null;
    const done = Number(sumDone) || 0;
    const left = Number(sumLeft) || 0;
    const total = sumTotal == null ? (done + left) : Number(sumTotal) || (done + left);
    return { done, left, total };
  }

  function makeUwuDonut(canvasId, doneSum, leftSum){
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const maker = function(){
      fitHiDPICanvas(canvas);
      const ctx = makeCtx(canvas);
      if (window.__charts[canvasId]?.chart){
        try{ window.__charts[canvasId].chart.destroy(); }catch(e){}
      }

      const done = Math.max(0, Number(doneSum) || 0);
      const left = Math.max(0, Number(leftSum) || 0);
      const total = Math.max(0, done + left);
      const data = total > 0 ? [done, left] : [0, 1];
      const donePct = total > 0 ? (done / total * 100) : 0;
      const leftPct = total > 0 ? (left / total * 100) : 0;

      const centerPlugin = {
        id: 'uwuCenterPct',
        afterDraw(ch){
          const {ctx, chartArea:{left,right,top,bottom}} = ch;
          const x = (left + right) / 2;
          const y = (top + bottom) / 2;
          ctx.save();
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          const baseSize = Math.max(14, Math.min(ch.width, ch.height) * 0.18);
          ctx.fillStyle = getCSS('--ink') || getCSS('--text') || '#2a1446';
          ctx.font = '700 ' + Math.round(baseSize) + 'px ' + Chart.defaults.font.family;
          ctx.fillText(donePct.toFixed(1) + '%', x, y - baseSize*0.03);
          ctx.fillStyle = getCSS('--muted') || '#8d77a6';
          ctx.font = '600 ' + Math.round(baseSize*0.37) + 'px ' + Chart.defaults.font.family;
          ctx.fillText('–æ—Å—Ç–∞–ª–æ—Å—å ' + leftPct.toFixed(1) + '%', x, y + baseSize*0.75);
          ctx.restore();
        }
      };

      const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['–ü—Ä–æ–π–¥–µ–Ω–æ','–û—Å—Ç–∞–ª–æ—Å—å'],
          datasets: [{
            data,
            backgroundColor: [COLORS.finished, hexA(COLORS.remaining_total, .6)],
            borderColor:'#fff',
            borderWidth:2,
            spacing:3
          }]
        },
        options: {
          maintainAspectRatio:false,
          animation:false,
          cutout:'70%',
          plugins:{
            legend:{ position:'bottom', labels:{ padding:10, boxWidth:10, boxHeight:10 } },
            tooltip:{
              callbacks:{
                label: (ct)=>{
                  const ds = (ct.dataset.data||[]).map(Number);
                  const total = ds.reduce((s,v)=>s+v,0) || 1;
                  const val = Number(ct.raw||0);
                  const pct = (val/total*100).toFixed(1);
                  return `${ct.label}: ${val.toLocaleString('ru-RU')} (${pct}%)`;
                }
              }
            }
          }
        },
        plugins:[centerPlugin]
      });
      window.__charts[canvasId] = { chart, maker };
    };
    maker();
  }

  /* ===== –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ/–ø–æ–¥—Å—á—ë—Ç—ã ===== */
  function normalizeStatus(raw){
    if (raw == null) return 'in_progress';
    const s = String(raw).toLowerCase();
    if (s === 'passed' || s === 'failed' || s === 'broken' || s === 'skipped') return s;
    return 'in_progress';
  }
  const COMPLETED = new Set(['passed','failed','broken','skipped']);
  const NON_COMPLETED = new Set(['in_progress']);

  function sumByStatuses(list, allowedSet){
    let sum = 0;
    (list || []).forEach(s => {
      const st = normalizeStatus(s && s.status);
      if (allowedSet.has(st)) sum += Number(s.count || 0);
    });
    return sum;
  }

  function computeCountsExact(statList){
    const finished   = sumByStatuses(statList, COMPLETED);
    const unfinished = sumByStatuses(statList, NON_COMPLETED);
    const total      = finished + unfinished;
    const remaining_total = unfinished;
    return {
      total,
      finished,
      remaining_total,
      in_progress: unfinished,
      remaining: 0
    };
  }

  function assignedUnfinishedFromMemberStats(mstats){
    let assigned=0;
    (mstats||[]).forEach(m=>{
      assigned += sumByStatuses(m.statistic, NON_COMPLETED);
    });
    return assigned;
  }

  function setLogProgress(state){
    var cap = $('#logProgressCaption');
    var bar = $('#logProgressBar');
    var loaded = Number(state.loaded||0), total = Number(state.total||0);
    var step = Number(state.step||0), steps = Number(state.steps||0);
    if(cap) cap.textContent = '–ó–∞–ø—É—Å–∫–æ–≤: '+loaded+' –∏–∑ '+(total||loaded)+' ‚Ä¢ –®–∞–≥–∏: '+step+' / '+(steps||step);
    if(bar){
      var p = total>0 ? Math.min(100, Math.round(loaded/Math.max(1,total)*100)) : (steps>0? Math.min(100, Math.round(step/Math.max(1,steps)*100)) : 0);
      bar.style.width = p + '%';
    }
  }

  async function aggregateByGroups(launches, baseUrl, headers, logger, elog){
    var agg={};
    for(var oi=0;oi<ORDER.length;oi++){
      agg[ORDER[oi]]={total:0,finished:0,remaining_total:0,remaining:0,in_progress:0};
    }

    var perLaunchFinished = {}, perLaunchTotal = {};
    const totalSteps = launches.length;
    let doneSteps = 0;

    await pMap(launches, async (it)=>{
      try{
        const [stat, mstats] = await Promise.all([
          fetchStat(baseUrl, it.id, headers, elog),
          fetchMemberStats(baseUrl, it.id, headers)
        ]);
        const c = computeCountsExact(stat);

        const assignedUnf = assignedUnfinishedFromMemberStats(mstats);
        const unfinishedAll = Math.max(0, c.remaining_total);
        const unassigned = Math.max(0, unfinishedAll - assignedUnf);

        perLaunchFinished[it.id]=c.finished||0;
        perLaunchTotal[it.id]=c.total||0;

        for(var gi=0;gi<ORDER.length;gi++){
          var key=ORDER[gi]; var first=key.split(']')[0]+']'; var second=key.split('][')[1];
          var nm = it.name||'';
          if(nm.indexOf(first)!==-1 && nm.indexOf(second)!==-1){
            agg[key].total           += c.total;
            agg[key].finished        += c.finished;
            agg[key].remaining_total += unfinishedAll;
            agg[key].remaining       += assignedUnf;
            agg[key].in_progress     += unassigned;
            break;
          }
        }
      }catch(e){ if(elog) elog('[aggregate '+it.id+'] '+(e.message||e)); }
      doneSteps++;
      if(doneSteps%2===0) setLogProgress({ step: doneSteps, steps: totalSteps, loaded: doneSteps, total: totalSteps });
    }, {concurrency: 10});

    setLogProgress({ step: totalSteps, steps: totalSteps, loaded: totalSteps, total: totalSteps });
    return {agg, perLaunchFinished, perLaunchTotal};
  }

  function normalizePlatformName(p){
    const s = String(p || '').toLowerCase();
    if (!s) return null;
    if (s.includes('android')) return 'Android';
    if (s.includes('ios')) return 'iOS';
    return null;
  }

  function extractKindFromLaunchName(name){
    const s = String(name || '');
    if (/\[Smoke\]/i.test(s)) return 'Smoke';
    if (/\[Selective\]/i.test(s)) return 'Selective';
    if (/\[High\/Blocker\]/i.test(s)) return 'High/Blocker';
    return null;
  }

  const STREAM_CONCURRENCY = 20;
  async function buildUwUAgg(launches, baseUrl, headers, logger, elog){
    var uwuAgg = {};
    for(var oi=0;oi<ORDER.length;oi++){
      uwuAgg[ORDER[oi]] = { sum:0, sum_done:0, sum_left:0 };
    }

    const totalSteps = launches.length;
    let doneSteps = 0;

    await pMap(launches, async (it)=>{
      try{
        const kind = extractKindFromLaunchName(it.name || '');
        const launchPlatform = normalizePlatformName(it.name || '');
        if (!kind || kind === 'Selective') return;
        if (!launchPlatform) return;
        const leafItems = await fetchLeafItems(baseUrl, it.id, headers);

        await pMap(leafItems, async (leaf)=>{
          const tcid = Number(leaf?.testCaseId);
          if (!Number.isFinite(tcid)) return;
          const info = await getUwUInfo(baseUrl, tcid, headers);
          const platform = launchPlatform;
          const key = `[${platform}][${kind}]`;
          if (!uwuAgg[key]) return;
          const uwuNum = Number(info.uwuNum || 0);
          const st = normalizeStatus(leaf && leaf.status);
          uwuAgg[key].sum += uwuNum;
          if (COMPLETED.has(st)) uwuAgg[key].sum_done += uwuNum;
          else uwuAgg[key].sum_left += uwuNum;
        }, {concurrency: STREAM_CONCURRENCY});
      }catch(e){ if(elog) elog('[uwu '+it.id+'] '+(e.message||e)); }

      doneSteps++;
      if(logger && doneSteps%2===0) logger('[uwu] launches '+doneSteps+' / '+totalSteps);
    }, {concurrency: 4});

    return uwuAgg;
  }

  function renderAgg(agg, cardsId, barId, summaryEl, uwuAgg){
    var container=document.getElementById(cardsId);
    container.innerHTML='';
    var grand=0;
    for(var oi=0;oi<ORDER.length;oi++){
      var label=ORDER[oi];
      if (label.indexOf('[Smoke]') !== -1) continue;
      var a=agg[label]||{total:0,finished:0,remaining_total:0,remaining:0,in_progress:0};
      grand+=a.total;
      var canId='dn_'+cardsId+'_'+oi;
      var uwuCanId='uwu_'+cardsId+'_'+oi;
      var uwuMetaId='uwu_meta_'+cardsId+'_'+oi;
      var uwuDoneId='uwu_done_'+cardsId+'_'+oi;
      var uwuLeftId='uwu_left_'+cardsId+'_'+oi;
      var isSelective = label.indexOf('[Selective]') !== -1;
      var regCard=document.createElement('div');
      regCard.className='card';
      regCard.innerHTML=
        '<div class="head"><div>'+label+'</div><div class="export"><div class="nums">–í—Å–µ–≥–æ: <b>'+(a.total||0).toLocaleString('ru-RU')+'</b></div></div></div>'+
        '<div class="chart-wrap"><canvas id="'+canId+'" class="chart"></canvas></div>'+
        '<div class="kpis">'+
          '<div class="kpi"><span class="label">–ü—Ä–æ–π–¥–µ–Ω–æ</span><span class="val">'+(a.finished||0).toLocaleString('ru-RU')+'</span></div>'+
          '<div class="kpi"><span class="label">–û—Å—Ç–∞–ª–æ—Å—å</span><span class="val">'+(a.remaining_total||0).toLocaleString('ru-RU')+'</span></div>'+
        '</div>';
      container.appendChild(regCard);

      if (!isSelective){
        var uwuCard=document.createElement('div');
        uwuCard.className='card';
        uwuCard.innerHTML=
          '<div class="head"><div id="'+uwuMetaId+'">'+label+' UwU: ‚Äî</div></div>'+
          '<div class="chart-wrap"><canvas id="'+uwuCanId+'" class="chart"></canvas></div>'+
          '<div class="kpis">'+
            '<div class="kpi"><span class="label">–ü—Ä–æ–π–¥–µ–Ω–æ</span><span class="val" id="'+uwuDoneId+'">‚Äî</span></div>'+
            '<div class="kpi"><span class="label">–û—Å—Ç–∞–ª–æ—Å—å</span><span class="val" id="'+uwuLeftId+'">‚Äî</span></div>'+
          '</div>';
        container.appendChild(uwuCard);
      }
(function(canId,a){
  // –ø–µ—Ä–µ–¥–∞—ë–º —Ç–æ–ª—å–∫–æ 2 —á–∏—Å–ª–∞: –ø—Ä–æ–π–¥–µ–Ω–æ –∏ –æ—Å—Ç–∞–ª–æ—Å—å
  var maker=makeDonut(document.getElementById(canId), [a.finished, a.remaining_total]);
  requestAnimationFrame(function(){ maker(); });
})(canId, a);
      (function(uwuCanId, uwuMetaId, uwuDoneId, uwuLeftId, label, regStats){
        if (label.indexOf('[Selective]') !== -1) return;
        var metaEl = document.getElementById(uwuMetaId);
        var doneEl = document.getElementById(uwuDoneId);
        var leftEl = document.getElementById(uwuLeftId);
        var uwuStats = getUwuStatsFromAgg(uwuAgg, label);
        var sum = Number(uwuStats && uwuStats.total || 0);
        var done = Number(uwuStats && uwuStats.done || 0);
        var left = Number(uwuStats && uwuStats.left || 0);
        if (metaEl) metaEl.textContent = label + ' UwU: ' + (sum ? sum.toLocaleString('ru-RU') : '0');
        if (doneEl) doneEl.textContent = done.toLocaleString('ru-RU');
        if (leftEl) leftEl.textContent = left.toLocaleString('ru-RU');
        makeUwuDonut(uwuCanId, done, left);
      })(uwuCanId, uwuMetaId, uwuDoneId, uwuLeftId, label, a);
    }
    if(summaryEl) summaryEl.textContent='–í—Å–µ–≥–æ –≥—Ä—É–ø–ø: '+ORDER.length+', –≤—Å–µ–≥–æ –∫–µ–π—Å–æ–≤: '+grand.toLocaleString('ru-RU');


// === build datasets with FILTERS applied ===
  // Inline checker independent from later helpers
  function __allowLabel(label){
    label = String(label||'');
    var isIOS     = label.indexOf('[iOS]')===0;
    var isAndroid = label.indexOf('[Android]')===0;
    var isSmoke   = label.indexOf('[Smoke]')!==-1;
    var isSel     = label.indexOf('[Selective]')!==-1;
    var isHB      = label.indexOf('[High/Blocker]')!==-1;

    var on = function(id){ var el=document.getElementById(id); return !el || !!el.checked; };
    if (isIOS && !on('fltPlatIOS')) return false;
    if (isAndroid && !on('fltPlatAndroid')) return false;
    if (isSmoke && !on('fltTypeSmoke')) return false;
    if (isSel   && !on('fltTypeSelective')) return false;
    if (isHB    && !on('fltTypeHB')) return false;

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É —Å—Ä–µ–∑–æ–≤ (Smoke/Selective/High/Blocker)
    if (!allowByKind(label)) return false;

    // –µ—Å–ª–∏ –ª–µ–π–±–ª –Ω–µ –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∏ –ø–æ–¥ –æ–¥–∏–Ω —Ñ–∏–ª—å—Ç—Ä, –æ—Å—Ç–∞–≤–ª—è–µ–º
    return true;
  }
  var __ORDER_USED = ORDER.filter(__allowLabel);

  var ds = ['total','finished','remaining_total'].map(function(k){
    return {
      key: k,
      label: ({ total:'–í—Å–µ–≥–æ', finished:'–ü—Ä–æ–π–¥–µ–Ω–æ', remaining_total:'–û—Å—Ç–∞–ª–æ—Å—å' })[k],
      data: __ORDER_USED.map(function(l){ return (agg[l] && agg[l][k]) || 0; })
    };
  });

  // Update summary (visible only)
  try{
    var totalCasesVisible = 0;
    for (var i=0;i<__ORDER_USED.length;i++){
      var a = agg[__ORDER_USED[i]] || {};
      totalCasesVisible += Number(a.total||0) || 0;
    }
    var sumEl = document.getElementById('summaryInfo');
    if (sumEl) sumEl.textContent = '–í—Å–µ–≥–æ –≥—Ä—É–ø–ø: ' + __ORDER_USED.length + ', –≤—Å–µ–≥–æ –∫–µ–π—Å–æ–≤: ' + (totalCasesVisible.toLocaleString ? totalCasesVisible.toLocaleString('ru-RU') : totalCasesVisible);
  }catch(e){}
  if(barId) makeBarChart(barId, __ORDER_USED, ds);

  }

  /* ===== –•—Ä–∞–Ω–∏–ª–∏—â–µ ===== */
  var STORE_DEFAULT={ snaps:[], streamSnaps:[], lastPerLaunch:{} };
  function getStore(){ try{ return JSON.parse(localStorage.getItem('allure-regress-store-v1')) || JSON.parse(JSON.stringify(STORE_DEFAULT)); }catch(e){ return JSON.parse(JSON.stringify(STORE_DEFAULT)); } }
  function setLocalStore(s){ localStorage.setItem('allure-regress-store-v1', JSON.stringify(s)); }
  let storeFromFile=null, dataFileHandle=null;
  function setStore(newStore){
    storeFromFile = JSON.parse(JSON.stringify({ ...STORE_DEFAULT, ...(newStore||{}) }));
    setLocalStore(storeFromFile);
    var saveBtn = $('#dataSave'); if(saveBtn) saveBtn.disabled = !dataFileHandle;
  }
  async function saveStoreMaybe(){
    if(!dataFileHandle || !storeFromFile) return;
    try{
      const writable = await dataFileHandle.createWritable();
      await writable.write(JSON.stringify(storeFromFile, null, 2));
      await writable.close();
      toast('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª');
    }catch(e){ toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: '+(e.message||e)); }
  }
  async function pickDataFile(){
    if(!window.showOpenFilePicker){ toast('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ò–º–ø–æ—Ä—Ç JSON.'); return; }
    try{
      const [handle] = await window.showOpenFilePicker({ multiple:false, types:[{ description:'JSON', accept:{'application/json':['.json']} }] });
      dataFileHandle = handle;
      const file = await handle.getFile();
      const text = await file.text(); const obj = JSON.parse(text||'{}');
      setStore({ ...STORE_DEFAULT, ...obj }); renderSnapList(); renderStreamSnapList(); toast('–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á—ë–Ω');
    }catch(e){ if(e?.name!=='AbortError') toast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: '+(e.message||e)); }
  }
  async function createDataFile(){
    if(!window.showSaveFilePicker){ toast('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≠–∫—Å–ø–æ—Ä—Ç JSON.'); return; }
    try{
      const handle = await window.showSaveFilePicker({ suggestedName:'regress-data.json', types:[{ description:'JSON', accept:{'application/json':['.json']} }] });
      dataFileHandle = handle;
      setStore(getStore()); await saveStoreMaybe();
      toast('–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω –∏ –ø–æ–¥–∫–ª—é—á—ë–Ω');
    }catch(e){ if(e?.name!=='AbortError') toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: '+(e.message||e)); }
  }

  function exportSnapsCSV(){
    var st=getStore(); var snaps=st.snaps||[];
    var rows=[['snap_id','ts_iso','title','group','total','finished','remaining_total','remaining','in_progress']];
    snaps.forEach(function(s){
      ORDER.forEach(function(g){
        var o=(s.data||{})[g]||{total:0,finished:0,remaining_total:0,remaining:0,in_progress:0};
        rows.push([s.id, new Date(s.ts).toISOString(), s.title, g, o.total, o.finished, o.remaining_total, o.remaining, o.in_progress]);
      });
    });
    var csv = rows.map(r => r.map(v=>{
      var x=(v==null?'':String(v));
      if(/[",\n]/.test(x)) x='"'+x.replace(/"/g,'""')+'"';
      return x;
    }).join(',')).join('\n');
    var blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='regress-data.csv'; a.click(); URL.revokeObjectURL(url);
  }

  /* ===== –î–∞—à–±–æ—Ä–¥: –∫–Ω–æ–ø–∫–∏/—Ä–µ–Ω–¥–µ—Ä (–û–±—â–∏–µ) ===== */
  function renderSnapList(){
    var box=$('#snapListDash'); if(!box) return; box.innerHTML='';
    var store=getStore(); var list=store.snaps||[];
    for(var i=list.length-1;i>=0;i--){
      var s=list[i];
      var totalFinished = ORDER.reduce(function(sum,k){ return sum + (((s.data||{})[k]||{}).finished||0);}, 0);
      var row=document.createElement('div');
      row.className='snap';
      row.innerHTML='<input type="checkbox" data-id="'+s.id+'" />'+
        '<label style="flex:1;display:flex;flex-direction:column;gap:2px;min-width:0">'+
        '<span class="title">'+s.title+'</span>'+
        '<span class="meta">'+(new Date(s.ts)).toLocaleString()+' ‚Ä¢ –≤—Å–µ–≥–æ –ø—Ä–æ–π–¥–µ–Ω–æ: '+totalFinished.toLocaleString('ru-RU')+'</span></label>'+
        '<button class="del" data-id="'+s.id+'">–£–¥–∞–ª–∏—Ç—å</button>';
      box.appendChild(row);
    }
    var dels=box.querySelectorAll('.del');
    for(var d=0;d<dels.length;d++){
      dels[d].addEventListener('click', function(){
        var id=this.getAttribute('data-id'); var st=getStore();
        st.snaps=(st.snaps||[]).filter(function(x){return x.id!==id});
        setStore(st); renderSnapList();
      });
    }
    $('#dashSnapSave')?.addEventListener('click', function(){
      if(!window.lastAgg){ toast('–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏—Ç–µ –¥–∞—à–±–æ—Ä–¥'); return; }
      takeSnapshot({ version:($('#version')?.value.trim())||'', timeISO:(new Date()).toISOString(), data: window.lastAgg });
    });
    $('#dashSnapClear')?.addEventListener('click', function(){
      var st=getStore(); st.snaps=[]; setStore(st); renderSnapList(); toast('–°—Ä–µ–∑—ã —É–¥–∞–ª–µ–Ω—ã');
    });
    $('#dashSnapBuild')?.addEventListener('click', ()=>buildDashMultiCompare({silent:false}));
  }

  // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï: –∫—Ä–∞—Å–∏–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –ª–µ–≥–µ–Ω–¥—ã/—Å—Ä–µ–∑–æ–≤ ===
function prettySnapTitle(raw){
  // –ë—ã–ª–æ: "[Smoke] –ö–æ—Ä–∑–∏–Ω–∞... v=7.2.9 2025-09-02T12:44:33Z"
  // –°—Ç–∞–Ω–µ—Ç: "[Smoke] –ö–æ—Ä–∑–∏–Ω–∞... v=7.2.9 2025-09-02 12:44"
  const s = String(raw||'');
  const m = s.match(/(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2})/);
  const neat = m ? s.replace(/T\d{2}:\d{2}:\d{2}.*Z?/,' '+m[2]) : s;
  return neat.replace('Z','').trim();
}

function makeSnapTitle(o){
  var ver = o.version || 'all';

  // —Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫–æ–π —Ç–∏–ø –≤—ã–±—Ä–∞–Ω –≤ —Ñ–∏–ª—å—Ç—Ä–µ "–¢–∏–ø" –≤ –±–ª–æ–∫–µ "–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ä–µ–∑—ã"
  var sel = document.getElementById('dashKind');
  var v   = sel ? sel.value : 'all';

  var kindLabel;
  if (v === 'hb_only') {
    // —Å—Ä–µ–∑ —Ç–æ–ª—å–∫–æ –ø–æ High/Blocker
    kindLabel = 'High/Blocker';
  } else if (v === 'sm_sel') {
    // –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π Smoke + Selective
    kindLabel = 'Smoke+Selective';
  } else {
    // –≤—Å–µ —Ç–∏–ø—ã —Å—Ä–∞–∑—É (Smoke, Selective, High/Blocker)
    kindLabel = 'Smoke+Selective+HB';
  }

  return `[${kindLabel}] v=${ver} ${o.timeISO}`;
}
  function takeSnapshot(ctx){
    var st=getStore();
    var id=String(Date.now())+Math.random().toString(16).slice(2);
    var snap={ id:id, ts:Date.now(), title:makeSnapTitle(ctx), data:ctx.data };
    st.snaps=(st.snaps||[]); st.snaps.push(snap);
    setStore(st); renderSnapList(); saveStoreMaybe(); toast('–°—Ä–µ–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  }

  function buildDashMultiCompare(opts){
    const silent = !!(opts && opts.silent);

    var metric=$('#dashMetric')?.value || 'finished';
    var labels = ORDER.filter(function(label){ return allowByKind(label); });
    if (!labels.length) labels = ORDER.slice();
    var chosen=[].slice.call(document.querySelectorAll('#snapListDash input[type=checkbox]:checked'))
                 .map(cb=>cb.getAttribute('data-id'));

    var snaps=(getStore().snaps||[]).filter(s=> chosen.indexOf(s.id)!==-1);

    if(!snaps.length){
      if(!silent) toast('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–µ–∑—ã');
      return;
    }

    // —Å–æ–±—Ä–∞—Ç—å –Ω–∞–±–æ—Ä—ã
    const palette = [
      '#7a3af9','#00c48c','#ffb020','#ff5aad','#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#14b8a6'
    ];
    const datasets = snaps.map((s, i)=>{
      const col = palette[i % palette.length];
      return {
        key: metric,
        label: prettySnapTitle(s.title || ('–°—Ä–µ–∑ '+(i+1))),
        data: labels.map(k => ((s.data||{})[k]||{})[metric] || 0),
        backgroundColor: hexA(col,.85),
        borderColor: col
      };
    });

    var wrap = document.getElementById('dashMultiBar')?.parentElement;
    if(wrap){
      var extra = Math.max(0, datasets.length - 6);
      wrap.style.height = Math.min(900, 320 + extra*24) + 'px';
    }

    makeBarChart('dashMultiBar', labels, datasets);
  }

  function renderDashPrevCurrent(currentAgg, metric){
    metric=metric||'finished'; var color=COLORS[metric]||COLORS.finished;
    var labels = ORDER.filter(function(label){ return allowByKind(label); });
    if (!labels.length) labels = ORDER.slice();
    var list=(getStore().snaps||[]); var prev=list.length>0?list[list.length-1]:null;
    var currData=labels.map(function(k){ return (currentAgg[k]&&currentAgg[k][metric])||0; });
    var prevData=labels.map(function(k){ return (prev&&prev.data&&prev.data[k]&&prev.data[k][metric])?prev.data[k][metric]:0; });
    var deltas = currData.map(function(v,i){ return v - (prevData[i]||0); });

    var box=$('#dashDelta');
    if(box){
      box.innerHTML='';
      for(var i=0;i<labels.length;i++){
        var d=deltas[i]; var sign=d>0?'+':'';
        var item=document.createElement('div'); item.className='kpi';
        item.innerHTML='<span class="label">'+labels[i]+' ‚Äî Œî</span><span class="val">'+sign+d.toLocaleString('ru-RU')+'</span>';
        box.appendChild(item);
      }
    }

    var dsPrev = {key:metric, label:'–ü—Ä–µ–¥—ã–¥—É—â–∏–π', data:prevData, backgroundColor:hexA(color,.35), borderColor:color};
    var dsCurr = {key:metric, label:'–¢–µ–∫—É—â–∏–π',   data:currData, backgroundColor:hexA(color,.85), borderColor:color};
    dsCurr.__delta = deltas;

    makeBarChart('dashPrevCurr', labels, [dsPrev, dsCurr]);
  }

  /* ===== Readiness (Android + iOS) ===== */
  async function fetchReadinessLaunch(baseUrl, projectId, headers, platform, version){
    const nameCore = `[ALL][${platform}] –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ–ª–∏–∑—É`;
    const tryWith  = searchB64NameContains(`${nameCore} ${version}`);
    const tryPlain = searchB64NameContains(nameCore);

    async function findOne(searchB64){
      const list = await fetchPaginated(
        baseUrl,
        { projectId, preview:'true', sort:'createdDate,desc', search: searchB64 },
        headers,
        { size:100, maxPages:6, window:3 }
      );
      return (list && list[0]) || null;
    }

    let launch = version ? (await findOne(tryWith)) : null;
    if(!launch) launch = await findOne(tryPlain);
    return launch;
  }

  async function buildReleaseSection(baseUrl, projectId, version, headers){
    const headVer = document.getElementById('releaseHeadVer');
    if(headVer) headVer.textContent = '–í–µ—Ä—Å–∏—è: ' + (version || '‚Äî');

    const row = document.getElementById('releaseRow');
    if(!row) return;
    row.innerHTML = '<div class="nums">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';

    const [andL, iosL] = await Promise.all([
      fetchReadinessLaunch(baseUrl, projectId, headers, 'Android', version),
      fetchReadinessLaunch(baseUrl, projectId, headers, 'iOS',      version)
    ]);

    async function oneCard(L){
      if(!L) return {
        html: '<div class="release-card"><div class="release-title"><span>‚Äî</span><span class="nums">–Ω–µ—Ç –ª–∞—É–Ω—á–∞</span></div></div>'
      };
      const stat = await fetchStat(baseUrl, L.id, headers);
      const c = computeCountsExact(stat);
      const total = Number(c.total||0);
      const finished = Number(c.finished||0);
      const pct = total>0 ? Math.round(finished*100/total) : 0;

      const link = `${baseUrl}/launch/${L.id}`;
      const safeName = escapeHtml(L.name||'[launch]');

      const html =
        `<div class="release-card">
          <div class="release-title">
            <span>${safeName}</span>
            <span class="nums">#${L.id}</span>
          </div>
          <div class="release-sub">
            <div class="release-chip">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å (–ø—Ä–æ–π–¥–µ–Ω–æ)</div>
            <div class="release-chip"><strong>${pct}%</strong></div>
            <div class="release-chip">–í—Å–µ–≥–æ / –ü—Ä–æ–π–¥–µ–Ω–æ&nbsp;<strong>${total.toLocaleString('ru-RU')} / ${finished.toLocaleString('ru-RU')}</strong></div>
          </div>
          <div class="release-bar"><div style="width:${pct}%"></div></div>
          <a class="release-link" href="${link}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å launch</a>
        </div>`;
      return {html};
    }

    const [andCard, iosCard] = await Promise.all([oneCard(andL), oneCard(iosL)]);
    row.innerHTML = (andCard.html || '') + (iosCard.html || '');
  }

  /* ===== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª–∏ –¥–ª—è –º–∏–Ω–∏-–¥–∏–∞–≥—Ä–∞–º–º ===== */
  function deptOf(name){
    var low=(name||'').toLowerCase();
    if(low.indexOf('–∫–æ—Ä–∑–∏–Ω')!==-1) return '–ö–æ—Ä–∑–∏–Ω–∞';
    if(low.indexOf('—Ñ–∏–Ω—Ç–µ—Ö')!==-1 || low.indexOf('wbpay')!==-1 || low.indexOf('–∫–æ—à–µ–ª–µ–∫')!==-1 || low.indexOf('–∫–æ—à–µ–ª—å–∫–∞')!==-1) return '–§–∏–Ω—Ç–µ—Ö';
    if(low.indexOf('—á–∞—Ç')!==-1) return '–ß–∞—Ç—ã';
    if(low.indexOf('bx')!==-1 || low.indexOf('–≤—Ö')!==-1) return '–í–•';
    return '–û—Å—Ç–∞–ª—å–Ω—ã–µ';
  }
  function platformOf(name){
    var s=(name||'').toLowerCase();
    if(s.includes('[android]')) return 'android';
    if(s.includes('[ios]')) return 'ios';
    return 'other';
  }

  /* ===== –º–∏–Ω–∏-–¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ –ª–∞—É–Ω—á–∞–º (—Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã) ===== */
  function buildMiniLaunchCharts(launches, perLaunchFinished, perLaunchTotal, opts){
    const grid = $('#miniGrid');
    const info = $('#miniInfo');
    if(!grid || !info){ return; }

    const MAX_HARD = 120;
    const {count, sortKey, sortDir, dept, platform} = opts || MINI_DEFAULTS;

    grid.innerHTML = '';
    if(!Array.isArray(launches) || !launches.length){
      info.textContent = '–õ–∞—É–Ω—á–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
      return;
    }

    const items = launches.map(L=>{
      const total    = Number(perLaunchTotal[L.id]   ?? 0);
      const finished = Number(perLaunchFinished[L.id]?? 0);
      const pct      = total>0 ? (finished*100/total) : 0;
      const depName  = deptOf(L.name||'');
      const plt      = platformOf(L.name||'');
      const created  = Number(L.createdDate || L.startTime || 0);
      return { L, total, finished, pct, dept: depName, platform: plt, created };
    });

    let filtered = items;
    if(dept && dept!=='all') filtered = filtered.filter(x=>x.dept===dept);
    if(platform && platform!=='all') filtered = filtered.filter(x=>x.platform===platform);

    const dir = (sortDir==='asc') ? 1 : -1;
    filtered.sort((a,b)=>{
      if(sortKey==='total')    return dir*(a.total - b.total);
      if(sortKey==='finished') return dir*(a.finished - b.finished);
      if(sortKey==='created')  return dir*(a.created - b.created);
      return dir*(a.pct - b.pct);
    });

    const slice = filtered.slice(0, Math.min(MAX_HARD, count));

    slice.forEach((it, idx)=>{
      const {L, total, finished, pct} = it;
      const card = document.createElement('div');
      card.className = 'mini-card';
      const canId = 'mini_can_' + L.id + '_' + idx;

      card.innerHTML =
        `<div class="mini-title" title="${escapeHtml(L.name||'')}">
            <a href="${CURRENT_BASE_URL}/launch/${L.id}" target="_blank" rel="noopener">
              ${escapeHtml(L.name||'')}
            </a>
         </div>
         <div class="mini-fig"><canvas id="${canId}"></canvas></div>
         <div class="mini-remaining">–ü—Ä–æ–π–¥–µ–Ω–æ: ${finished.toLocaleString('ru-RU')} / ${total.toLocaleString('ru-RU')}</div>`;

      grid.appendChild(card);

      const canvas = document.getElementById(canId);
      const maker = () => {
        fitHiDPICanvas(canvas);
        if(window.__charts[canId]?.chart){ try{ window.__charts[canId].chart.destroy(); }catch(e){} }
        const ctx = makeCtx(canvas);
        const chart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['–ü—Ä–æ–π–¥–µ–Ω–æ','–û—Å—Ç–∞–ª–æ—Å—å'],
            datasets: [{
              data: [finished, Math.max(0, total - finished)],
              backgroundColor: [COLORS.finished, hexA(COLORS.remaining_total, .6)],
              borderColor:'#fff', borderWidth:2, spacing:2
            }]
          },
          options: {
            maintainAspectRatio:false,
            animation:false,
            cutout:'70%',
            plugins:{ legend:{display:false} }
          },
          plugins:[{
            id:'centerPct2',
            afterDraw(ch){
              const {ctx, chartArea:{left,right,top,bottom}} = ch;
              const x=(left+right)/2, y=(top+bottom)/2;
              ctx.save();
              ctx.textAlign='center'; ctx.textBaseline='middle';
              ctx.fillStyle=getCSS('--ink');
              ctx.font='700 14px ' + Chart.defaults.font.family;
              ctx.fillText(Math.round(pct) + '%', x, y);
              ctx.restore();
            }
          }]
        });
        window.__charts[canId] = { chart, maker };
      };
      maker();
    });

    info.textContent =
      `–ü–æ–∫–∞–∑–∞–Ω–æ: ${slice.length} –∏–∑ ${filtered.length} (–≤—Å–µ–≥–æ ${launches.length}) ‚Ä¢ `
      + `—Å–æ—Ä—Ç: ${({'pct':'% –ø—Ä–æ–π–¥–µ–Ω–æ','finished':'–ø—Ä–æ–π–¥–µ–Ω–æ','total':'–≤—Å–µ–≥–æ','created':'—Å–≤–µ–∂–µ—Å—Ç—å'})[sortKey]} ${sortDir.toUpperCase()}`
      + (dept && dept!=='all' ? ` ‚Ä¢ –æ—Ç–¥–µ–ª: ${dept}` : '')
      + (platform && platform!=='all' ? ` ‚Ä¢ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${platform.toUpperCase()}` : '');
  }

  /* ===== –∞–ª–µ—Ä—Ç—ã ===== */
  var ALERT_ENTRIES = [];
  function renderAlerts(){
    var box = $('#alertLog'); if(!box) return;

    if(!ALERT_ENTRIES.length){
      box.textContent = '–ü–æ–∫–∞ –∞–ª–ª–µ—Ä—Ç–æ–≤ –Ω–µ—Ç.';
      return;
    }

    var filter = ($('#alertFilter')?.value) || 'all';
    box.innerHTML = '';

    ALERT_ENTRIES.forEach(function(e){
      var finished = Number(e.finished || 0);
      var total    = Number(e.total || 0);

      var hasPassed = finished > 0;
      var isEmpty   = total === 0;

      if(filter === 'passed' && !hasPassed) return;
      if(filter === 'none'   && (hasPassed || isEmpty)) return;
      if(filter === 'empty'  && !isEmpty) return;

      var colorCls = isEmpty ? 'warn' : (hasPassed ? 'ok' : 'bad');

      var href = (CURRENT_BASE_URL ? (CURRENT_BASE_URL + '/api/launch/' + e.id + '/statistic') : '#');

      var row = document.createElement('div');
      row.className = 'alert-row ' + colorCls;
      row.innerHTML =
        '<a href="'+href+'" target="_blank">#'+e.id+'</a> ‚Äî '
        + (e.name || '(no name)') + ' = '
        + '<span>'+finished+'</span>' + (isEmpty?' (–±–µ–∑ –∫–µ–π—Å–æ–≤)':'');
      box.appendChild(row);
    });

    box.scrollTop = box.scrollHeight;
  }
  $('#alertFilter')?.addEventListener('change', renderAlerts);

  /* ===== –∞–≤—Ç–æ ===== */
  var autoTimer=null;
  function setAutoState(running){
    $('#autoState').textContent = '–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫: '+(running?'–≤–∫–ª—é—á—ë–Ω':'–≤—ã–∫–ª—é—á–µ–Ω');
    $('#autoStart').disabled = running;
    $('#autoStop').disabled = !running;
  }

  /* ===== –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ –¥–∞—à–±–æ—Ä–¥–∞ ===== */
  async function runDashboard(){
    try{ GET_CACHE.clear(); }catch(_){}
    try{ UWU_CACHE.clear(); }catch(_){}
    var logEl=$('#log'); if(logEl) logEl.textContent='';
    $('#logInfo') && ($('#logInfo').textContent='‚Äî');
    $('#summaryInfo') && ($('#summaryInfo').textContent='‚Äî');
    $('#alertLog') && ($('#alertLog').textContent='–ü–æ–∫–∞ –∞–ª–ª–µ—Ä—Ç–æ–≤ –Ω–µ—Ç.');
    ALERT_ENTRIES = [];

    var baseUrl=($('#baseUrl')&&$('#baseUrl').value.trim().replace(/\/$/,''))||'';
    var projectId=($('#projectId')&&$('#projectId').value.trim())||'';
    var version=($('#version')&&$('#version').value.trim())||'';
    var token=($('#token')&&$('#token').value.trim())||'';
    if(!baseUrl||!projectId||!token){ toast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ Base URL, Project ID –∏ —Ç–æ–∫–µ–Ω'); return; }
    CURRENT_BASE_URL = baseUrl;

    var headers={Accept:'application/json', Authorization:'Api-Token '+token, 'User-Agent':'allure-summary-html/stable'};

    try{
      const t0=now();
      const launches = await fetchLaunches(baseUrl, projectId, version, true, true, headers, 8, 100, logDash);

      if($('#logInfo')) $('#logInfo').textContent='–ó–∞–ø—É—Å–∫–æ–≤: '+launches.length;

      launches.forEach(it => appendLogLine('[LAUNCH] #'+it.id+' | '+(it.name||'')));

      setLogProgress({loaded: 0, total: launches.length, step: 0, steps: launches.length});

      const res = await aggregateByGroups(launches, baseUrl, headers, logDash, function(e){ appendLogLine('[error] '+e); });

      var agg=res.agg, perLaunchFinished=res.perLaunchFinished, perLaunchTotal=res.perLaunchTotal;

      // –ú–∏–Ω–∏-–ø–æ–Ω—á–∏–∫–∏ –ø–æ –ª–∞—É–Ω—á–∞–º (—É—á—Ç—ë–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
      window.__mini_last = { launches, perLaunchFinished, perLaunchTotal };
      updateStreamNamesUI();
      buildMiniLaunchCharts(launches, perLaunchFinished, perLaunchTotal, readMiniOpts());

      window.lastAgg=agg;
      window.lastUwuAgg=null;

      // NEW: –∞–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å—Ç—Ä–∏–º–æ–≤—ã—Ö —Å–Ω–µ–ø—à–æ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–π –≤—ã–±–æ—Ä–∫–∏ –ª–∞—É–Ω—á–µ–π
autoSaveAllStreamSnaps();

// NEW: –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –ø–æ–¥—Ç–∞–± ¬´–ü–æ —Å—Ç—Ä–∏–º—É¬ª ‚Äî —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–∏–º prev/curr –±–∞—Ä –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
if(document.getElementById('snapStreamSection')?.style.display !== 'none'){
  renderStreamSnapList();
  renderDashPrevCurrentStream(window.lastAgg, $('#dashMetricStream')?.value||'finished');
  buildDashMultiCompareStream({silent:true});
}

      // –∞–ª–µ—Ä—Ç—ã
      var st=getStore();
      var last = st.lastPerLaunch || {};
      const launchNames = {};
      launches.forEach(it => { launchNames[String(it.id)] = it.name || ''; });

      ALERT_ENTRIES = [];
      for(var id in perLaunchFinished){
        var curr = Number(perLaunchFinished[id]||0);
        last[id] = curr;
        ALERT_ENTRIES.push({ id:id, name:launchNames[id]||'', finished:curr, total:Number(perLaunchTotal[id]||0) });
      }
      st.lastPerLaunch = last;
      setStore(st); saveStoreMaybe();

      renderAlerts();

      renderAgg(agg, 'cards', 'barAll', $('#summaryInfo'), null);
      var mtr=($('#dashMetric')?.value)||'finished';
      renderDashPrevCurrent(agg, mtr);

      
      // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —Å—Ä–µ–∑–∞ (–∫–∞–∫ –≤ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
      try{ takeSnapshot({ version:($('#version')?.value.trim())||'', timeISO:(new Date()).toISOString(), data: agg }); }catch(_){}
buildDashMultiCompare({ silent: true });

      await buildReleaseSection(baseUrl, projectId, version, headers);

      appendLogLine('–°—á–∏—Ç–∞—é UwU –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º‚Ä¶');
      buildUwUAgg(launches, baseUrl, headers, logDash, function(e){ appendLogLine('[uwu] '+e); })
        .then(function(uwuAgg){
          window.lastUwuAgg = uwuAgg;
          renderAgg(window.lastAgg, 'cards', 'barAll', $('#summaryInfo'), window.lastUwuAgg);
        })
        .catch(function(e){
          appendLogLine('[uwu] –æ—à–∏–±–∫–∞: ' + (e.message||e));
        });

      const t1=now();
      appendLogLine('–ì–æ—Ç–æ–≤–æ –∑–∞ '+Math.round(t1-t0)+' –º—Å');
    }catch(e){
      toast(e.message||String(e));
    } finally {
      flushLog();
    }
  }

  /* ===== –≠–∫—Å–ø–æ—Ä—Ç (–æ–±—â–∏–π) ===== */
  function exportAggCSV(){
    if(!window.lastAgg){ toast('–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏—Ç–µ –¥–∞—à–±–æ—Ä–¥'); return; }
    var rows=[['group','total','finished','remaining_total','remaining','in_progress']];
    ORDER.forEach(function(g){
      var o=window.lastAgg[g]||{total:0,finished:0,remaining_total:0,remaining:0,in_progress:0};
      rows.push([g,o.total,o.finished,o.remaining_total,o.remaining,o.in_progress]);
    });
    var csv = rows.map(r => r.map(v=>{
      var x=(v==null?'':String(v));
      if(/[",\n]/.test(x)) x='"'+x.replace(/"/g,'""')+'"';
      return x;
    }).join(',')).join('\n');
    var blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
    var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='agg.csv'; a.click(); URL.revokeObjectURL(url);
  }
  function exportAggJSON(){
    if(!window.lastAgg){ toast('–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏—Ç–µ –¥–∞—à–±–æ—Ä–¥'); return; }
    var blob=new Blob([JSON.stringify(window.lastAgg,null,2)],{type:'application/json'});
        var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='agg.json'; a.click(); URL.revokeObjectURL(url);
  }
// –†–∞–∑–±–æ—Ä –∏–º–µ–Ω–∏ –ª–∞—É–Ω—á–∞: –∏—â–µ–º —Ç–æ–∫–µ–Ω—ã –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö –∏ –≤—ã–¥–µ–ª—è–µ–º stream / platform / kind
function parseStreamTriple(name){
  const tokens = [];
  String(name || '').replace(/\[([^\]]+)\]/g, (_, t) => {
    tokens.push(t);
    return '';
  });
  if (!tokens.length) return null;

  let stream = null;
  let platform = null;
  let kind = null;

  tokens.forEach(t => {
    const low = t.toLowerCase();
    if (low === 'android' || low === 'ios') {
      platform = t;
      return;
    }
    if (low === 'smoke' || low === 'selective' || low === 'high/blocker' || low === 'high-blocker') {
      // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º High-Blocker -> High/Blocker
      kind = (low === 'high-blocker') ? 'High/Blocker' : t;
      return;
    }
    if (!stream) {
      stream = t;
    }
  });

  if (!stream || !platform || !kind) return null;
  return { stream, platform, kind };
}

// –°–æ–±—Ä–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç—Ä–∏–º–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ kind (Smoke/Selective)
function collectStreamNames(kind){
  const L = (window.__mini_last && window.__mini_last.launches) || [];
  const set = new Set();
  L.forEach(x=>{
    const p = parseStreamTriple(x.name||'');
    if(p && p.kind.toLowerCase() === String(kind).toLowerCase()){
      set.add(p.stream);
    }
  });
  return Array.from(set).sort((a,b)=>a.localeCompare(b,'ru'));
}

// –û–±–Ω–æ–≤–∏—Ç—å UI —Å–µ–ª–µ–∫—Ç —Å–æ —Å—Ç—Ä–∏–º–∞–º–∏
function updateStreamNamesUI(){
  const kind = $('#streamKind')?.value || 'Smoke';
  const sel  = $('#streamName');
  if(!sel) return;
  const valPrev = sel.value;
  const names = collectStreamNames(kind);
  sel.innerHTML = '<option value="__all__">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∏–º ‚Äî</option>' +
                  names.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
  // –µ—Å–ª–∏ —Ä–∞–Ω–µ–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –µ—Å—Ç—å ‚Äî –≤–µ—Ä–Ω—ë–º
  if(names.includes(valPrev)) sel.value = valPrev;
}

// –ü–æ—Å—á–∏—Ç–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∞ (–ø–æ –¥–≤—É–º –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º) –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö –ª–∞—É–Ω—á–µ–π
function aggForStream(kind, streamName){
  const labels = orderForKind(kind);
  const agg = {};
  labels.forEach(l=>{ agg[l] = { total:0, finished:0, remaining_total:0, remaining:0, in_progress:0 }; });

  const L = (window.__mini_last && window.__mini_last.launches) || [];
  const FIN = (window.__mini_last && window.__mini_last.perLaunchFinished) || {};
  const TOT = (window.__mini_last && window.__mini_last.perLaunchTotal) || {};

  L.forEach(x=>{
    const p = parseStreamTriple(x.name||'');
    if(!p) return;
    if(p.kind.toLowerCase() !== String(kind).toLowerCase()) return;
    if(streamName && streamName !== '__all__' && p.stream !== streamName) return;

    const key = `[${p.platform}][${p.kind}]`;   // —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ñ–æ—Ä–º–æ–π –∏–∑ ORDER
    if(!(key in agg)) return;

    const finished = Number(FIN[x.id] || 0);
    const total    = Number(TOT[x.id] || 0);
    const remaining_total = Math.max(0, total - finished);

    agg[key].total           += total;
    agg[key].finished        += finished;
    agg[key].remaining_total += remaining_total;
    // –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –¥–µ–ª–µ–Ω–∏—è –Ω–∞ assigned/unassigned –∑–¥–µ—Å—å –Ω–µ—Ç ‚Äî —Å—á–∏—Ç–∞–µ–º –≤—Å—ë –∫–∞–∫ in_progress
    agg[key].in_progress     += remaining_total;
  });

  return agg;
}

  /* ====== –°—Ä–µ–∑—ã –ø–æ —Å—Ç—Ä–∏–º—É (Smoke / Selective) ====== */

  function orderForKind(kind){
    const k = String(kind).toLowerCase();
    if (k === 'smoke')         return ["[iOS][Smoke]","[Android][Smoke]"];
    if (k === 'selective')     return ["[Android][Selective]","[iOS][Selective]"];
    if (k === 'high/blocker')  return ["[iOS][High/Blocker]","[Android][High/Blocker]"];
    // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–µ—Ä–Ω—ë–º –≤—Å–µ —Ç—Ä–∏ –≥—Ä—É–ø–ø—ã, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —á—Ç–æ-—Ç–æ —Å—Ç—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–µ—Ç–µ–ª–æ
    return ["[iOS][Smoke]","[Android][Smoke]","[Android][Selective]","[iOS][Selective]","[iOS][High/Blocker]","[Android][High/Blocker]"];
  }

  function makeStreamSnapTitle(o){
    var ver=o.version||'all';
    return `[${o.kind}] v=${ver} ${o.timeISO}`;
  }

function takeStreamSnapshot(ctx){
  // ctx: { kind:'Smoke'|'Selective', version, timeISO }
  const kind = ctx.kind;
  const streamName = ($('#streamName')?.value) || '__all__';
  if(!streamName || streamName === '__all__'){
    toast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å—Ç—Ä–∏–º –≤ —Å–ø–∏—Å–∫–µ');
    return;
  }

  // —Å—Ç—Ä–æ–∏–º –∞–≥—Ä–µ–≥–∞—Ç —Ä–æ–≤–Ω–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∞ (–¥–≤–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è kind)
  const data = aggForStream(kind, streamName);

  var st=getStore();
  var id=String(Date.now())+Math.random().toString(16).slice(2);
  var snap={
    id,
    ts: Date.now(),
    kind,
    stream: streamName,
    title: `[${kind}] ${streamName} v=${ctx.version||'all'} ${ctx.timeISO}`,
    data
  };
  st.streamSnaps=(st.streamSnaps||[]);
  st.streamSnaps.push(snap);
  setStore(st);
  renderStreamSnapList();
  saveStoreMaybe();
  toast('–°—Ä–µ–∑ –ø–æ —Å—Ç—Ä–∏–º—É —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
}

function renderStreamSnapList(){
  var box=$('#snapListDashStream'); if(!box) return; box.innerHTML='';
  var kind = $('#streamKind')?.value || 'Smoke';
  var streamName = $('#streamName')?.value || '__all__';

  var store=getStore();
  var list=(store.streamSnaps||[]).filter(s=>
    String(s.kind||'').toLowerCase()===String(kind).toLowerCase()
    && (streamName==='__all__' || s.stream===streamName)
  );

  const labels = orderForKind(kind);

  for(var i=list.length-1;i>=0;i--){
    var s=list[i];
    var totalFinished = labels.reduce(function(sum,k){
      return sum + (((s.data||{})[k]||{}).finished||0);
    }, 0);

    var row=document.createElement('div');
    row.className='snap';
    row.innerHTML='<input type="checkbox" data-id="'+s.id+'" />'+
      '<label style="flex:1;display:flex;flex-direction:column;gap:2px;min-width:0">'+
      '<span class="title">'+escapeHtml(s.title)+'</span>'+
      '<span class="meta">'+(new Date(s.ts)).toLocaleString()
      +' ‚Ä¢ —Å—Ç—Ä–∏–º: '+escapeHtml(s.stream||'‚Äî')
      +' ‚Ä¢ –≤—Å–µ–≥–æ –ø—Ä–æ–π–¥–µ–Ω–æ: '+totalFinished.toLocaleString('ru-RU')+'</span></label>'+
      '<button class="del" data-id="'+s.id+'">–£–¥–∞–ª–∏—Ç—å</button>';
    box.appendChild(row);
  }
  var dels=box.querySelectorAll('.del');
  for(var d=0;d<dels.length;d++){
    dels[d].addEventListener('click', function(){
      var id=this.getAttribute('data-id'); var st=getStore();
      st.streamSnaps=(st.streamSnaps||[]).filter(function(x){return x.id!==id});
      setStore(st); renderStreamSnapList();
    });
  }

  // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ä–µ–∑–∞–º–∏ "–ü–æ —Å—Ç—Ä–∏–º—É"
  var btnSave  = document.getElementById('dashStreamSnapSave');
  var btnBuild = document.getElementById('dashStreamSnapBuild');
  var btnClear = document.getElementById('dashStreamSnapClear');

  if (btnSave) {
    btnSave.onclick = function(){
      // –ù—É–∂–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥–∞
      if (!window.__mini_last || !Array.isArray(window.__mini_last.launches) || !window.__mini_last.launches.length) {
        toast('–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏—Ç–µ –¥–∞—à–±–æ—Ä–¥');
        return;
      }
      var ctx = {
        kind:  (document.getElementById('streamKind')?.value) || 'Smoke',
        version: (document.getElementById('version')?.value.trim()) || '',
        timeISO: (new Date()).toISOString()
      };
      takeStreamSnapshot(ctx);
    };
  }

  if (btnBuild) {
    btnBuild.onclick = function(){
      buildDashMultiCompareStream({ silent:false });
    };
  }

  if (btnClear) {
    btnClear.onclick = function(){
      var kind  = (document.getElementById('streamKind')?.value) || 'Smoke';
      var streamName = (document.getElementById('streamName')?.value) || '__all__';
      var st = getStore();
      st.streamSnaps = (st.streamSnaps||[]).filter(function(s){
        var sameKind = String(s.kind||'').toLowerCase() === String(kind).toLowerCase();
        var sameStream = (streamName === '__all__') || (s.stream === streamName);
        return !(sameKind && sameStream);
      });
      setStore(st);
      renderStreamSnapList();
      toast('–°—Ä–µ–∑—ã –ø–æ —Å—Ç—Ä–∏–º—É —É–¥–∞–ª–µ–Ω—ã');
    };
  }
}

  function buildDashMultiCompareStream(opts){
  const silent = !!(opts && opts.silent);

  var metric=$('#dashMetricStream')?.value || 'finished';
  var kind = $('#streamKind')?.value || 'Smoke';
  var streamName = $('#streamName')?.value || '__all__';
  const labels=orderForKind(kind);

  var chosen=[].slice.call(document.querySelectorAll('#snapListDashStream input[type=checkbox]:checked'))
               .map(cb=>cb.getAttribute('data-id'));

  var snaps=(getStore().streamSnaps||[]).filter(s=>
    chosen.indexOf(s.id)!==-1
    && String(s.kind||'').toLowerCase()===String(kind).toLowerCase()
    && (streamName==='__all__' || s.stream===streamName)
  );

  if(!snaps.length){
    if(!silent) toast('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–µ–∑—ã (—Å—Ç—Ä–∏–º)');
    return;
  }

  const palette = ['#7a3af9','#00c48c','#ffb020','#ff5aad','#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#14b8a6'];
  const datasets = snaps.map((s, i)=>{
    const col = palette[i % palette.length];
    return {
      key: metric,
      label: prettySnapTitle(s.title || ('–°—Ä–µ–∑ '+(i+1))),
      data: labels.map(k => ((s.data||{})[k]||{})[metric] || 0),
      backgroundColor: hexA(col,.85),
      borderColor: col
    };
  });

  var wrap = document.getElementById('dashMultiBarStream')?.parentElement;
  if(wrap){
    var extra = Math.max(0, datasets.length - 6);
    wrap.style.height = Math.min(900, 320 + extra*24) + 'px';
  }

  makeBarChart('dashMultiBarStream', labels, datasets);
}

// NEW: –∞–≤—Ç–æ—Å–±–æ—Ä –≤—Å–µ—Ö –ø–æ—Å—Ç—Ä–∏–º–æ–≤—ã—Ö —Å—Ä–µ–∑–æ–≤ (–¥–ª—è Smoke –∏ Selective)
function autoSaveAllStreamSnaps(){
  // –ù—É–∂–Ω—ã –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ª–∞—É–Ω—á–∏/–ø–µ—Ä-–º–µ—Ç—Ä–∏–∫–∏ (–∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ runDashboard)
  const launchesOk = window.__mini_last && Array.isArray(window.__mini_last.launches) && window.__mini_last.launches.length;
  if(!launchesOk) return;

  const version = ($('#version')?.value.trim())||'';
  const timeISO = (new Date()).toISOString();

  const kinds = ['Smoke','Selective','High/Blocker'];
  const newSnaps = [];

  kinds.forEach(kind=>{
    const names = collectStreamNames(kind); // —Å–æ–±–µ—Ä—ë–º —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π —Å—Ç—Ä–∏–º–æ–≤ –ø–æ —Ç–µ–∫—É—â–∏–º –ª–∞—É–Ω—á–∞–º
    names.forEach(streamName=>{
      // –∞–≥—Ä–µ–≥–∞—Ç –í –°–ï–ö–¶–ò–ò ¬´–ü–æ —Å—Ç—Ä–∏–º—É¬ª –≤—Å–µ–≥–¥–∞ ¬´–¥–≤–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ kind¬ª ‚Äî –∏–∑ —Ç–µ–∫—É—â–∏—Ö –ª–∞—É–Ω—á–µ–π
      const data = aggForStream(kind, streamName);

      // —Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–Ω–µ–ø—à–æ—Ç
      newSnaps.push({
        id: String(Date.now())+Math.random().toString(16).slice(2),
        ts: Date.now(),
        kind,
        stream: streamName,
        title: `[${kind}] ${streamName} v=${version} ${timeISO}`,
        data
      });
    });
  });

  if(!newSnaps.length) return;

  // –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–æ –ø–æ–ª–æ–∂–∏–º –≤ store –∏ –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Å–ø–∏—Å–æ–∫ ¬´–ü–æ —Å—Ç—Ä–∏–º—É¬ª
  const st = getStore();
  st.streamSnaps = (st.streamSnaps||[]).concat(newSnaps);
  setStore(st);
  renderStreamSnapList();
  saveStoreMaybe();
  // –±–µ–∑ –Ω–∞–≤—è–∑—á–∏–≤–æ–≥–æ —Ç–æ—Å—Ç–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º ¬´—Ç–∏—Ö–æ¬ª, –Ω–æ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏:
  // toast('–ê–≤—Ç–æ—Å—Ä–µ–∑—ã –ø–æ —Å—Ç—Ä–∏–º–∞–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
}

function renderDashPrevCurrentStream(currentAggAll, metric){
  var kind = $('#streamKind')?.value || 'Smoke';
  var streamName = $('#streamName')?.value || '__all__';
  const labels=orderForKind(kind);

  // –¢–µ–∫—É—â–∞—è ‚Äú–æ–Ω–ª–∞–π–Ω‚Äù –∫–∞—Ä—Ç–∏–Ω–∞ ‚Äî –ø–æ –¥–∞–Ω–Ω—ã–º –ª–∞—É–Ω—á–µ–π, –Ω–æ —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∞
  const currentAgg = aggForStream(kind, streamName);

  metric=metric||'finished'; var color=COLORS[metric]||COLORS.finished;

  // –ø—Ä–µ–¥—ã–¥—É—â–∏–π ‚Äî –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø–æ—Å—Ç—Ä–∏–º–æ–≤—ã—Ö —Å—Ä–µ–∑–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ç—Ä–∏–º—É
  var list=(getStore().streamSnaps||[]).filter(s=>
    String(s.kind||'').toLowerCase()===String(kind).toLowerCase()
    && (streamName==='__all__' || s.stream===streamName)
  );
  var prev=list.length>0?list[list.length-1]:null;

  var currData=labels.map(function(k){ return (currentAgg[k]&&currentAgg[k][metric])||0; });
  var prevData=labels.map(function(k){ return (prev&&prev.data&&prev.data[k]&&prev.data[k][metric])?prev.data[k][metric]:0; });
  var deltas = currData.map(function(v,i){ return v - (prevData[i]||0); });

  var box=$('#dashDeltaStream');
  if(box){
    box.innerHTML='';
    for(var i=0;i<labels.length;i++){
      var d=deltas[i]; var sign=d>0?'+':'';
      var item=document.createElement('div'); item.className='kpi';
      item.innerHTML='<span class="label">'+labels[i]+' ‚Äî Œî</span><span class="val">'+sign+d.toLocaleString('ru-RU')+'</span>';
      box.appendChild(item);
    }
  }

  var dsPrev = {key:metric, label:'–ü—Ä–µ–¥—ã–¥—É—â–∏–π', data:prevData, backgroundColor:hexA(color,.35), borderColor:color};
  var dsCurr = {key:metric, label:'–¢–µ–∫—É—â–∏–π',   data:currData, backgroundColor:hexA(color,.85), borderColor:color};
  dsCurr.__delta = deltas;

  makeBarChart('dashPrevCurrStream', labels, [dsPrev, dsCurr]);
}


  /* ====== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====== */

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∞–±–æ–≤
  function showTab(tab) {
    var all = ['Dash','Swat','Vang','Create','Chp','Calc'];
    var key = String(tab || 'dash').toLowerCase();
    all.forEach(function (suffix) {
      var btn = document.getElementById('tab' + suffix + 'Btn');
      var sec = document.getElementById('tab' + suffix);
      var active = (suffix.toLowerCase() === key);
      if (btn) btn.classList.toggle('active', active);
      if (sec) sec.style.display = active ? 'block' : 'none';
    });
    var panel = document.querySelector('.panel.card');
    if (panel) {
      panel.style.display = (key === 'dash') ? '' : 'none';
    }
  }

  // –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±—ã
  $('#tabDashBtn')?.addEventListener('click', () => showTab('dash'));

  // –ü–æ–¥—Ç–∞–±—ã —Å—Ä–µ–∑–æ–≤
  function setSubtab(which){
    const g = (which==='general');
    $('#subtabGeneral').classList.toggle('active', g);
    $('#subtabStream').classList.toggle('active', !g);
    $('#snapGeneralSection').style.display = g ? 'block' : 'none';
    $('#snapStreamSection').style.display  = g ? 'none' : 'block';
  }
  $('#subtabGeneral')?.addEventListener('click', ()=> setSubtab('general'));
  $('#subtabStream')?.addEventListener('click', ()=> { setSubtab('stream'); renderStreamSnapList(); buildDashMultiCompareStream({silent:true}); if(window.lastAgg){ renderDashPrevCurrentStream(window.lastAgg, $('#dashMetricStream')?.value||'finished'); } });

  // –ú–∏–Ω–∏-–¥–∏–∞–≥—Ä–∞–º–º—ã
  $('#miniToggleBtn')?.addEventListener('click', ()=>{
    const wrap = $('#miniWrap');
    const shown = wrap.style.display!=='none';
    wrap.style.display = shown ? 'none' : 'block';
    $('#miniToggleBtn').textContent = shown ? '–ü–æ–∫–∞–∑–∞—Ç—å' : '–°–∫—Ä—ã—Ç—å';
    if(!shown) rebuildMini();
  });
  $('#miniCount')?.addEventListener('change', rebuildMini);
  $('#miniSortKey')?.addEventListener('change', rebuildMini);
  $('#miniSortDir')?.addEventListener('change', rebuildMini);
  $('#miniDept')?.addEventListener('change', rebuildMini);
  $('#miniPlatform')?.addEventListener('change', rebuildMini);

  // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç
  $('#autoStart')?.addEventListener('click', ()=>{
    const mins = Math.max(1, parseInt($('#autoMins')?.value||'20',10)||20);
    if(window.__autoTimer){ clearInterval(window.__autoTimer); }
    runDashboard();
    window.__autoTimer = setInterval(runDashboard, mins*60*1000);
    setAutoState(true);
  });
  $('#autoStop')?.addEventListener('click', ()=>{
    if(window.__autoTimer) clearInterval(window.__autoTimer);
    window.__autoTimer = null; setAutoState(false);
  });

  // –ö–Ω–æ–ø–∫–∏ –¥–∞–Ω–Ω—ã—Ö
  $('#dataPick')?.addEventListener('click', pickDataFile);
  $('#dataCreate')?.addEventListener('click', createDataFile);
  $('#dataSave')?.addEventListener('click', saveStoreMaybe);
  $('#dataImportBtn')?.addEventListener('click', ()=>$('#dataImport')?.click());
  $('#dataImport')?.addEventListener('change', async (e)=>{
    const file = e.target.files && e.target.files[0]; if(!file) return;
    try{
      const text = await file.text();
      const obj  = JSON.parse(text||'{}');
      setStore({ ...STORE_DEFAULT, ...obj });
      renderSnapList(); renderStreamSnapList();
      toast('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ');
    }catch(err){ toast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+(err.message||err)); }
  });
  $('#dataExportBtn')?.addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(getStore(),null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='regress-data.json'; a.click(); URL.revokeObjectURL(url);
  });
  $('#dataExportCsv')?.addEventListener('click', exportSnapsCSV);

  // –≠–∫—Å–ø–æ—Ä—Ç –≥—Ä–∞—Ñ–∏–∫–æ–≤/–∞–≥–≥—Ä–µ–≥–∞—Ü–∏–π
  $('#expAggCsv')?.addEventListener('click', exportAggCSV);
  $('#expAggJson')?.addEventListener('click', exportAggJSON);

  // –°—Ä–µ–∑—ã (–æ–±—â–∏–µ)
  renderSnapList();
  $('#dashMetric')?.addEventListener('change', ()=>{ if(window.lastAgg) renderDashPrevCurrent(window.lastAgg, $('#dashMetric')?.value||'finished'); });
  $('#dashKind')?.addEventListener('change', ()=>{
    if (window.lastAgg){
      renderAgg(window.lastAgg, 'cards', 'barAll', document.getElementById('summaryInfo'), window.lastUwuAgg || null);
      var mtr = (document.getElementById('dashMetric')?.value) || 'finished';
      renderDashPrevCurrent(window.lastAgg, mtr);
      buildDashMultiCompare({silent:true});
    }
  });
  // –°—Ä–µ–∑—ã (—Å—Ç—Ä–∏–º)
  renderStreamSnapList();
  $('#dashMetricStream')?.addEventListener('change', ()=>{ if(window.lastAgg) renderDashPrevCurrentStream(window.lastAgg, $('#dashMetricStream')?.value||'finished'); });
// –ü—Ä–∏ —Å–º–µ–Ω–µ –≤–∏–¥–∞ —Å—Ç—Ä–∏–º–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
$('#streamKind')?.addEventListener('change', ()=>{
  updateStreamNamesUI();
  renderStreamSnapList();
  buildDashMultiCompareStream({silent:true});
  if(window.lastAgg) renderDashPrevCurrentStream(window.lastAgg, $('#dashMetricStream')?.value||'finished');
});

// –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∞ ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
$('#streamName')?.addEventListener('change', ()=>{
  renderStreamSnapList();
  buildDashMultiCompareStream({silent:true});
  if(window.lastAgg) renderDashPrevCurrentStream(window.lastAgg, $('#dashMetricStream')?.value||'finished');
});

// –ü—Ä–∏ —Å–±–æ—Ä–∫–µ –¥–∞—à–±–æ—Ä–¥–∞ ‚Äî –∫–æ–≥–¥–∞ –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ –ª–∞—É–Ω—á–µ–π ‚Äî –Ω–∞–ø–æ–ª–Ω–∏–º —Å–µ–ª–µ–∫—Ç —Å—Ç—Ä–∏–º–æ–≤
// (–¥–æ–±–∞–≤—å –≤ –∫–æ–Ω—Ü–µ runDashboard(), —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ window.__mini_last = {...};)

  // –ö–Ω–æ–ø–∫–∏ —Å—Ä–µ–∑–æ–≤
  $('#dashSnapBuild')?.addEventListener('click', ()=>buildDashMultiCompare({silent:false}));
  $('#dashStreamSnapBuild')?.addEventListener('click', ()=>buildDashMultiCompareStream({silent:false}));
  $('#dashStreamSnapSave')?.addEventListener('click', ()=>{
    if(!window.lastAgg){ toast('–°–Ω–∞—á–∞–ª–∞ —Å–æ–±–µ—Ä–∏—Ç–µ –¥–∞—à–±–æ—Ä–¥'); return; }
    const kind = $('#streamKind')?.value || 'Smoke';
    takeStreamSnapshot({ kind, version:($('#version')?.value.trim())||'', timeISO:(new Date()).toISOString(), data: window.lastAgg });
  });
  $('#dashStreamSnapClear')?.addEventListener('click', ()=>{
    var st=getStore(); var kind=$('#streamKind')?.value||'Smoke';
    st.streamSnaps=(st.streamSnaps||[]).filter(s=> String(s.kind||'').toLowerCase()!==String(kind).toLowerCase());
    setStore(st); renderStreamSnapList(); toast('–°—Ä–µ–∑—ã —Å—Ç—Ä–∏–º–∞ –æ—á–∏—â–µ–Ω—ã');
  });

// –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞
$('#runBtn')?.addEventListener('click', runDashboard);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
showTab('dash');
setSubtab('general');
setAutoState(false);
})();
 </script>

<!-- ==== SWAT TAB (injected, non-invasive) ==== -->


<!-- ==== Additive SWAT API controls + logic (non-invasive) ==== -->


<script>
// === SWAT: fast mode (parallel leaves + higher concurrency, throttled logs) ===
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    if(typeof sw_buildFromApi !== 'function') return;
    const original = sw_buildFromApi;

    function now(){ return (typeof performance!=='undefined' && performance.now) ? performance.now() : Date.now(); }

    // Override with fast version
    sw_buildFromApi = async function sw_buildFromApi_fast(){
      const baseUrl = (document.getElementById('swatBaseUrl').value||'').trim().replace(/\/+$/,'');
      const token   = (document.getElementById('swatApiToken').value||'').trim();
      const projectId = (document.getElementById('swatProjectId').value||'').trim();
      const release = (document.getElementById('swatRelease').value||'').trim();
      const kinds = []; if(document.getElementById('kindSmoke')?.checked) kinds.push('Smoke'); if(document.getElementById('kindSelective')?.checked) kinds.push('Selective'); if(document.getElementById('kindHB')?.checked) kinds.push('High/Blocker');
      if(!baseUrl || !token || !projectId || !release || kinds.length===0){ alert('–£–∫–∞–∂–∏—Ç–µ Base URL, Project ID, Token, –†–µ–ª–∏–∑ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ Kind'); return; }

      // helpers
      async function safe(promiseFactory, ctx){
        try{ return await promiseFactory(); }
        catch(e){ log('API error'+(ctx?(' @ '+ctx):'')+': '+(e.message||e),'ERROR'); return null; }
      }
      const limit8  = (typeof sw_pLimit==='function') ? sw_pLimit(8)  : (fn=>fn());
      const limit32 = (typeof sw_pLimit==='function') ? sw_pLimit(32) : (fn=>fn());

      log(`(FAST) –ò—â—É –ª–∞—É–Ω—á–∏ –¥–ª—è —Ä–µ–ª–∏–∑–∞ ${release} –ø–æ –≤–∏–¥–∞–º: ${kinds.join(', ')}`);
      setProgress(2);
      const launches = await safe(()=>sw_findLaunchesByRelease(baseUrl, projectId, token, release, kinds), 'findLaunchesByRelease') || [];
      log(`–ù–∞–π–¥–µ–Ω–æ –ª–∞—É–Ω—á–µ–π: ${launches.length}`);
      if(!launches.length){ setProgress(100); sw_renderSummary([]); sw_renderDetailed([]); return; }

      // Collect leaves in parallel per launch
      let allLeafIds = [];
      const leavesArr = await Promise.all(launches.map(ln => limit8(()=> safe(()=>sw_listLeafResultsForLaunch(baseUrl, token, ln.id), 'listLeafResultsForLaunch('+ln.id+')') )));
      leavesArr.forEach(ids => { if(Array.isArray(ids)) allLeafIds.push(...ids); });
      log('(FAST) –í—Å–µ–≥–æ –ª–∏—Å—Ç–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: '+allLeafIds.length);
      if(!allLeafIds.length){ setProgress(100); sw_renderSummary([]); sw_renderDetailed([]); return; }

      // Analyze leaves with higher concurrency + throttled UI updates
      const swatSet = (typeof sw_parseSwatList==='function') ? sw_parseSwatList() : new Set();
      const records=[];
      let done=0, t0=now(), lastUi=0;
      await Promise.all(allLeafIds.map(id => limit32(async ()=>{
        const rec = await safe(()=>sw_analyzeLeaf(baseUrl, token, id, swatSet), 'analyzeLeaf('+id+')');
        if(rec) records.push(rec);
        done++;
        const t=now();
        if(t - lastUi > 500 || done===allLeafIds.length){
          const pct = Math.round( (done*100)/allLeafIds.length );
          setProgress(2 + 96*done/allLeafIds.length);
          // –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –ª–æ–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
          log(`(FAST) ${done}/${allLeafIds.length} ‚Ä¢ ${pct}%`, 'DEBUG');
          lastUi = t;
        }
      })));

      window.__swat_records_all = records.slice();
      sw_populateStreams(); sw_populateRuns(); sw_applyFiltersAndRender();
      setProgress(100);
      log('(FAST) –ì–æ—Ç–æ–≤–æ –∏–∑ API');
    };

    // –ò –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π: –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫ ‚Äî –≤–µ—Ä–Ω—ë–º –æ—Ä–∏–≥–∏–Ω–∞–ª –ø–æ Shift+–∫–ª–∏–∫—É
    const btn = document.getElementById('swatBuildApi');
    if(btn){
      btn.title = (btn.title?btn.title+'\n':'') + 'Shift+Click ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º';
      btn.addEventListener('click', function(e){
        if(e.shiftKey){
          sw_buildFromApi = original;
          setTimeout(()=>{ sw_buildFromApi = arguments.callee.fastApplied ? sw_buildFromApi : sw_buildFromApi; }, 0);
        }
      }, { once:true });
    }
  });
})();
</script>

<!-- Safe swap for Release and API Token fields -->
<script>
(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    try{
      // –∏—â–µ–º –±–ª–æ–∫ SWAT –∏ –ø–æ–ª—è
      var api = document.getElementById('swatApiPanel') || document; // fallback
      var fldTokenEl   = document.getElementById('swatApiToken');
      var fldReleaseEl = document.getElementById('swatRelease');
      if(!fldTokenEl || !fldReleaseEl) return;

      // –±–µ—Ä—ë–º .field –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
      var fldToken   = fldTokenEl.closest('.field') || fldTokenEl;
      var fldRelease = fldReleaseEl.closest('.field') || fldReleaseEl;
      if(!fldToken.parentNode || !fldRelease.parentNode) return;

      // –µ—Å–ª–∏ —É–∂–µ —Å—Ç–æ–∏—Ç –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (Release –¥–æ Token) ‚Äî –≤—ã—Ö–æ–¥–∏–º
      var sibl = fldRelease.nextElementSibling;
      if(sibl === fldToken) return;

      // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–∑–ª–æ–≤
      var placeholder = document.createElement('div');
      fldToken.parentNode.insertBefore(placeholder, fldToken);
      fldRelease.replaceWith(fldToken);
      placeholder.replaceWith(fldRelease);
      // –ì–û–¢–û–í–û: –ø–æ–ª—è –ø–æ–º–µ–Ω—è–ª–∏—Å—å –º–µ—Å—Ç–∞–º–∏ –±–µ–∑ insertBefore –Ω–∞ —á—É–∂–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    }catch(e){
      console.warn('SWAT swap fields failed:', e);
    }
  });
})();
</script>

 

<!-- === PATCH: show/hide toggles + initial stream hide + footer tail cleanup + SWAT safe visibility === -->

<script>
(function(){
  const $ = (s, r=document)=>r.querySelector(s);
  const $$= (s, r=document)=>Array.from(r.querySelectorAll(s));

  // 1) Initial: on Dashboard show only "–û–±—â–∏–µ" (hide "–ü–æ —Å—Ç—Ä–∏–º—É")
  function hideStreamOnStart(){
    const gen = $('#snapListDash, #snapGeneralSection');
    const str = $('#snapListDashStream, #snapStreamSection');
    if(str){ str.style.display='none'; }
    if(gen){ gen.style.display=''; }
  }

  // 2) Re-bind subtabs "–û–±—â–∏–µ / –ü–æ —Å—Ç—Ä–∏–º—É" if present (UI only)
  function bindSubtabs(){
    const btnG = $('#subtabGeneral');
    const btnS = $('#subtabStream');
    const gen  = $('#snapGeneralSection, #snapListDash');
    const str  = $('#snapStreamSection, #snapListDashStream');
    if(!btnG || !btnS || !gen || !str) return;
    const showG = ()=>{ gen.style.display=''; str.style.display='none'; btnG.classList.add('active'); btnS.classList.remove('active'); };
    const showS = ()=>{ gen.style.display='none'; str.style.display=''; btnS.classList.add('active'); btnG.classList.remove('active'); };
    btnG.addEventListener('click', (e)=>{ e.preventDefault(); showG(); });
    btnS.addEventListener('click', (e)=>{ e.preventDefault(); showS(); });
    // default
    showG();
  }

  // 3) Add toggle buttons "–ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å" for known sections by heading text
  function makeBtn(){ const b=document.createElement('button'); b.className='pill toggle-btn'; b.type='button'; b.textContent='–°–∫—Ä—ã—Ç—å'; return b; }
  function attachToggleByTitle(title){
    // find heading node that matches title
    const heads = $$('h2,h3,.head,.card .head,.card .title,.section-title');
    const hdr = heads.find(h=> (h.textContent||'').trim() === title);
    if(!hdr) return;
    const panel = hdr.closest('.card, section, .panel, .box, .wrap, .container, div');
    if(!panel || panel.__toggleBound) return;
    panel.__toggleBound = true;
    const btn = makeBtn();
    // place at header end
    hdr.appendChild(btn);
    const content = hdr.nextElementSibling || panel.children[1];
    if(!content) return;
    btn.addEventListener('click', ()=>{
      const vis = content.style.display !== 'none';
      content.style.display = vis ? 'none' : '';
      btn.textContent = vis ? '–ü–æ–∫–∞–∑–∞—Ç—å' : '–°–∫—Ä—ã—Ç—å';
      if(!vis && typeof window.rebuildMini==='function'){ try{ rebuildMini(); }catch(_){} }
    });
  }
  function attachToggles(){
    [
      '–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ä–µ–∑—ã',
      '–õ–æ–≥',
      '–ê–ª–ª–µ—Ä—Ç –ø–æ –ª–∞—É–Ω—á–∞–º',
      '[iOS][Smoke]',
      '[Android][Smoke]',
      '[Android][Selective]',
      '[iOS][Selective]',
      '–°–≤–æ–¥–Ω—ã–π –±–∞—Ä—á–∞—Ä—Ç'
    ].forEach(attachToggleByTitle);
  }

  // 4) Footer "tail" cleanup: hide accidental printed JS
  function cleanFooterTail(){
    const body = document.body;
    const nodes = Array.from(body.childNodes).slice(-30);
    nodes.forEach(n=>{
      if(n.nodeType===3){
        const t = (n.textContent||'').trim();
        if(t.length>120 && /(return\s+new\s+Blob|function\s+downloadBlob|btnExportXls|sw_exportXls)/i.test(t)){
          const d=document.createElement('div'); d.className='__code-dump'; d.textContent=t; body.replaceChild(d,n);
        }
      } else if(n.nodeType===1){
        const txt = (n.textContent||'').trim();
        if(txt.length>300 && /(return\s+new\s+Blob|function\s+downloadBlob|btnExportXls|sw_exportXls)/i.test(txt)){
          n.classList.add('__code-dump');
        }
      }
    });
  }

  // 5) SWAT safe visibility: show only on its tab (if tabs exist)
  function bindTopTabs(){
    const bar = $('nav .tabs, .tabs, [data-tabs="main"]') || document;
    bar.addEventListener('click', (e)=>{
      const el = e.target.closest('button, a, [data-tab]');
      if(!el) return;
      const label = (el.textContent||'').trim();
      const dash = $('#tabDash, #dashboardWrap, [data-block="dashboard"]');
      const isDa = /–¥–∞—à–±–æ—Ä–¥/i.test(label);
      if(dash){
        if(dash) dash.style.display = isDa ? '' : 'none';
      }
      // unstick active state if buttons have it
      const btns = $$('.tabs [data-tab], .tabs button, nav .tabs button');
      btns.forEach(b=> b.classList.remove('active','active-btn'));
      el.classList.add('active');
      setTimeout(cleanFooterTail, 50);
    }, {passive:true});
  }

  function init(){
    hideStreamOnStart();
    bindSubtabs();
    attachToggles();
    cleanFooterTail();
    bindTopTabs();
    setTimeout(cleanFooterTail, 400);
    setTimeout(cleanFooterTail, 1500);
  }
  if(document.readyState!=='loading') init();
  else document.addEventListener('DOMContentLoaded', init);
})();
</script>

<!-- PATCH: add STOP button next to '–ó–∞–ø—É—Å—Ç–∏—Ç—å' on dashboard -->
<script>
(function(){
  var runBtn = document.getElementById('runBtn');
  if(!runBtn) return;
  // create Stop button if not exists
  var stopBtn = document.getElementById('stopBtn');
  if(!stopBtn){
    stopBtn = document.createElement('button');
    stopBtn.id = 'stopBtn';
    stopBtn.className = runBtn.className;
    stopBtn.textContent = '–°—Ç–æ–ø';
    stopBtn.style.marginLeft = '8px';
    runBtn.parentNode.insertBefore(stopBtn, runBtn.nextSibling);
  }
  // global abort controller (opt-in for your fetches using window.__dashAbort.signal)
  if(!window.__dashAbort) window.__dashAbort = new AbortController();

  function setBusy(b){
    runBtn.disabled = !!b;
    stopBtn.disabled = !b;
    if(b){ runBtn.classList.add('busy'); } else { runBtn.classList.remove('busy'); }
  }
  setBusy(false); // initial

  runBtn.addEventListener('click', function(){
    // new controller for a new run
    try { window.__dashAbort.abort(); } catch(_){}
    window.__dashAbort = new AbortController();
    window.__shouldStop = false;
    setBusy(true);
  });

  stopBtn.addEventListener('click', function(){
    window.__shouldStop = true;
    try { window.__dashAbort.abort(); } catch(_){}
    setBusy(false);
  });
})();
</script>

<!-- STOP/ABORT shim injected -->
<script id="stop-abort-shim">
(function(){
  // prevent double inject
  if (window.__stopShimInstalled__) return;
  window.__stopShimInstalled__ = true;

  // Global abort session
  const abortState = (window.__abortState__ = {
    controller: null,
    active: false,
    stopRequested: false,
  });

  function beginAbortSession(){
    abortState.controller = new AbortController();
    abortState.active = true;
    abortState.stopRequested = false;
  }
  function requestStop(){
    abortState.stopRequested = true;
    try{ abortState.controller && abortState.controller.abort(); }catch(_){}
    abortState.active = false;
  }
  window.__beginAbortSession__ = beginAbortSession;
  window.__requestStop__ = requestStop;

  // Fetch shim: add signal automatically
  if (!window.__fetchPatchedForAbort__) {
    const _fetch = window.fetch;
    window.fetch = function(input, init){
      init = init || {};
      if (abortState.controller && !init.signal){
        init = Object.assign({}, init, { signal: abortState.controller.signal });
      }
      return _fetch(input, init);
    };
    window.__fetchPatchedForAbort__ = true;
  }

  // Global abort-aware promise helper
  window.abortable = function(promise){
    if (!abortState.controller) return promise;
    const s = abortState.controller.signal;
    if (!s) return promise;
    return new Promise((resolve,reject)=>{
      const onAbort = ()=>reject(Object.assign(new Error('ABORT'),{name:'AbortError'}));
      if (s.aborted) return onAbort();
      s.addEventListener('abort', onAbort, {once:true});
      promise.then(v=>{ s.removeEventListener('abort', onAbort); resolve(v); },
                   e=>{ s.removeEventListener('abort', onAbort); reject(e); });
    });
  };

  // UI: find buttons by id or text
  function byText(btns, txt){
    txt = String(txt).trim().toLowerCase();
    return Array.from(btns).find(b => (b.textContent||'').trim().toLowerCase() === txt);
  }

  function pickButtons(){
    const allBtns = document.querySelectorAll('button, .btn');
    let run = document.querySelector('#dashRunBtn') || byText(allBtns, '–∑–∞–ø—É—Å—Ç–∏—Ç—å');
    let stop = document.querySelector('#dashStopBtn') || byText(allBtns, '—Å—Ç–æ–ø');
    return {run, stop};
  }

  function ensureHandlers(){
    const {run, stop} = pickButtons();
    if (!run || !stop || run.__stopShimBound__) return;
    run.__stopShimBound__ = true;

    // RUN
    run.addEventListener('click', function(){
      // start session; UI lock (defer to avoid blocking other handlers)
      try{ beginAbortSession(); }catch(_){}
      setTimeout(()=>{
        run.disabled = true;
        run.classList.add('is-busy');
        // the page code should re-enable itself; as a fallback re-enable after 30s
        setTimeout(()=>{ run.disabled=false; run.classList.remove('is-busy'); }, 30000);
      }, 0);
    }, {capture:true});

    // STOP
    stop.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      requestStop();
      // re-enable run button immediately
      setTimeout(()=>{
        const {run} = pickButtons();
        if (run){ run.disabled = false; run.classList.remove('is-busy'); }
      }, 0);
    });
  }

  // try now and on dom changes
  ensureHandlers();
  const mo = new MutationObserver(ensureHandlers);
  mo.observe(document.documentElement, {subtree:true, childList:true});
  
  // silence AbortError red screens
  window.addEventListener('unhandledrejection', (ev)=>{
    const r = ev.reason;
    if (r && (r.name === 'AbortError' || String(r).includes('AbortError') || String(r).includes('ABORT'))) {
      ev.preventDefault();
    }
  });
})();
</script>


  <!-- ====================== –í–ê–ù–ì–û–í–ê–¢–û–† (4-—è –≤–∫–ª–∞–¥–∫–∞, iframe-–∏–∑–æ–ª—è—Ü–∏—è) ====================== -->
  












<script>
// === Platform/Type Filters (robust, DOM-level, with summary) ===
(function(){
  function normKey(s){ return String(s||'').replace(/\]\s*\[/g, '][').trim(); }
  function parseLabel(label){
    label = normKey(label);
    var plat = (label.indexOf('[iOS]')===0) ? 'iOS' : (label.indexOf('[Android]')===0 ? 'Android' : null);
    var type = label.includes('[High/Blocker]') ? 'High/Blocker' :
               (label.includes('[Selective]') ? 'Selective' :
               (label.includes('[Smoke]') ? 'Smoke' : null));
    return { platform: plat, type: type };
  }
  function isPlatformEnabled(p){
    if(p==='iOS') return document.getElementById('fltPlatIOS')?.checked === true;
    if(p==='Android') return document.getElementById('fltPlatAndroid')?.checked === true;
    return true; // unknown -> don't hide
  }
  function isTypeEnabled(t){
    if(t==='Smoke') return document.getElementById('fltTypeSmoke')?.checked === true;
    if(t==='Selective') return document.getElementById('fltTypeSelective')?.checked === true;
    if(t==='High/Blocker') return document.getElementById('fltTypeHB')?.checked === true;
    return true;
  }
  function isVisibleLabel(label){
    var p = parseLabel(label);
    return isPlatformEnabled(p.platform) && isTypeEnabled(p.type);
  }

  // For bars: filter labels/datasets by visibility
  if (typeof window.makeBarChart === 'function' && !window.__makeBarChartOrig){
    window.__makeBarChartOrig = window.makeBarChart;
    window.makeBarChart = function(barId, labels, datasets){
      try{
        var idx = labels.map(function(l,i){ return isVisibleLabel(l) ? i : -1; }).filter(function(x){return x!==-1;});
        var labels2 = idx.map(function(i){ return labels[i]; });
        var datasets2 = (datasets||[]).map(function(ds){
          var d = ds.data || [];
          return Object.assign({}, ds, { data: idx.map(function(i){ return d[i]; }) });
        });
        return window.__makeBarChartOrig(barId, labels2, datasets2);
      }catch(e){ console.warn('bar filter error', e); return window.__makeBarChartOrig(barId, labels, datasets); }
    };
  }

  // Donuts: show/hide by visibility
  function applyVisibilityFilter(){
    try{
      var cards = document.querySelectorAll('#cards .card');
      cards.forEach(function(card){
        var title = card.querySelector('.head > div:first-child');
        var label = title ? title.textContent : '';
        card.style.display = isVisibleLabel(label) ? '' : 'none';
      });
    }catch(e){ console.warn('applyVisibilityFilter error', e); }
  }
  window.__applyVisibilityFilter = applyVisibilityFilter;

  // Recompute summary ("–í—Å–µ–≥–æ –≥—Ä—É–ø–ø / –≤—Å–µ–≥–æ –∫–µ–π—Å–æ–≤") based on visible labels
  function updateSummaryFromFilters(){
    try{
      var sumEl = document.getElementById('summaryInfo');
      if(!sumEl || !window.__lastAgg) return;
      var labels = Object.keys(window.__lastAgg || {});
      var visible = labels.filter(isVisibleLabel);
      var totalCases = visible.reduce(function(acc, k){
        var a = window.__lastAgg[k] || {};
        var t = Number(a.total || 0);
        return acc + (isFinite(t) ? t : 0);
      }, 0);
      sumEl.textContent = '–í—Å–µ–≥–æ –≥—Ä—É–ø–ø: ' + visible.length + ', –≤—Å–µ–≥–æ –∫–µ–π—Å–æ–≤: ' + (totalCases.toLocaleString ? totalCases.toLocaleString('ru-RU') : totalCases);
    }catch(e){ console.warn('updateSummaryFromFilters error', e); }
  }
  window.__updateSummaryFromFilters = updateSummaryFromFilters;

  // Hook renderAgg to capture agg and apply filters after draw
  (function hookRender(){
    if (typeof window.renderAgg !== 'function' || window.__renderAggHooked) return;
    window.__renderAggHooked = true;
    var orig = window.renderAgg;
    window.renderAgg = function(a,b,c,d){
      window.__lastAgg = a; // remember
      var r = orig(a,b,c,d);
      try{ applyVisibilityFilter(); updateSummaryFromFilters(); }catch(_e){}
      return r;
    };
  })();

  function bindUI(){
    var ids = ['fltPlatIOS','fltPlatAndroid','fltTypeSmoke','fltTypeSelective','fltTypeHB'];
    ids.forEach(function(id){
      var el = document.getElementById(id);
      if(el && !el.__bind){
        el.__bind = true;
        el.addEventListener('change', function(){
          try{
            if (typeof window.renderAgg === 'function' && window.__lastAgg){
              window.renderAgg(window.__lastAgg, 'cards', 'barAll', document.getElementById('summaryInfo'), window.lastUwuAgg || null);
            } else {
              applyVisibilityFilter();
              updateSummaryFromFilters();
              window.dispatchEvent(new Event('resize'));
            }
          }catch(e){ console.warn('repaint failed', e); }
        });
      }
    });
    document.getElementById('fltAll')?.addEventListener('click', function(){
      ['fltPlatIOS','fltPlatAndroid','fltTypeSmoke','fltTypeSelective','fltTypeHB'].forEach(function(id){ var el=document.getElementById(id); if(el) el.checked=true; });
      document.getElementById('fltPlatIOS')?.dispatchEvent(new Event('change'));
    });
    document.getElementById('fltNone')?.addEventListener('click', function(){
      ['fltPlatIOS','fltPlatAndroid','fltTypeSmoke','fltTypeSelective','fltTypeHB'].forEach(function(id){ var el=document.getElementById(id); if(el) el.checked=false; });
      document.getElementById('fltPlatIOS')?.dispatchEvent(new Event('change'));
    });
  }
  document.addEventListener('DOMContentLoaded', bindUI);
})();
</script>





<script>
// ========= Settings persistence + instant filters (patch v3: debounced + calls updateSummaryFromFilters) =========
(function(){
  const LS_KEYS = {
    version: 'rb__version',
    token: 'rb__token',
    baseUrl: 'rb__baseUrl',
    projectId: 'rb__projectId'
  };
  const $ = sel => document.querySelector(sel);

  const versionInput   = $('#version');
  const tokenInput     = $('#token');
  const baseUrlInput   = $('#baseUrl');
  const projectIdInput = $('#projectId');
  const saveBtn        = $('#saveSettingsBtn');
  const toast          = $('#toast');

  function showToast(msg){
    if(!toast) return;
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=> toast.classList.remove('show'), 1500);
  }
  function setIfEmpty(el, val){
    if(el && (el.value === '' || el.value == null)) el.value = val;
  }

  // Load saved values
  try {
    const v   = localStorage.getItem(LS_KEYS.version);
    const t   = localStorage.getItem(LS_KEYS.token);
    const bu  = localStorage.getItem(LS_KEYS.baseUrl);
    const pid = localStorage.getItem(LS_KEYS.projectId);
    if(v)   setIfEmpty(versionInput, v);
    if(t)   setIfEmpty(tokenInput, t);
    if(bu)  setIfEmpty(baseUrlInput, bu);
    if(pid) setIfEmpty(projectIdInput, pid);
  } catch(e){}
  // Defaults if nothing saved
  setIfEmpty(baseUrlInput, 'https://allure-testops.wb.ru');
  setIfEmpty(projectIdInput, '7');

  function saveSettings(){
    try{
      if(versionInput)   localStorage.setItem(LS_KEYS.version,   (versionInput.value||'').trim());
      if(tokenInput)     localStorage.setItem(LS_KEYS.token,     (tokenInput.value||'').trim());
      if(baseUrlInput)   localStorage.setItem(LS_KEYS.baseUrl,   (baseUrlInput.value||'').trim());
      if(projectIdInput) localStorage.setItem(LS_KEYS.projectId, (projectIdInput.value||'').trim());
      showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    }catch(e){
      console.error(e);
      showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å');
    }
  }
  if(saveBtn) saveBtn.addEventListener('click', saveSettings);
  [versionInput, tokenInput].forEach(el => { if(el) el.addEventListener('blur', saveSettings); });

  // ========== Instant filters ==========
  const fltSmoke    = $('#fltTypeSmoke');
  const fltSel      = $('#fltTypeSelective');
  const fltHB       = $('#fltTypeHB');
  const fltIOS      = $('#fltPlatIOS');
  const fltAndroid  = $('#fltPlatAndroid');
  const btnAll      = $('#fltAll');
  const btnNone     = $('#fltNone');

  let rafId = 0;
  function scheduleApply(){
    if(rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(()=>{
      if (typeof window.updateSummaryFromFilters === 'function') {
        try { window.updateSummaryFromFilters(); } catch(e){ console.debug(e); }
      }
      const fns = [
        'buildSummaryBar','rebuildSummaryBar','renderSummaryBar','updateSummaryBar',
        'buildMiniDonuts','renderMiniDonuts','updateMiniDonuts',
        'sw_renderSummary','renderAgg','renderDashPrevCurrent','renderDashPrevCurrentStream',
        'renderStreamSnapList','renderSnapList'
      ];
      fns.forEach(name => { if (typeof window[name] === 'function') { try{ window[name](); }catch(e){ console.debug(name, e); } } });
    });
  }

  [fltSmoke, fltSel, fltHB, fltIOS, fltAndroid].forEach(el => {
    if(!el) return;
    el.addEventListener('change', scheduleApply);
    el.addEventListener('input',  scheduleApply);
    el.addEventListener('click',  scheduleApply);
  });

  if(btnAll){
    btnAll.addEventListener('click', () => {
      [fltSmoke, fltSel, fltHB, fltIOS, fltAndroid].forEach(el => { if(el) el.checked = true; });
      scheduleApply();
    });
  }
  if(btnNone){
    btnNone.addEventListener('click', () => {
      [fltSmoke, fltSel, fltHB, fltIOS, fltAndroid].forEach(el => { if(el) el.checked = false; });
      scheduleApply();
    });
  }

  scheduleApply();
})();
</script>

<!-- START: Safe standalone "–°—Ç—Ä–∏–º—ã" multiselect (injected by assistant) -->


<script>
(function(){
  // Safe wrapper: errors inside will not break the page
  try{
    const LOCAL_KEY = 'mini_streams_selection_v1';
    const DROPDOWN_ID = 'rrStreamDD_safe_v1';
    const RETRY_INTERVAL_MS = 800;
    const MAX_RETRIES = 40;

    function safe$(sel, root=document){ try{ return root.querySelector(sel); }catch(_){ return null; } }
    function safe$all(sel, root=document){ try{ return Array.from(root.querySelectorAll(sel)); }catch(_){ return []; } }

    function findContext(){
      const root = document.getElementById('miniLaunchCard') || document;
      const toolbar = (root.querySelector('.head .export') || root.querySelector('.head') || root.querySelector('.mini-toolbar')) || null;
      const grid = (root.querySelector('#miniGrid') || root.querySelector('.mini-grid') || root.querySelector('[data-mini-grid]') || root.querySelector('.cards') || root.querySelector('.grid')) || null;
      return {root, toolbar, grid};
    }

    function collectCards(grid){
      if(!grid) return [];
      const candidates = safe$all('[data-mini-card], .mini-card, .miniCard, .card', grid);
      return candidates.filter(el=>{
        try{
          if(el.querySelector('svg, canvas')) return true;
          const txt = (el.textContent||'').trim();
          if(/%|–ü—Ä–æ–π–¥–µ–Ω–æ|–ü—Ä–æ–π—à–ª–æ|–ü—Ä–æ—à–ª–æ/i.test(txt)) return true;
          return false;
        }catch(_){ return false; }
      });
    }

    function detectStreamFromCard(el){
      try{
        if(!el) return '–ü—Ä–æ—á–µ–µ';
        if(el.dataset && el.dataset.stream) return el.dataset.stream.trim();
        const titleNode = el.querySelector('[data-title], .title, h4, h5, .card-title') || el.querySelector('div') || el;
        const txt = (titleNode.textContent || el.textContent || '').replace(/\s+/g,' ').trim();
        const m = txt.match(/\[\s*Stream\s+([^\]|]+?)]/i) || txt.match(/Stream\s+([A-Za-z–ê-–Ø–∞-—è0-9 _()\-\/]+?)(?:\s|,|$)/i);
        if(m && m[1]) return m[1].trim();
        return txt.split('\n')[0].slice(0,60).trim() || '–ü—Ä–æ—á–µ–µ';
      }catch(_){ return '–ü—Ä–æ—á–µ–µ'; }
    }

    function mountDropdown(toolbar, grid){
      if(!toolbar) return null;
      if(safe$('#'+DROPDOWN_ID, toolbar)) return safe$('#'+DROPDOWN_ID, toolbar);

      const dd = document.createElement('div');
      dd.id = DROPDOWN_ID;
      dd.className = 'rr-stream-dd';
      dd.innerHTML = ''
        + '<button class="rr-dd-trigger" aria-expanded="false">'
        + '  <span>–°—Ç—Ä–∏–º—ã</span>'
        + '  <span class="rr-badge" id="rrCount_safe">0</span>'
        + '</button>'
        + '<div class="rr-dd-menu" role="menu" aria-label="–°—Ç—Ä–∏–º—ã">'
        + '  <div class="rr-dd-actions"><button class="rr-small-btn" data-act="all">–í—Å–µ</button><button class="rr-small-btn" data-act="none">–°–±—Ä–æ—Å</button></div>'
        + '  <div class="rr-dd-list"></div>'
        + '</div>';

      try{
        const plat = toolbar.querySelector('#miniPlatform');
        if(plat && plat.parentElement) plat.parentElement.insertAdjacentElement('afterend', dd);
        else toolbar.appendChild(dd);
      }catch(_){
        toolbar.appendChild(dd);
      }

      attachHandlers(dd, grid);
      refreshOptions(dd, grid);
      return dd;
    }

    function refreshOptions(dd, grid){
      if(!dd) return;
      try{
        const list = dd.querySelector('.rr-dd-list');
        const cards = collectCards(grid || (document.getElementById('miniGrid') || document.querySelector('.mini-grid') || document.querySelector('[data-mini-grid]')));
        const set = new Set();
        cards.forEach(c=>{
          try{
            const name = detectStreamFromCard(c);
            if(name) set.add(name);
            if(!c.dataset.stream) c.dataset.stream = name;
          }catch(_){}
        });
        const streams = Array.from(set).sort((a,b)=> a.localeCompare(b,'ru'));
        const saved = (localStorage.getItem(LOCAL_KEY)||'').split('|').filter(Boolean);

        if(streams.length === 0){
          list.innerHTML = '<div style="padding:8px;color:#777">–ù–µ—Ç —Å—Ç—Ä–∏–º–æ–≤</div>';
          const cnt = dd.querySelector('#rrCount_safe'); if(cnt) cnt.textContent = '0';
          return;
        }

        const html = streams.map((s,i)=> {
          const safeId = 'rr_safe_cb_' + i;
          const checkedAttr = saved.length ? (saved.indexOf(s) !== -1 ? 'checked' : '') : 'checked';
          return '<div class="rr-dd-item" data-stream="'+escapeHtml(s)+'" style="display:flex;align-items:center">'
            + '<input type="checkbox" id="'+safeId+'" value="'+escapeHtml(s)+'" '+checkedAttr+'>'
            + '<label for="'+safeId+'">'+escapeHtml(s)+'</label>'
            + '</div>';
        }).join('');
        list.innerHTML = html;
        const cnt = dd.querySelector('#rrCount_safe'); if(cnt) cnt.textContent = String(streams.length);
      }catch(e){
        console.warn('rr-safe: refreshOptions error', e && e.message);
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function attachHandlers(dd, grid){
      try{
        const btn = dd.querySelector('.rr-dd-trigger');
        const menu = dd.querySelector('.rr-dd-menu');
        const list = dd.querySelector('.rr-dd-list');
        if(!btn || !menu || !list) return;

        btn.addEventListener('click', function(e){
          try{
            const open = menu.classList.toggle('open');
            btn.setAttribute('aria-expanded', open ? 'true' : 'false');
            e.stopPropagation();
          }catch(_){}
        });

        document.addEventListener('click', function(e){
          try{
            if(!dd.contains(e.target)){
              menu.classList.remove('open');
              btn.setAttribute('aria-expanded','false');
            }
          }catch(_){}
        });

        dd.querySelectorAll('.rr-small-btn').forEach(function(b){
          b.addEventListener('click', function(e){
            try{
              const act = b.getAttribute('data-act');
              const cbs = Array.from(list.querySelectorAll('input[type=checkbox]'));
              if(act === 'all') cbs.forEach(cb=>cb.checked = true);
              else if(act === 'none') cbs.forEach(cb=>cb.checked = false);
              applyFilter(dd, grid);
              e.stopPropagation();
            }catch(_){}
          });
        });

        list.addEventListener('click', function(e){
          try{
            const t = e.target;
            if(t && t.matches && t.matches('input[type=checkbox]')){
              applyFilter(dd, grid);
            }
          }catch(_){}
        });

      }catch(e){
        console.warn('rr-safe: attachHandlers error', e && e.message);
      }
    }

    function applyFilter(dd, grid){
      try{
        const list = dd.querySelector('.rr-dd-list');
        if(!list) return;
        const cbs = Array.from(list.querySelectorAll('input[type=checkbox]'));
        const selected = cbs.filter(cb=>cb.checked).map(cb=>cb.value);
        const all = (selected.length === 0) || (selected.length === cbs.length);
        try{ localStorage.setItem(LOCAL_KEY, all ? '' : selected.join('|')); }catch(_){}
        const cards = collectCards(grid || (document.getElementById('miniGrid') || document.querySelector('.mini-grid') || document.querySelector('[data-mini-grid]')));
        cards.forEach(c=>{
          try{
            const s = c.dataset.stream || detectStreamFromCard(c);
            const ok = all || selected.indexOf(s) !== -1;
            c.classList.toggle('hide', !ok);
          }catch(_){}
        });
        const cnt = dd.querySelector('#rrCount_safe');
        if(cnt) cnt.textContent = all ? String(cbs.length) : String(selected.length);
      }catch(e){
        console.warn('rr-safe: applyFilter error', e && e.message);
      }
    }

    (function startMount(){
      let retries = 0;
      const root = document.getElementById('miniLaunchCard') || document;
      function tryOnce(){
        try{
          const {toolbar, grid} = findContext();
          if(toolbar){
            const dd = mountDropdown(toolbar, grid);
            const gridNode = grid || document.getElementById('miniGrid') || document.querySelector('.mini-grid') || document.querySelector('[data-mini-grid]');
            if(gridNode && !gridNode._rr_safe_observed){
              try{
                const mo = new MutationObserver(function(){ try{ refreshOptions(dd, gridNode); applyFilter(dd, gridNode); }catch(_){ } });
                mo.observe(gridNode, {childList:true, subtree:true});
                gridNode._rr_safe_observed = true;
              }catch(_){}
            }
            try{ applyFilter(dd, grid); }catch(_){}
            return true;
          }
        }catch(_){}
        return false;
      }

      if(tryOnce()) return;
      const iv = setInterval(function(){
        retries++;
        if(tryOnce() || retries > MAX_RETRIES){ clearInterval(iv); }
      }, RETRY_INTERVAL_MS);

      try{
        const container = document.getElementById('miniLaunchCard') || document.body;
        const mo2 = new MutationObserver(function(mutations){
          try{
            const {toolbar} = findContext();
            if(!toolbar) return;
            if(!safe$('#'+DROPDOWN_ID, toolbar)) {
              mountDropdown(toolbar, findContext().grid);
            } else {
              refreshOptions(safe$('#'+DROPDOWN_ID, toolbar), findContext().grid);
            }
          }catch(_){}
        });
        mo2.observe(container, {childList:true, subtree:true});
      }catch(_){}
    })();

  }catch(e){
    try{ console.warn('rr-safe: fatal initialization error', e && e.message); }catch(_){}
  }
})(); 
</script>
<!-- END: Safe standalone "–°—Ç—Ä–∏–º—ã" multiselect (injected by assistant) -->


</body>
</html>
