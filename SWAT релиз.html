<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>SWAT Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind CDN (–∫–∞–∫ –≤ CoreDashboard) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- SheetJS –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ .xlsx -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- style.css —Ä—è–¥–æ–º (—Ç–æ—Ç –∂–µ, —á—Ç–æ —É CoreDashboard) -->
  <link rel="stylesheet" href="./style.css" />
    <style>
      /* v1.0.27: enlarge SWAT count in Platform table header */
      .plat-swat-count{ font-size:1.2em; font-weight:600; color:#111827; }
    </style>
</head>

<body class="min-h-screen">
  <div class="max-w-[1900px] mx-auto px-4 py-6">
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <div class="brand-badge">
        <span class="brand-dot"></span>
        <div>
          <div class="flex items-center gap-2">
            <div class="font-extrabold leading-tight">SWAT Dashboard</div>
            <span class="inline-flex items-center gap-1 px-2 py-1 text-xs font-semibold rounded-full bg-white/70 ring-1 ring-[#ecebff] text-slate-600">
              <span aria-hidden="true">üè∑Ô∏è</span><span>v1.0.27</span>
            </span>
          </div>
        </div>
      </div>
    </header>

    <main class="mt-5 space-y-4">
      <!-- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã -->
      <section class="card p-5 space-y-3">
        <div>
          <h2 class="text-lg font-semibold">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞</h2>
        </div>

        <form class="w-full" onsubmit="return false;">
          <div class="border border-[#ecebff] rounded-2xl bg-white p-4">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
              <div class="md:col-span-4">
                <label class="block text-xs font-semibold text-[#111827] mb-1">–í–µ—Ä—Å–∏—è —Ä–µ–ª–∏–∑–∞</label>
                <input class="input" id="releaseVersion" type="text" inputmode="numeric" placeholder="–ù–∞–ø—Ä. 7.4.5000" />
              </div>

              <div class="md:col-span-6">
                <label class="block text-xs font-semibold text-[#111827] mb-1">Allure Api-Token</label>
                <input class="input" id="swatToken" type="password" autocomplete="off" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ Api-Token Allure TestOps" />
                <div id="swatTokenError" class="mt-1 text-xs font-semibold text-rose-600 hidden">
                  –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å ‚Äî –æ–±–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω / –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ Allure.
                </div>
              </div>

              <div class="md:col-span-2">
                <label class="block text-xs font-semibold text-[#111827] mb-1">&nbsp;</label>
                <button id="startBtn" type="button" class="btn btn-grad w-full">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–±–æ—Ä</button>
                <button id="stopBtn" type="button" class="btn btn-danger w-full hidden">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </form>
      </section>

      <!-- –¢–∞–±–ª–∏—Ü–∞ -->
      <section class="card p-5 space-y-4">
        <div class="relative flex items-center">
          <div class="min-w-[220px]">
            <h2 class="text-lg font-semibold">–¢–∞–±–ª–∏—Ü–∞ SWAT</h2>
          </div>

          <!-- tabs centered -->
          <div class="absolute left-1/2 -translate-x-1/2">
            <div class="inline-flex items-center gap-1 p-1 rounded-2xl bg-white/70 border border-[#ecebff]">
              <button id="tabEmp" class="px-3 py-1.5 text-sm font-semibold rounded-xl border border-[#ecebff]">–î–µ—Ç–∞–ª–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É</button>
              <button id="tabPlat" class="px-3 py-1.5 text-sm font-semibold rounded-xl border border-[#ecebff]">–î–µ—Ç–∞–ª–∏ –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º</button>
              <button id="tabRetry" class="px-3 py-1.5 text-sm font-semibold rounded-xl border border-[#ecebff]">–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏</button>
            </div>
          </div>

          <div class="ml-auto"></div>
        </div>

        <div id="dashContent" class="hidden">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 border border-[#ecebff] text-slate-700 text-sm font-semibold">
              SWAT: <span id="chipSwat" class="mono">‚Äî</span>
            </span>
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 border border-[#ecebff] text-slate-700 text-sm font-semibold">
              –ó–∞–ø—É—Å–∫–æ–≤: <span id="chipLaunches" class="mono">‚Äî</span>
            </span>
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 border border-[#ecebff] text-slate-700 text-sm font-semibold">
              –ö–µ–π—Å–æ–≤ –≤—Å–µ–≥–æ: <span id="chipTotalCases" class="mono">‚Äî</span>
            </span>
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 border border-[#ecebff] text-slate-700 text-sm font-semibold">
              –û–±—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –Ω–∞ 1 –∫–µ–π—Å: <span id="chipAvg" class="mono">‚Äî</span>
            </span>

            <button id="btnExportEmp" type="button" class="btn btn-grad ml-auto shadow-md ring-1 ring-[#ecebff] hidden">
              –í—ã–≥—Ä—É–∑–∏—Ç—å Excel
            </button>

            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/70 border border-[#ecebff] text-slate-600 text-sm font-semibold" id="legendEmp">
              <span class="inline-block w-3 h-3 rounded bg-emerald-300/70 ring-1 ring-emerald-200"></span> —Ä–∞–±–æ—Ç–∞–ª
              <span class="inline-block w-3 h-3 rounded bg-rose-300/70 ring-1 ring-rose-200 ml-2"></span> –Ω–µ —Ä–∞–±–æ—Ç–∞–ª
            </span>
          </div>
        </div>

        <div id="dashEmpty" class="text-slate-600">–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞</div>

        <!-- Tab 1: Employee -->
        <div id="wrapEmp" class="border border-[#ecebff] rounded-2xl bg-white/70 p-2 hidden">
          <div class="swat-table-scroll">
            <table id="tblEmp" class="swat-emp-table">
              <colgroup id="cgEmp"></colgroup>
              <thead id="thEmp"></thead>
              <tbody id="tbEmp"></tbody>
            </table>
          </div>
        </div>

        <!-- Tab 2: Platforms -->
        <div id="wrapPlat" class="border border-[#ecebff] rounded-2xl bg-white/70 p-2 hidden">
          <div class="swat-table-scroll">
            <table id="tblPlat" class="swat-fixed-table">
              <colgroup id="cgPlat"></colgroup>
              <thead id="thPlat"></thead>
              <tbody id="tbPlat"></tbody>
            </table>
          </div>
        </div>

        <!-- Tab 3: Retries -->
        <div id="wrapRetry" class="border border-[#ecebff] rounded-2xl bg-white/70 p-2 hidden">
          <div class="swat-table-scroll">
            <table id="tblRetry" class="swat-fixed-table">
              <colgroup id="cgRetry"></colgroup>
              <thead id="thRetry"></thead>
              <tbody id="tbRetry"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="swat-toast">
    <div id="toastInner"></div>
  </div>

  <!-- Popover for "–ü—Ä–æ—Ö–æ–¥–∏–ª" (–±–µ–∑ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è) -->
  <div id="pathPopover" class="swat-popover hidden" role="dialog" aria-modal="false">
    <div class="swat-popover-head">
      <div class="min-w-0">
        <div id="pathPopoverTitle" class="swat-popover-title">–ü—Ä–æ—Ö–æ–¥–∏–ª</div>
        <div id="pathPopoverSub" class="swat-popover-sub mono"></div>
      </div>
      <div class="swat-popover-actions">
        <button id="pathPopoverCopy" type="button" class="swat-popover-btn" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">‚ßâ</button>
        <button id="pathPopoverClose" type="button" class="swat-popover-btn" title="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
      </div>
    </div>
    <pre id="pathPopoverBody" class="swat-popover-body"></pre>
  </div>

  <script>
    (function(){
      // ===== Consts =====
      const ALLURE_BASE_URL = 'https://allure-testops.wb.ru';
      const PROJECT_ID = 7;

      const LS_SWAT_TOKEN = 'swat_uwu_token';
      const LS_RELEASE = 'swat_uwu_release';
      const LS_COLW = 'swat_dashboard_col_widths_v3';
      const LS_TAB = 'swat_dashboard_active_tab_v1';

      const SWAT_DAYS_URL = 'https://script.google.com/macros/s/AKfycbwr0XB69uSvHtUDczPUq96NEpSwmcSuwj_KbZ3ULcu-2mVG9MtMcdH409dD-X6ozVL_Ug/exec';

      // ===== Els =====
      const startBtn = document.getElementById('startBtn');
      const stopBtn  = document.getElementById('stopBtn');

      const inpRelease = document.getElementById('releaseVersion');
      const inpToken   = document.getElementById('swatToken');
      const tokenErrEl = document.getElementById('swatTokenError');

      const dashEmpty   = document.getElementById('dashEmpty');
      const dashContent = document.getElementById('dashContent');

      const chipSwat = document.getElementById('chipSwat');
      const chipLaunches = document.getElementById('chipLaunches');
      const chipTotalCases = document.getElementById('chipTotalCases');
      const chipAvg = document.getElementById('chipAvg');

      const btnExportEmp = document.getElementById('btnExportEmp');

      // tabs
      const tabEmp = document.getElementById('tabEmp');
      const tabPlat = document.getElementById('tabPlat');
      const tabRetry = document.getElementById('tabRetry');

      const wrapEmp = document.getElementById('wrapEmp');
      const wrapPlat = document.getElementById('wrapPlat');
      const wrapRetry = document.getElementById('wrapRetry');

      const legendEmp = document.getElementById('legendEmp');

      // tables
      const cgEmp = document.getElementById('cgEmp');
      const thEmp = document.getElementById('thEmp');
      const tbEmp = document.getElementById('tbEmp');
      const tblEmp = document.getElementById('tblEmp');

      const cgPlat = document.getElementById('cgPlat');
      const thPlat = document.getElementById('thPlat');
      const tbPlat = document.getElementById('tbPlat');

      const cgRetry = document.getElementById('cgRetry');
      const thRetry = document.getElementById('thRetry');
      const tbRetry = document.getElementById('tbRetry');

      // popover
      const pathPopover = document.getElementById('pathPopover');
      const pathPopoverClose = document.getElementById('pathPopoverClose');
      const pathPopoverCopy = document.getElementById('pathPopoverCopy');
      const pathPopoverTitle = document.getElementById('pathPopoverTitle');
      const pathPopoverSub = document.getElementById('pathPopoverSub');
      const pathPopoverBody = document.getElementById('pathPopoverBody');

      // toast
      const toastEl = document.getElementById('toast');
      const toastInner = document.getElementById('toastInner');

      // ===== State =====
      const EMP_STATE = {
        release: '',
        days: [],
        rows: [],
        overallAvgMMSS: '‚Äî',
        sortKey: 'name',
        sortDir: 1
      };

      // popover state
      let __pathPopoverOpen = false;
      let __pathPopoverLastText = '';
      let __pathPopoverAnchor = null;

      // ===== UI helpers =====
      function showToast(msg, ok=true){
        if(!toastEl || !toastInner) return;
        toastInner.textContent = msg;
        toastInner.className = 'px-4 py-2 rounded-2xl text-sm font-semibold ring-1 shadow ' + (ok
          ? 'bg-white/90 ring-[#ecebff] text-slate-700'
          : 'bg-rose-50 ring-rose-200 text-rose-700'
        );
        toastEl.classList.add('swat-toast-show');
        clearTimeout(showToast.__t);
        showToast.__t = setTimeout(() => { toastEl.classList.remove('swat-toast-show'); }, 1800);
      }

      function setHidden(el, hidden){
        if(!el) return;
        el.classList.toggle('hidden', !!hidden);
      }

      function setRunning(running){
        if(running){
          setHidden(startBtn, true);
          setHidden(stopBtn, false);
          window.__swatAbort = new AbortController();
        }else{
          setHidden(stopBtn, true);
          setHidden(startBtn, false);
          try{ window.__swatAbort?.abort(); }catch(e){}
          window.__swatAbort = null;
        }
      }

      function showDashEmpty(text){
        dashEmpty.textContent = text;
        setHidden(dashEmpty, false);
        setHidden(dashContent, true);
        setHidden(wrapEmp, true);
        setHidden(wrapPlat, true);
        setHidden(wrapRetry, true);
        setHidden(btnExportEmp, true);
      }

      function showDashContent(){
        setHidden(dashEmpty, true);
        setHidden(dashContent, false);
      }

      function clearTokenError(){ setHidden(tokenErrEl, true); }
      function showTokenError(){ setHidden(tokenErrEl, false); }

      function escapeHtml(s){
        return String(s ?? '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }

      // ===== Popover (–ü—Ä–æ—Ö–æ–¥–∏–ª) =====
      function closePathPopover(){
        if(!pathPopover) return;
        setHidden(pathPopover, true);
        __pathPopoverOpen = false;
        __pathPopoverLastText = '';
        __pathPopoverAnchor = null;
      }

      async function copyTextToClipboard(text){
        const t = String(text || '');
        if(!t) return;
        try{
          await navigator.clipboard.writeText(t);
        }catch(e){
          const ta = document.createElement('textarea');
          ta.value = t;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          ta.style.top = '0';
          document.body.appendChild(ta);
          ta.select();
          try{ document.execCommand('copy'); }catch(_e){}
          ta.remove();
        }
      }

      function positionPopoverNearAnchor(anchorEl){
        if(!pathPopover || !anchorEl) return;

        const rect = anchorEl.getBoundingClientRect();
        const popRect = pathPopover.getBoundingClientRect();

        const gap = 10;
        const vw = window.innerWidth;
        const vh = window.innerHeight;

        let left = rect.right + gap;
        let top = rect.top;

        if(left + popRect.width > vw - 8){
          left = rect.left - gap - popRect.width;
        }

        left = Math.max(8, Math.min(left, vw - popRect.width - 8));

        if(top + popRect.height > vh - 8){
          top = vh - popRect.height - 8;
        }
        top = Math.max(8, Math.min(top, vh - popRect.height - 8));

        pathPopover.style.left = `${Math.round(left)}px`;
        pathPopover.style.top  = `${Math.round(top)}px`;
      }

      function openPathPopover(anchorEl, title, sub, body){
        if(!pathPopover) return;

        pathPopoverTitle.textContent = title || '–ü—Ä–æ—Ö–æ–¥–∏–ª';
        pathPopoverSub.textContent = sub || '';
        pathPopoverBody.textContent = body || '';

        __pathPopoverLastText = body || '';
        __pathPopoverAnchor = anchorEl;

        setHidden(pathPopover, false);
        __pathPopoverOpen = true;

        requestAnimationFrame(() => positionPopoverNearAnchor(anchorEl));
      }

      pathPopoverClose?.addEventListener('click', closePathPopover);

      pathPopoverCopy?.addEventListener('click', async () => {
        await copyTextToClipboard(__pathPopoverLastText);
        showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', true);
      });

      document.addEventListener('mousedown', (e) => {
        if(!__pathPopoverOpen) return;
        const t = e.target;

        if(pathPopover && pathPopover.contains(t)) return;
        const cell = t?.closest?.('.swat-path-cell');
        if(cell) return;

        closePathPopover();
      });

      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && __pathPopoverOpen) closePathPopover();
      });

      tbEmp?.addEventListener('click', (e) => {
        const cell = e.target?.closest?.('.swat-path-cell');
        if(!cell) return;

        const title = cell.getAttribute('data-modal-title') || '–ü—Ä–æ—Ö–æ–¥–∏–ª';
        const sub = cell.getAttribute('data-modal-sub') || '';
        const body = (cell.getAttribute('data-modal-body') || '').replaceAll('&#10;', '\n');

        if(__pathPopoverOpen && __pathPopoverAnchor === cell){
          closePathPopover();
          return;
        }

        openPathPopover(cell, title, sub, body);
      });

      // ===== Storage =====
      function saveInputs(){
        try{ localStorage.setItem(LS_SWAT_TOKEN, inpToken.value || ''); }catch(e){}
        try{ localStorage.setItem(LS_RELEASE, inpRelease.value || ''); }catch(e){}
      }
      function restoreInputs(){
        try{ inpToken.value = localStorage.getItem(LS_SWAT_TOKEN) || ''; }catch(e){}
        try{ inpRelease.value = localStorage.getItem(LS_RELEASE) || ''; }catch(e){}
      }

      function loadActiveTab(){
        try{ return localStorage.getItem(LS_TAB) || 'emp'; }catch(e){ return 'emp'; }
      }
      function saveActiveTab(v){
        try{ localStorage.setItem(LS_TAB, v); }catch(e){}
      }

      // ===== Utils =====
      function allureHeaders(){
        const tok = (inpToken?.value || '').trim();
        return { 'Accept': 'application/json', 'Authorization': `Api-Token ${tok}` };
      }

      async function getJson(url, headers, signal){
        const r = await fetch(url, { headers, signal });
        if(!r.ok){
          const err = new Error(`HTTP ${r.status}`);
          err.status = r.status;
          throw err;
        }
        return r.json();
      }

      function b64Query(obj){
        const json = JSON.stringify(obj);
        const bytes = new TextEncoder().encode(json);
        let bin = '';
        for(const b of bytes) bin += String.fromCharCode(b);
        return btoa(bin);
      }

      function toInt(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }
      function toNum(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }

      function platformOfLaunchName(name){
        const s = String(name || '');
        if(s.includes('[Android]')) return 'Android';
        if(s.includes('[iOS]')) return 'iOS';
        return 'Other';
      }

      function shortStreamName(launchName){
        const name = String(launchName || '').trim();
        const m = /\[Stream\s*([^\]]+)\]/i.exec(name);
        if(m && m[1]) return m[1].trim();
        return name
          .replace(/\[High\/Blocker\]\s*/g, '')
          .replace(/\[DeployLab\]\s*/g, '')
          .replace(/\s*\[(Android|iOS)\]\s*/g, ' ')
          .trim();
      }

      function memberTotalCount(memberItem){
        let cnt = 0;
        const s = Array.isArray(memberItem?.statistic) ? memberItem.statistic : [];
        for(const it of s){
          if(!('status' in it) || it.status == null) continue;
          cnt += toInt(it.count);
        }
        return cnt;
      }

      function fmtMMSSFromMs(ms){
        const totalSec = Math.max(0, Math.round(ms / 1000));
        const mm = Math.floor(totalSec / 60);
        const ss = totalSec % 60;
        return `${mm}:${String(ss).padStart(2,'0')}`;
      }

      function fmtHoursFromMinutes(min){
        const m = Math.max(0, toNum(min));
        if(m <= 0) return '0';
        return (m / 60).toFixed(2);
      }

      // v1.0.27: display hours as HH:MM (not decimal)
      function fmtHHMMFromMinutes(min){
        const m = Math.max(0, Math.round(toNum(min)));
        const hh = Math.floor(m / 60);
        const mm = m % 60;
        return `${hh}:${String(mm).padStart(2,'0')}`;
      }

      // v1.0.27: UwU formatter (borrowed behavior from uwu_7)
      function fmtUwU(n){
        const x = toNum(n);
        if(!Number.isFinite(x) || x <= 0) return '0';
        const s = x.toFixed(2);
        return s.replace(/\.00$/, '').replace(/(\.\d)0$/, '$1');
      }

      function fmtShiftHours(h){
        const n = toNum(h);
        if(!Number.isFinite(n) || n <= 0) return '';
        const s = String(n);
        return s.endsWith('.0') ? s.slice(0, -2) : s;
      }

      function ruDowShort(dateStr){
        const [y,m,d] = String(dateStr).split('-').map(n => parseInt(n, 10));
        const dt = new Date(Date.UTC(y, (m||1)-1, d||1));
        const day = dt.getUTCDay();
        return ['–í–°','–ü–ù','–í–¢','–°–†','–ß–¢','–ü–¢','–°–ë'][day] || '‚Äî';
      }

      function ddmm(dateStr){
        const [y,m,d] = String(dateStr).split('-');
        if(!m || !d) return dateStr;
        return `${String(d).padStart(2,'0')}.${String(m).padStart(2,'0')}`;
      }

      function toMskDateKeyFromEpochMs(ms){
        const d = new Date(toInt(ms) + 3*60*60*1000);
        return d.toISOString().slice(0,10);
      }

      async function mapLimit(items, limit, fn, signal){
        const out = new Array(items.length);
        let idx = 0;
        const workers = new Array(Math.min(limit, items.length)).fill(0).map(async () => {
          while(true){
            const cur = idx++;
            if(cur >= items.length) break;
            if(signal?.aborted) throw new DOMException('Aborted', 'AbortError');
            out[cur] = await fn(items[cur], cur);
          }
        });
        await Promise.all(workers);
        return out;
      }

      // ===== Column widths (persisted) =====
      function loadColWidths(){
        try{
          const raw = localStorage.getItem(LS_COLW);
          if(!raw) return {};
          const obj = JSON.parse(raw);
          return (obj && typeof obj === 'object') ? obj : {};
        }catch(e){ return {}; }
      }
      function saveColWidths(map){
        try{ localStorage.setItem(LS_COLW, JSON.stringify(map || {})); }catch(e){}
      }

      function bindResizable(theadEl, colgroupEl){
        const handles = theadEl.querySelectorAll('.col-resize-handle');
        handles.forEach(h => {
          h.onmousedown = (ev) => {
            ev.preventDefault();
            ev.stopPropagation();

            const fullKey = h.getAttribute('data-col');
            if(!fullKey) return;

            const col = colgroupEl.querySelector(`col[data-col="${CSS.escape(fullKey)}"]`);
            if(!col) return;

            const widthsMap = loadColWidths();
            const startX = ev.clientX;

            const startW = parseInt(col.getAttribute('width') || col.width || '0', 10) || 120;
            const minW = parseInt(h.getAttribute('data-minw') || '70', 10) || 70;

            document.body.classList.add('col-resizing');

            function onMove(e2){
              const dx = e2.clientX - startX;
              const next = Math.max(minW, Math.round(startW + dx));
              col.setAttribute('width', String(next));
            }
            function onUp(){
              document.removeEventListener('mousemove', onMove);
              document.removeEventListener('mouseup', onUp);
              document.body.classList.remove('col-resizing');
              const finalW = parseInt(col.getAttribute('width') || col.width || '0', 10) || startW;
              widthsMap[fullKey] = finalW;
              saveColWidths(widthsMap);
            }

            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
          };

          h.onclick = (e) => { e.preventDefault(); e.stopPropagation(); };
        });
      }

      function applyTab(active){
        const btnBase = 'px-3 py-1.5 text-sm font-semibold rounded-xl border border-[#ecebff] transition-all';
        const on  = btnBase + ' bg-white text-slate-900 shadow-md';
        const off = btnBase + ' text-slate-700 hover:bg-white/60';

        tabEmp.className   = (active === 'emp')   ? on : off;
        tabPlat.className  = (active === 'plat')  ? on : off;
        tabRetry.className = (active === 'retry') ? on : off;

        setHidden(wrapEmp, active !== 'emp');
        setHidden(wrapPlat, active !== 'plat');
        setHidden(wrapRetry, active !== 'retry');

        setHidden(legendEmp, active !== 'emp');
        setHidden(btnExportEmp, !(active === 'emp' && EMP_STATE.rows.length));

        saveActiveTab(active);

        closePathPopover();
      }

      // ===== Sorting =====
      function normalizeStr(s){ return String(s||'').toLowerCase(); }

      function sortEmpRows(){
        const { sortKey, sortDir } = EMP_STATE;
        const dir = sortDir;

        const getVal = (r) => {
          switch(sortKey){
            case 'name': return normalizeStr(r.full_name || r.login);
            case 'target': return normalizeStr(r.targetStream || '');
            case 'uwu': return toNum(r.uwuSum || 0);
            case 'iosh': return toInt(r.iosMinutes ?? 0);
            case 'andh': return toInt(r.androidMinutes ?? 0);
            case 'iosc': return toInt(r.iosCases);
            case 'andc': return toInt(r.androidCases);
            case 'avg': return toNum(r.avgMsPerCase || 0);
            default: return normalizeStr(r.full_name || r.login);
          }
        };

        EMP_STATE.rows.sort((a,b) => {
          const av = getVal(a);
          const bv = getVal(b);

          if(typeof av === 'number' && typeof bv === 'number'){
            if(bv === av) return (normalizeStr(a.full_name||a.login)).localeCompare(normalizeStr(b.full_name||b.login),'ru');
            return (av < bv ? -1 : 1) * dir;
          }

          const c = String(av).localeCompare(String(bv), 'ru');
          if(c !== 0) return c * dir;
          return (normalizeStr(a.full_name||a.login)).localeCompare(normalizeStr(b.full_name||b.login),'ru');
        });
      }

      function setSort(key){
        if(EMP_STATE.sortKey === key){
          EMP_STATE.sortDir = EMP_STATE.sortDir === 1 ? -1 : 1;
        }else{
          EMP_STATE.sortKey = key;
          EMP_STATE.sortDir = 1;
        }
        sortEmpRows();
        renderEmployeeTable();
      }

      // ===== Data fetch =====
      async function fetchSwatDaysBundle(release, signal){
        const u = new URL(SWAT_DAYS_URL);
        u.searchParams.set('release', release);
        const r = await fetch(u.toString(), { signal });
        if(!r.ok) throw new Error(`SWAT days HTTP ${r.status}`);
        return r.json();
      }

      async function fetchLaunchesHB(version, signal){
        const terms = [
          `[High/Blocker][DeployLab] –†–µ–≥—Ä–µ—Å—Å ${version}`,
          `[High/Blocker] –†–µ–≥—Ä–µ—Å—Å ${version}`
        ];

        const uniq = new Map();
        const size = 1000;

        for(const term of terms){
          const search = b64Query([{ id:'name', type:'string', value: term }]);
          let page = 0;

          while(true){
            const url = new URL(ALLURE_BASE_URL + '/api/launch');
            url.searchParams.set('page', String(page));
            url.searchParams.set('size', String(size));
            url.searchParams.set('search', search);
            url.searchParams.set('projectId', String(PROJECT_ID));
            url.searchParams.set('preview', 'true');
            url.searchParams.set('sort', 'createdDate,desc');

            const data = await getJson(url.toString(), allureHeaders(), signal);
            const content = Array.isArray(data?.content) ? data.content : [];
            if(!content.length) break;

            for(const it of content){
              const id = toInt(it?.id);
              if(!id) continue;
              uniq.set(id, it);
            }

            if(content.length < size) break;
            page += 1;
          }
        }

        return Array.from(uniq.values());
      }

      async function fetchMemberStats(launchId, signal){
        const url = new URL(`${ALLURE_BASE_URL}/api/launch/${launchId}/memberstats`);
        url.searchParams.set('size', '1000');
        url.searchParams.set('page', '0');
        const data = await getJson(url.toString(), allureHeaders(), signal);
        if(Array.isArray(data)) return data;
        if(data && typeof data === 'object' && Array.isArray(data.content)) return data.content;
        return [];
      }

      async function fetchTimeline(launchId, signal){
        const url = new URL(`${ALLURE_BASE_URL}/api/testresult/timeline`);
        url.searchParams.set('launchId', String(launchId));
        url.searchParams.set('label', 'host, thread');
        return getJson(url.toString(), allureHeaders(), signal);
      }

      function walkTimelineGroups(node, onLeaf){
        if(!node) return;
        if(Array.isArray(node.leafs)){
          for(const leaf of node.leafs) onLeaf(leaf);
        }
        if(Array.isArray(node.groups)){
          for(const g of node.groups) walkTimelineGroups(g, onLeaf);
        }
      }

      
      // ===== UwU (borrowed from uwu_7) =====
      const UWU_PAGE_SIZE = 500;
      const uwuCache = new Map();

      async function listLeaf(launchId, signal){
        let items = [];
        let page = 0;
        while(true){
          const url = new URL(`${ALLURE_BASE_URL}/api/testresulttree/leaf`);
          url.searchParams.set('launchId', String(launchId));
          url.searchParams.set('sort', 'name,asc');
          url.searchParams.set('size', String(UWU_PAGE_SIZE));
          url.searchParams.set('page', String(page));
          const data = await getJson(url.toString(), allureHeaders(), signal);
          const content = (data && data.content) || [];
          if(!Array.isArray(content) || content.length === 0) break;
          items = items.concat(content);
          if(content.length < UWU_PAGE_SIZE) break;
          page += 1;
        }
        return items;
      }

      async function getUwU(tcid, signal){
        if(uwuCache.has(tcid)) return uwuCache.get(tcid);

        let uwuVal = null;
        let platformVal = null;

        try{
          const data = await getJson(`${ALLURE_BASE_URL}/api/testcase/${tcid}/overview`, allureHeaders(), signal);
          const fields = (data && data.customFields) || [];

          for(const cf of fields){
            const cfInfo = cf.customField || {};
            const cfName = (cfInfo.name || '').trim();

            if(cfName === 'UwU'){
              let v = cf.name;
              if(!v){
                const vals = cf.values || [];
                if(vals.length && vals[0]) v = vals[0].name;
              }
              if(v) uwuVal = String(v);
            }else if(cfName === 'Platform'){
              let p = cf.name;
              if(!p){
                const vals = cf.values || [];
                if(vals.length && vals[0]) p = vals[0].name;
              }
              if(p) platformVal = String(p);
            }
          }
        }catch(e){
          console.error('UwU fetch error for', tcid, e);
        }

        const result = { uwuRaw: uwuVal, platform: platformVal };
        uwuCache.set(tcid, result);
        return result;
      }

      function parseUwUNumber(raw){
        if(raw === null || raw === undefined) return 0;
        const s = String(raw).trim();
        if(!s || s === '0') return 0;
        const num = parseFloat(s.replace(',', '.'));
        return Number.isFinite(num) ? num : 0;
      }

// ===== Render: Employee table (#1) =====
      function renderEmployeeTable(){
        const days = EMP_STATE.days;
        const rows = EMP_STATE.rows;

        const widthsSaved = loadColWidths();

        const fixedCols = [
          { key:'name',   w: 260, min:170, title:'SWAT', sortableKey:'name', sticky:true },
          { key:'target', w: 320, min:170, title:'–¶–µ–ª–µ–≤–æ–π —Å—Ç—Ä–∏–º', sortableKey:'target' },
          { key:'path',   w: 520, min:220, title:'–ü—Ä–æ—Ö–æ–¥–∏–ª', sortableKey:null },
          { key:'iosh',   w: 150, min:120, title:'iOS (—á/–º)', sortableKey:'iosh', align:'right' },
          { key:'andh',   w: 160, min:120, title:'Android (—á/–º)', sortableKey:'andh', align:'right' },
          { key:'iosc',   w: 120, min:90,  title:'–ö–µ–π—Å—ã iOS', sortableKey:'iosc', align:'right' },
          { key:'andc',   w: 140, min:100, title:'–ö–µ–π—Å—ã Android', sortableKey:'andc', align:'right' },
          { key:'avg',    w: 160, min:120, title:'–°—Ä–µ–¥–Ω–µ–µ –∫–µ–π—Å', sortableKey:'avg', align:'right' },
          { key:'uwu',    w: 120, min:90,  title:'uWu', sortableKey:'uwu', align:'right' }
        ];
        const dayW = 110;

        cgEmp.innerHTML =
          fixedCols.map(c => {
            const fullKey = `emp:${c.key}`;
            const w = toInt(widthsSaved[fullKey]) || c.w;
            return `<col data-col="${escapeHtml(fullKey)}" width="${w}">`;
          }).join('') +
          days.map(d => {
            const fullKey = `emp:day:${d}`;
            const w = toInt(widthsSaved[fullKey]) || dayW;
            return `<col data-col="${escapeHtml(fullKey)}" width="${w}">`;
          }).join('');

        const dayHeaders = days.map((d) => {
          const fullKey = `emp:day:${d}`;
          const dow = ruDowShort(d);
          const dt = ddmm(d);
          return `
            <th class="text-center whitespace-nowrap" title="${escapeHtml(dow + ' ' + dt)}">
              <div class="th-wrap">
                <div class="th-title">
                  <div class="leading-tight">
                    <div class="font-semibold">${escapeHtml(dow)}</div>
                    <div class="text-xs text-slate-500 mono">${escapeHtml(dt)}</div>
                  </div>
                </div>
              </div>
              <div class="col-resize-handle" data-col="${escapeHtml(fullKey)}" data-minw="80"></div>
            </th>
          `;
        }).join('');

        thEmp.innerHTML = `
          <tr>
            ${fixedCols.map((c) => {
              const fullKey = `emp:${c.key}`;
              const align = c.align ? `text-${c.align}` : 'text-left';
              const sortable = c.sortableKey ? 'sortable' : '';
              const sticky = c.sticky ? 'sticky-name' : '';
              const isSorted = (EMP_STATE.sortKey === c.sortableKey);
              const ind = !c.sortableKey ? '' : (isSorted ? `<span class="sort-ind">${EMP_STATE.sortDir === 1 ? '‚ñ≤' : '‚ñº'}</span>` : `<span class="sort-ind">‚Üï</span>`);
              return `
                <th class="${align} ${sortable} ${sticky} whitespace-nowrap"
                    ${c.sortableKey ? `data-sort-key="${escapeHtml(c.sortableKey)}"` : ''}
                    title="${escapeHtml(c.title)}">
                  <div class="th-wrap">
                    <div class="th-title">${escapeHtml(c.title)}${ind}</div>
                  </div>
                  <div class="col-resize-handle" data-col="${escapeHtml(fullKey)}" data-minw="${c.min}"></div>
                </th>
              `;
            }).join('')}
            ${dayHeaders}
          </tr>
        `;

        bindResizable(thEmp, cgEmp);

        thEmp.querySelectorAll('th[data-sort-key]').forEach(th => {
          th.addEventListener('click', (ev) => {
            if(ev.target && ev.target.closest && ev.target.closest('.col-resize-handle')) return;
            const k = th.getAttribute('data-sort-key');
            if(k) setSort(k);
          });
        });

        tbEmp.innerHTML = '';
        const frag = document.createDocumentFragment();

        rows.forEach((r) => {
          const tr = document.createElement('tr');

          const displayName = r.full_name || r.login;
          const nameTitle = `${displayName} (${r.login})`;

          const targetText = r.targetStream || '‚Äî';
          const targetHtml = `<span class="cell-ellipsis" title="${escapeHtml(targetText)}">${escapeHtml(targetText)}</span>`;

          const pathText = r.allStreamsText?.length ? r.allStreamsText : '‚Äî';
          const pathTitle = r.allStreamsHover || pathText;

          const bodyAttr = escapeHtml(pathTitle).replaceAll('\n','&#10;');
          const titleAttr = `–ü—Ä–æ—Ö–æ–¥–∏–ª`;
          const subAttr = `${displayName} (${r.login})`;

          const pathHtml = `<span class="cell-ellipsis">${escapeHtml(pathText)}</span>`;

          const avgPerCase = r.avgMsPerCase > 0 ? fmtMMSSFromMs(r.avgMsPerCase) : '‚Äî';

          const dayCells = r.days.map(dc => {
            const ring = dc.worked ? 'ring-emerald-200' : 'ring-rose-200';
            const cls = dc.worked ? 'day-worked' : 'day-not-worked';
            const txt = dc.text || '';
            const title = dc.title || '';
            return `
              <td class="day-cell ${cls} text-center whitespace-nowrap ring-1 ${ring} font-semibold" title="${escapeHtml(title)}">
                <span class="cell-ellipsis">${escapeHtml(txt)}</span>
              </td>
            `;
          }).join('');

          tr.innerHTML = `
            <td class="sticky-name text-left whitespace-nowrap font-semibold" title="${escapeHtml(nameTitle)}">
              <span class="cell-ellipsis">${escapeHtml(displayName)}</span>
            </td>
            <td class="text-left">${targetHtml}</td>
            <td class="text-left swat-path-cell" data-modal-title="${escapeHtml(titleAttr)}" data-modal-sub="${escapeHtml(subAttr)}" data-modal-body="${bodyAttr}">
              ${pathHtml}
            </td>
            <td class="text-right whitespace-nowrap mono" title="${escapeHtml(r.iosHoursDec)}"><span class="cell-ellipsis">${escapeHtml(r.iosHoursDec)}</span></td>
            <td class="text-right whitespace-nowrap mono" title="${escapeHtml(r.androidHoursDec)}"><span class="cell-ellipsis">${escapeHtml(r.androidHoursDec)}</span></td>
            <td class="text-right whitespace-nowrap mono" title="${escapeHtml(String(r.iosCases || 0))}"><span class="cell-ellipsis">${escapeHtml(String(r.iosCases || 0))}</span></td>
            <td class="text-right whitespace-nowrap mono" title="${escapeHtml(String(r.androidCases || 0))}"><span class="cell-ellipsis">${escapeHtml(String(r.androidCases || 0))}</span></td>
            <td class="text-right whitespace-nowrap mono" title="${escapeHtml(avgPerCase)}"><span class="cell-ellipsis">${escapeHtml(avgPerCase)}</span></td>
            <td class="text-right whitespace-nowrap mono" title="${escapeHtml(String(r.uwuText || '0'))}"><span class="cell-ellipsis">${escapeHtml(String(r.uwuText || '0'))}</span></td>
            ${dayCells}
          `;

          frag.appendChild(tr);
        });

        tbEmp.appendChild(frag);
      }

      // ===== Render: Platform table (#2) =====
      function renderPlatformTable(platformModel){
        const { days, amountByDay, avgByDay, workersByDay, releaseAvgA, releaseAvgI, releaseAvgAll, swatCountByDay } = platformModel;

        const widthsSaved = loadColWidths();

        const cols = [
          { key:'row', w: 220, min:150 },
          ...days.map(d => ({ key:`day:${d}`, w: 96, min:85 })),
          { key:'sumA', w: 140, min:110 },
          { key:'sumI', w: 140, min:110 }
        ];

        cgPlat.innerHTML = cols.map(c => {
          const fullKey = `plat:${c.key}`;
          const w = toInt(widthsSaved[fullKey]) || c.w;
          return `<col data-col="${escapeHtml(fullKey)}" width="${w}">`;
        }).join('');

        const dayHeaders = days.map(d => {
          const dow = ruDowShort(d);
          const dt = ddmm(d);
          const cnt = toInt(swatCountByDay?.[d] || 0);
          const fullKey = `plat:day:${d}`;
          const top = `${dow}`;
          const bottom = `${dt}`;
          const bottomHtml = `${escapeHtml(dt)} (<span class="plat-swat-count">${escapeHtml(String(cnt))}</span>)`;
          return `
            <th class="text-center whitespace-nowrap" title="${escapeHtml(dow + ' ' + dt + ' (' + cnt + ')')}">
              <div class="th-wrap">
                <div class="th-title">
                  <div class="leading-tight">
                    <div class="font-semibold">${escapeHtml(top)}</div>
                    <div class="text-xs text-slate-500 mono">${bottomHtml}</div>
                  </div>
                </div>
              </div>
              <div class="col-resize-handle" data-col="${escapeHtml(fullKey)}" data-minw="80"></div>
            </th>
          `;
        }).join('');

        thPlat.innerHTML = `
          <tr>
            <th class="text-left whitespace-nowrap" title="–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ / –º–µ—Ç—Ä–∏–∫–∞">
              <div class="th-wrap"><div class="th-title"> </div></div>
              <div class="col-resize-handle" data-col="plat:row" data-minw="150"></div>
            </th>
            ${dayHeaders}
            <th class="text-center whitespace-nowrap" title="–°—Ä–µ–¥–Ω–µ–µ Android –∑–∞ —Ä–µ–ª–∏–∑">
              <div class="th-wrap"><div class="th-title">Android –æ–±—â–µ–µ</div></div>
              <div class="col-resize-handle" data-col="plat:sumA" data-minw="110"></div>
            </th>
            <th class="text-center whitespace-nowrap" title="–°—Ä–µ–¥–Ω–µ–µ iOS –∑–∞ —Ä–µ–ª–∏–∑">
              <div class="th-wrap"><div class="th-title">iOS –æ–±—â–µ–µ</div></div>
              <div class="col-resize-handle" data-col="plat:sumI" data-minw="110"></div>
            </th>
          </tr>
        `;

        bindResizable(thPlat, cgPlat);

        function cell(txt, title){
          const s = (txt === null || txt === undefined) ? '' : String(txt);
          return `<td class="text-center whitespace-nowrap mono" title="${escapeHtml(title || s)}"><span class="cell-ellipsis">${escapeHtml(s)}</span></td>`;
        }

        const aRel = releaseAvgA.toFixed(2);
        const iRel = releaseAvgI.toFixed(2);
        const allRel = releaseAvgAll.toFixed(2);

        const androidAmounts = days.map(d => toInt(amountByDay[d]?.Android || 0));
        const iosAmounts = days.map(d => toInt(amountByDay[d]?.iOS || 0));
        const allAmounts = days.map(d => toInt(amountByDay[d]?.All || 0));

        const androidAvg = days.map(d => toNum(avgByDay[d]?.Android || 0));
        const iosAvg = days.map(d => toNum(avgByDay[d]?.iOS || 0));
        const allAvg = days.map(d => toNum(avgByDay[d]?.All || 0));

        tbPlat.innerHTML = `
          <tr>
            <td class="text-left font-semibold">Android</td>
            ${androidAmounts.map((v, idx) => {
              const d = days[idx];
              const w = toInt(workersByDay[d]?.Android || 0);
              return cell(v, `–ö–µ–π—Å–æ–≤: ${v}\n–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${w}`);
            }).join('')}
            ${cell(aRel, `–°—Ä–µ–¥–Ω–µ–µ Android –∑–∞ —Ä–µ–ª–∏–∑: ${aRel}`)}
            ${cell('', '')}
          </tr>
          <tr>
            <td class="text-left font-semibold">iOS</td>
            ${iosAmounts.map((v, idx) => {
              const d = days[idx];
              const w = toInt(workersByDay[d]?.iOS || 0);
              return cell(v, `–ö–µ–π—Å–æ–≤: ${v}\n–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${w}`);
            }).join('')}
            ${cell('', '')}
            ${cell(iRel, `–°—Ä–µ–¥–Ω–µ–µ iOS –∑–∞ —Ä–µ–ª–∏–∑: ${iRel}`)}
          </tr>
          <tr>
            <td class="text-left font-semibold">–û–±—â–µ–µ</td>
            ${allAmounts.map((v, idx) => {
              const d = days[idx];
              const w = toInt(workersByDay[d]?.All || 0);
              return cell(v, `–ö–µ–π—Å–æ–≤: ${v}\n–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${w}`);
            }).join('')}
            ${cell('', '')}
            ${cell('', '')}
          </tr>

          <tr>
            <td class="text-left font-semibold">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ —Å–≤–∞—Ç–∞ Android</td>
            ${androidAvg.map((v, idx) => {
              const d = days[idx];
              const w = toInt(workersByDay[d]?.Android || 0);
              const val = v.toFixed(2);
              return cell(val, `–°—Ä–µ–¥–Ω–µ–µ: ${val}\n–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${w}`);
            }).join('')}
            ${cell(aRel, `–°—Ä–µ–¥–Ω–µ–µ Android –∑–∞ —Ä–µ–ª–∏–∑: ${aRel}`)}
            ${cell('', '')}
          </tr>
          <tr>
            <td class="text-left font-semibold">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞ —Å–≤–∞—Ç–∞ iOS</td>
            ${iosAvg.map((v, idx) => {
              const d = days[idx];
              const w = toInt(workersByDay[d]?.iOS || 0);
              const val = v.toFixed(2);
              return cell(val, `–°—Ä–µ–¥–Ω–µ–µ: ${val}\n–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${w}`);
            }).join('')}
            ${cell('', '')}
            ${cell(iRel, `–°—Ä–µ–¥–Ω–µ–µ iOS –∑–∞ —Ä–µ–ª–∏–∑: ${iRel}`)}
          </tr>
          <tr>
            <td class="text-left font-semibold">–°—Ä–µ–¥–Ω–µ–µ –æ–±—â–µ–µ</td>
            ${allAvg.map((v, idx) => {
              const d = days[idx];
              const w = toInt(workersByDay[d]?.All || 0);
              const val = v.toFixed(2);
              return cell(val, `–°—Ä–µ–¥–Ω–µ–µ: ${val}\n–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${w}`);
            }).join('')}
            ${cell('', '')}
            ${cell('', '')}
          </tr>

          <tr>
            <td class="text-left font-semibold">–°—Ä–µ–¥–Ω–µ–µ –∑–∞ —Ä–µ–ª–∏–∑</td>
            ${days.map((d, idx) => idx === 0 ? cell(allRel, `–°—Ä–µ–¥–Ω–µ–µ –∑–∞ —Ä–µ–ª–∏–∑: ${allRel}`) : cell('', '')).join('')}
            ${cell('', '')}
            ${cell('', '')}
          </tr>
        `;
      }

      // ===== Render: Retries table (#3) =====
      function renderRetryTable(retryModel){
        const { rows } = retryModel;
        const widthsSaved = loadColWidths();

        const cols = [
          { key:'name', w: 240, min:160, label:'–°–æ—Ç—Ä—É–¥–Ω–∏–∫' },
          { key:'stream', w: 320, min:180, label:'–°—Ç—Ä–∏–º' },
          { key:'ios', w: 140, min:110, label:'iOS' },
          { key:'and', w: 140, min:110, label:'Android' },
        ];

        cgRetry.innerHTML = cols.map(c => {
          const fullKey = `retry:${c.key}`;
          const w = toInt(widthsSaved[fullKey]) || c.w;
          return `<col data-col="${escapeHtml(fullKey)}" width="${w}">`;
        }).join('');

        thRetry.innerHTML = `
          <tr>
            ${cols.map(c => {
              const fullKey = `retry:${c.key}`;
              const align = (c.key==='ios'||c.key==='and') ? 'text-right' : 'text-left';
              return `
                <th class="${align} whitespace-nowrap" title="${escapeHtml(c.label)}">
                  <div class="th-wrap"><div class="th-title">${escapeHtml(c.label)}</div></div>
                  <div class="col-resize-handle" data-col="${escapeHtml(fullKey)}" data-minw="${c.min}"></div>
                </th>
              `;
            }).join('')}
          </tr>
        `;

        bindResizable(thRetry, cgRetry);

        if(!rows.length){
          tbRetry.innerHTML = `<tr><td class="text-left text-slate-500" colspan="4">–ù–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ (retriedCount = 0)</td></tr>`;
          return;
        }

        tbRetry.innerHTML = rows.map(r => {
          const disp = r.full_name || r.login;
          const title = `${disp} (${r.login})`;
          return `
            <tr>
              <td class="text-left font-semibold" title="${escapeHtml(title)}"><span class="cell-ellipsis">${escapeHtml(disp)}</span></td>
              <td class="text-left" title="${escapeHtml(r.stream)}"><span class="cell-ellipsis">${escapeHtml(r.stream)}</span></td>
              <td class="text-right mono" title="${escapeHtml(String(r.ios))}"><span class="cell-ellipsis">${escapeHtml(String(r.ios))}</span></td>
              <td class="text-right mono" title="${escapeHtml(String(r.android))}"><span class="cell-ellipsis">${escapeHtml(String(r.android))}</span></td>
            </tr>
          `;
        }).join('');
      }

      // ===== Export to Excel (–ù–æ—Ä–º–∞–ª—å–Ω—ã–π .xlsx —á–µ—Ä–µ–∑ SheetJS) =====
      function exportEmployeeTableToXls(){
        if(typeof XLSX === 'undefined' || !XLSX?.utils){
          showToast('–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ XLSX', false);
          return;
        }

        const days = EMP_STATE.days || [];
        const rows = EMP_STATE.rows || [];
        if(!rows.length){
          showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏', false);
          return;
        }

        const headers = [
          'SWAT',
          'uWu',
          '–¶–µ–ª–µ–≤–æ–π —Å—Ç—Ä–∏–º',
          '–ü—Ä–æ—Ö–æ–¥–∏–ª',
          'iOS (—á/–º)',
          'Android (—á/–º)',
          '–ö–µ–π—Å—ã iOS',
          '–ö–µ–π—Å—ã Android',
          '–°—Ä–µ–¥–Ω–µ–µ –∫–µ–π—Å',
          ...days.map(d => `${ruDowShort(d)} ${ddmm(d)}`)
        ];

        const colCount = headers.length;

        // AOA (–≤—Å—ë –∫–∞–∫ —Ç–µ–∫—Å—Ç)
        const aoa = [];
        aoa.push([`–û–±—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ –Ω–∞ 1 –∫–µ–π—Å: ${EMP_STATE.overallAvgMMSS || '‚Äî'}`]);
        aoa.push([]);
        aoa.push(headers);

        for(const r of rows){
          const avg = (r.avgMsPerCase > 0) ? fmtMMSSFromMs(r.avgMsPerCase) : '‚Äî';
          const name = (r.full_name || r.login || '');
          const target = (r.targetStream || '‚Äî');
          const path = (r.allStreamsText || '‚Äî');

          aoa.push([
            String(name),
            String(r.uwuText || '0'),
            String(target),
            String(path),
            String(r.iosHoursDec ?? ''),
            String(r.androidHoursDec ?? ''),
            String(r.iosCases ?? 0),
            String(r.androidCases ?? 0),
            String(avg),
            ...((r.days || []).map(dc => String(dc?.text || '')))
          ]);
        }

        const ws = XLSX.utils.aoa_to_sheet(aoa);

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —è—á–µ–µ–∫
        const range = XLSX.utils.decode_range(ws['!ref'] || 'A1:A1');
        for(let R = range.s.r; R <= range.e.r; ++R){
          for(let C = range.s.c; C <= range.e.c; ++C){
            const addr = XLSX.utils.encode_cell({ r:R, c:C });
            const cell = ws[addr];
            if(!cell) continue;
            cell.t = 's';
          }
        }

        // –ú—ë—Ä–¥–∂–∏ –¥–ª—è –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ (–∫–∞–∫ —à–∞–ø–∫–∞) + –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
        ws['!merges'] = [
          { s:{ r:0, c:0 }, e:{ r:0, c:colCount-1 } },
          { s:{ r:1, c:0 }, e:{ r:1, c:colCount-1 } }
        ];

        // –ü—Ä–∏–∫–∏–¥–∫–∞ —à–∏—Ä–∏–Ω –∫–æ–ª–æ–Ω–æ–∫ (–ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω–µ)
        const maxLen = new Array(colCount).fill(10);
        for(let r = 0; r < aoa.length; r++){
          for(let c = 0; c < colCount; c++){
            const v = (aoa[r] && aoa[r][c] != null) ? String(aoa[r][c]) : '';
            maxLen[c] = Math.max(maxLen[c], Math.min(60, Math.ceil(v.length * 1.05)));
          }
        }
        ws['!cols'] = maxLen.map(wch => ({ wch }));

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'SWAT');

        const rel = (EMP_STATE.release || inpRelease.value || 'release').replaceAll(' ', '_');
        const filename = `SWAT_${rel}_employees.xlsx`;

        XLSX.writeFile(wb, filename, { compression: true });
      }

      // ===== Run =====
      async function run(){
        clearTokenError();
        saveInputs();

        const tok = (inpToken.value || '').trim();
        if(!tok){ showDashEmpty('–í—Å—Ç–∞–≤—å—Ç–µ Allure Api-Token'); return; }

        const release = (inpRelease.value || '').trim();
        if(!release){ showDashEmpty('–£–∫–∞–∂–∏—Ç–µ –≤–µ—Ä—Å–∏—é —Ä–µ–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 7.4.5000)'); return; }

        const signal = window.__swatAbort?.signal;

        showDashContent();
        applyTab(loadActiveTab());

        tbEmp.innerHTML = `<tr><td class="text-left" colspan="99">–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö‚Ä¶</td></tr>`;
        tbPlat.innerHTML = `<tr><td class="text-left" colspan="99">–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö‚Ä¶</td></tr>`;
        tbRetry.innerHTML = `<tr><td class="text-left" colspan="99">–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö‚Ä¶</td></tr>`;

        // ===== 1) SWAT + worked_days =====
        tbEmp.innerHTML = `<tr><td class="text-left" colspan="99">[–®–∞–≥ 1/4] –ü–æ–ª—É—á–∞—é SWAT –∏ worked_days‚Ä¶</td></tr>`;
        const swatBundle = await fetchSwatDaysBundle(release, signal);

        const rawList = Array.isArray(swatBundle?.worked_SWAT?.login) ? swatBundle.worked_SWAT.login : [];
        const swatEntries = rawList.map(it => {
          if(!it || typeof it !== 'object') return null;
          const login = String(it.login || '').trim().toLowerCase();
          if(!login) return null;
          return {
            login,
            full_name: String(it.full_name || '').trim() || login,
            targetStream: String(it.stream || '').trim() || ''
          };
        }).filter(Boolean);

        swatEntries.sort((a,b) => {
          const an = String(a.full_name||a.login||'');
          const bn = String(b.full_name||b.login||'');
          const c = an.localeCompare(bn, 'ru');
          if(c !== 0) return c;
          return String(a.login).localeCompare(String(b.login), 'ru');
        });

        if(!swatEntries.length){
          showDashEmpty('SWAT —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π.');
          return;
        }

        const swatLogins = swatEntries.map(x => x.login);
        const swatSet = new Set(swatLogins);

        const fullNameByLogin = Object.fromEntries(swatEntries.map(x => [x.login, x.full_name || x.login]));
        const targetStreamByLogin = Object.fromEntries(swatEntries.map(x => [x.login, x.targetStream || '']));

        const workedDays = (swatBundle && typeof swatBundle === 'object' && swatBundle.worked_days && typeof swatBundle.worked_days === 'object')
          ? swatBundle.worked_days
          : {};

        const days = Object.keys(workedDays).sort();
        const presenceByDay = {};
        const shiftHoursByDay = {};
        const swatCountByDay = {};

        for(const d of days){
          const map = workedDays?.[d]?.login && typeof workedDays[d].login === 'object' ? workedDays[d].login : {};
          const set = new Set();
          const sh = {};
          for(const [login, val] of Object.entries(map)){
            const l = String(login||'').trim().toLowerCase();
            if(!l) continue;
            set.add(l);
            sh[l] = toNum(val);
          }
          presenceByDay[d] = set;
          shiftHoursByDay[d] = sh;
          swatCountByDay[d] = set.size;
        }

        // ===== 2) –ó–∞–ø—É—Å–∫–∏ Allure =====
        tbEmp.innerHTML = `<tr><td class="text-left" colspan="99">[–®–∞–≥ 2/4] –ò—â—É High/Blocker –∑–∞–ø—É—Å–∫–∏‚Ä¶</td></tr>`;
        let launches = [];
        try{
          launches = await fetchLaunchesHB(release, signal);
        }catch(e){
          showTokenError();
          throw e;
        }
        if(!launches.length){
          showDashEmpty('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø—É—Å–∫–æ–≤ High/Blocker –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ–ª–∏–∑–∞.');
          return;
        }

        // ===== 3) memberstats =====
        tbEmp.innerHTML = `<tr><td class="text-left" colspan="99">[–®–∞–≥ 3/4] –°—á–∏—Ç–∞—é memberstats‚Ä¶</td></tr>`;

        const perUser = {};
        const perUserRetries = {};

        const globalStreamAgg = {};
        function ensureGlobal(stream){
          if(globalStreamAgg[stream]) return globalStreamAgg[stream];
          globalStreamAgg[stream] = {
            iOS: { total:0 },
            Android: { total:0 }
          };
          return globalStreamAgg[stream];
        }

        function ensureUser(login){
          if(perUser[login]) return perUser[login];
          perUser[login] = {
            login,
            iosDurMs: 0, androidDurMs: 0,
            iosCases: 0, androidCases: 0,
            streams: {},
            uwuSum: 0
          };
          return perUser[login];
        }

        function ensureStream(u, stream){
          if(u.streams[stream]) return u.streams[stream];
          u.streams[stream] = {
            iosDurMs: 0, androidDurMs: 0,
            iosCases: 0, androidCases: 0
          };
          return u.streams[stream];
        }

        function addRetry(login, stream, plat, cnt){
          if(!perUserRetries[login]) perUserRetries[login] = {};
          if(!perUserRetries[login][stream]) perUserRetries[login][stream] = { iOS:0, Android:0 };
          if(plat === 'iOS') perUserRetries[login][stream].iOS += cnt;
          if(plat === 'Android') perUserRetries[login][stream].Android += cnt;
        }

        let totalCasesAllAssignees = 0;

        await mapLimit(launches, 6, async (L, idx) => {
          if(signal?.aborted) throw new DOMException('Aborted','AbortError');

          const lid = toInt(L?.id);
          const name = String(L?.name||'');
          const plat = platformOfLaunchName(name);
          const stream = shortStreamName(name);

          if(idx % 6 === 0){
            tbEmp.innerHTML = `<tr><td class="text-left" colspan="99">[–®–∞–≥ 3/4] memberstats‚Ä¶ ${idx}/${launches.length}</td></tr>`;
          }

          const ms = await fetchMemberStats(lid, signal);

          for(const m of ms){
            const assignee = String(m?.assignee||'').trim().toLowerCase();
            if(!assignee) continue;

            const totalCases = memberTotalCount(m);
            const durMs = toInt(m?.durationSum);
            const retried = toInt(m?.retriedCount);

            totalCasesAllAssignees += totalCases;

            if(plat === 'iOS' || plat === 'Android'){
              const g = ensureGlobal(stream);
              g[plat].total += totalCases;
            }

            if(!swatSet.has(assignee)) continue;

            const u = ensureUser(assignee);
            const st = ensureStream(u, stream);

            if(plat === 'iOS'){
              u.iosCases += totalCases;
              u.iosDurMs += durMs;
              st.iosCases += totalCases;
              st.iosDurMs += durMs;
              if(retried) addRetry(assignee, stream, 'iOS', retried);
            }else if(plat === 'Android'){
              u.androidCases += totalCases;
              u.androidDurMs += durMs;
              st.androidCases += totalCases;
              st.androidDurMs += durMs;
              if(retried) addRetry(assignee, stream, 'Android', retried);
            }
          }
        }, signal);

        let totalDurMsAll = 0;
        let totalCasesAll = 0;
        for(const login of swatLogins){
          const u = perUser[login];
          if(!u) continue;
          totalDurMsAll += (u.iosDurMs + u.androidDurMs);
          totalCasesAll += (u.iosCases + u.androidCases);
        }
        const overallAvgMsPerCase = totalCasesAll > 0 ? (totalDurMsAll / totalCasesAll) : 0;
        const overallAvgMMSS = overallAvgMsPerCase > 0 ? fmtMMSSFromMs(overallAvgMsPerCase) : '‚Äî';

        
        // ===== 3.5) UwU (borrowed from uwu_7) =====
        tbEmp.innerHTML = `<tr><td class="text-left" colspan="99">[–®–∞–≥ 3/4] –°–æ–±–∏—Ä–∞—é UwU‚Ä¶</td></tr>`;

        const leafPairs = [];
        await mapLimit(launches, 4, async (L, idx) => {
          if(signal?.aborted) throw new DOMException('Aborted','AbortError');

          const lid = toInt(L?.id);

          if(idx % 4 === 0){
            tbEmp.innerHTML = `<tr><td class="text-left" colspan="99">[–®–∞–≥ 3/4] UwU‚Ä¶ ${idx}/${launches.length}</td></tr>`;
          }

          const items = await listLeaf(lid, signal);
          for(const it of items){
            const testedBy = String(it?.testedBy || '').trim().toLowerCase();
            if(!testedBy || !swatSet.has(testedBy)) continue;
            const tcid = toInt(it?.testCaseId);
            if(!tcid) continue;
            leafPairs.push({ login: testedBy, tcid });
          }
        }, signal);

        const uniqTcids = Array.from(new Set(leafPairs.map(x => x.tcid)));
        await mapLimit(uniqTcids, 16, async (tcid, idx) => {
          if(signal?.aborted) throw new DOMException('Aborted','AbortError');
          if(idx % 200 === 0){
            tbEmp.innerHTML = `<tr><td class="text-left" colspan="99">[–®–∞–≥ 3/4] UwU‚Ä¶ testcase ${idx}/${uniqTcids.length}</td></tr>`;
          }
          await getUwU(tcid, signal);
        }, signal);

        for(const p of leafPairs){
          const uwuRaw = uwuCache.get(p.tcid)?.uwuRaw;
          const uwuNum = parseUwUNumber(uwuRaw);
          const u = ensureUser(p.login);
          u.uwuSum = (toNum(u.uwuSum) || 0) + uwuNum;
        }

// ===== 4) timeline =====
        tbEmp.innerHTML = `<tr><td class="text-left" colspan="99">[–®–∞–≥ 4/4] –°—á–∏—Ç–∞—é –≤—Ä–µ–º—è/–∫–µ–π—Å—ã –ø–æ –¥–Ω—è–º‚Ä¶</td></tr>`;

        const durByUserDay = {};
        function addDur(login, day, ms){
          if(!durByUserDay[login]) durByUserDay[login] = {};
          durByUserDay[login][day] = (durByUserDay[login][day] || 0) + ms;
        }

        const casesByDayPlatform = {};
        const usersByDayPlatform = {};

        function ensureDayPlatform(day){
          if(!casesByDayPlatform[day]) casesByDayPlatform[day] = { Android:0, iOS:0 };
          if(!usersByDayPlatform[day]) usersByDayPlatform[day] = { Android:new Set(), iOS:new Set() };
        }

        await mapLimit(launches, 4, async (L, idx) => {
          if(signal?.aborted) throw new DOMException('Aborted','AbortError');

          const lid = toInt(L?.id);
          const name = String(L?.name||'');
          const plat = platformOfLaunchName(name);

          if(idx % 4 === 0){
            tbEmp.innerHTML = `<tr><td class="text-left" colspan="99">[–®–∞–≥ 4/4] timeline‚Ä¶ ${idx}/${launches.length}</td></tr>`;
          }

          const tl = await fetchTimeline(lid, signal);
          const rootGroups = Array.isArray(tl?.groups) ? tl.groups : [];

          for(const g of rootGroups){
            walkTimelineGroups(g, (leaf) => {
              const testedBy = String(leaf?.testedBy || '').trim().toLowerCase();
              if(!testedBy || !swatSet.has(testedBy)) return;

              const start = toInt(leaf?.start);
              const stop  = ('stop' in leaf) ? toInt(leaf?.stop) : (start + toInt(leaf?.duration));
              const dur = Math.max(0, stop - start);

              const dayKey = toMskDateKeyFromEpochMs(start);

              addDur(testedBy, dayKey, dur);

              if(plat === 'Android' || plat === 'iOS'){
                ensureDayPlatform(dayKey);
                casesByDayPlatform[dayKey][plat] += 1;
                usersByDayPlatform[dayKey][plat].add(testedBy);
              }
            });
          }
        }, signal);

        const rowsEmp = [];

        for(const login of swatLogins){
          const u = perUser[login] || { login, iosDurMs:0, androidDurMs:0, iosCases:0, androidCases:0, streams:{}, uwuSum:0 };

          const iosMinutes = Math.round(u.iosDurMs / 60000);
          const androidMinutes = Math.round(u.androidDurMs / 60000);

          const iosHoursDec = fmtHHMMFromMinutes(iosMinutes);
          const androidHoursDec = fmtHHMMFromMinutes(androidMinutes);

          let primaryStream = '';
          let primaryTotalCases = -1;

          const streamEntries = Object.entries(u.streams || {});
          for(const [streamName, st] of streamEntries){
            const totalCases = toInt(st.iosCases) + toInt(st.androidCases);
            if(totalCases > primaryTotalCases){
              primaryTotalCases = totalCases;
              primaryStream = streamName;
            }
          }

          const orderedStreams = [];
          if(primaryStream) orderedStreams.push(primaryStream);

          streamEntries
            .filter(([s]) => s && s !== primaryStream)
            .sort((a,b) => {
              const A = a[1] || {};
              const B = b[1] || {};
              const ai = Math.round(toInt(A.iosDurMs) / 60000);
              const bi = Math.round(toInt(B.iosDurMs) / 60000);
              if(bi !== ai) return bi - ai;
              const at = Math.round((toInt(A.iosDurMs)+toInt(A.androidDurMs)) / 60000);
              const bt = Math.round((toInt(B.iosDurMs)+toInt(B.androidDurMs)) / 60000);
              return bt - at;
            })
            .forEach(([s]) => orderedStreams.push(s));

          const allStreamsText = orderedStreams.length ? orderedStreams.join(' + ') : '‚Äî';

          const hoverLines = [];
          for(const s of orderedStreams){
            const st = (u.streams && u.streams[s]) ? u.streams[s] : {};
            const g = globalStreamAgg[s] || { iOS:{total:0}, Android:{total:0} };

            const iosEmp = toInt(st.iosCases);
            const andEmp = toInt(st.androidCases);

            const iosTotalAll = toInt(g.iOS?.total);
            const andTotalAll = toInt(g.Android?.total);

            const parts = [];
            if(iosEmp > 0) parts.push(`iOS ${iosEmp}/${iosTotalAll}`);
            if(andEmp > 0) parts.push(`Android ${andEmp}/${andTotalAll}`);

            if(!parts.length) continue;
            hoverLines.push(`${s} ‚Äî ${parts.join(', ')}`);
          }
          const allStreamsHover = hoverLines.length ? hoverLines.join('\n') : allStreamsText;

          const totalCases = toInt(u.iosCases) + toInt(u.androidCases);
          const totalDurMs = toInt(u.iosDurMs) + toInt(u.androidDurMs);
          const avgMsPerCase = totalCases > 0 ? (totalDurMs / totalCases) : 0;

          const dayCells = days.map(d => {
            const workedFromShift = !!presenceByDay?.[d]?.has(login);
            const shiftHours = toNum(shiftHoursByDay?.[d]?.[login] || 0);

            const ms = toInt(durByUserDay?.[login]?.[d] || 0);
            const minFromTimeline = Math.round(ms / 60000);
            const allureHours = fmtHHMMFromMinutes(minFromTimeline);

            const worked = workedFromShift || shiftHours > 0 || minFromTimeline > 0;

            let text = '';
            let title = '';

            const shTxt = fmtShiftHours(shiftHours);
            if(minFromTimeline > 0){
              text = shTxt ? `${allureHours} (${shTxt})` : `${allureHours}`;
              title = shTxt
                ? `Allure: ${allureHours}—á, –°–º–µ–Ω–∞: ${shTxt}—á`
                : `Allure: ${allureHours}—á`;
            }else if(shTxt){
              text = `0:00 (${shTxt})`;
              title = `Allure: 0:00—á, –°–º–µ–Ω–∞: ${shTxt}—á`;
            }else{
              text = '';
              title = worked ? 'worked_days: –µ—Å—Ç—å, –Ω–æ —Ç–∞–π–º–∏–Ω–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω' : '–Ω–µ —Ä–∞–±–æ—Ç–∞–ª';
            }

            return { worked, text, title };
          });

          rowsEmp.push({
            login,
            full_name: fullNameByLogin[login] || login,
            targetStream: targetStreamByLogin[login] || '',
            allStreamsText,
            allStreamsHover,
            uwuSum: toNum(u.uwuSum || 0),
            uwuText: fmtUwU(u.uwuSum || 0),
            iosMinutes,
            androidMinutes,
            iosHoursDec,
            androidHoursDec,
            iosCases: toInt(u.iosCases),
            androidCases: toInt(u.androidCases),
            avgMsPerCase,
            days: dayCells
          });
        }

        const rowsRetry = [];
        for(const login of swatLogins){
          const byStream = perUserRetries[login] || {};
          for(const [stream, v] of Object.entries(byStream)){
            const ios = toInt(v?.iOS);
            const android = toInt(v?.Android);
            if((ios + android) <= 0) continue;
            rowsRetry.push({
              login,
              full_name: fullNameByLogin[login] || login,
              stream,
              ios,
              android
            });
          }
        }
        rowsRetry.sort((a,b) => {
          const an = String(a.full_name||a.login||'');
          const bn = String(b.full_name||b.login||'');
          const c = an.localeCompare(bn, 'ru');
          if(c !== 0) return c;
          const cs = String(a.stream||'').localeCompare(String(b.stream||''), 'ru');
          if(cs !== 0) return cs;
          return String(a.login).localeCompare(String(b.login), 'ru');
        });

        const amountByDay = {};
        const avgByDay = {};
        const workersByDay = {};
        const dailyAllAvg = [];

        for(const d of days){
          ensureDayPlatform(d);

          const aCases = toInt(casesByDayPlatform[d]?.Android || 0);
          const iCases = toInt(casesByDayPlatform[d]?.iOS || 0);

          const aSet = usersByDayPlatform[d]?.Android ? usersByDayPlatform[d].Android : new Set();
          const iSet = usersByDayPlatform[d]?.iOS ? usersByDayPlatform[d].iOS : new Set();

          const aWorkers = aSet.size || 0;
          const iWorkers = iSet.size || 0;

          const union = new Set();
          for(const x of aSet) union.add(x);
          for(const x of iSet) union.add(x);
          const allWorkers = union.size || 0;

          const aAvg = aWorkers > 0 ? (aCases / aWorkers) : 0;
          const iAvg = iWorkers > 0 ? (iCases / iWorkers) : 0;
          const allAvg = aAvg + iAvg;

          amountByDay[d] = { Android: aCases, iOS: iCases, All: aCases + iCases };
          avgByDay[d] = { Android: aAvg, iOS: iAvg, All: allAvg };
          workersByDay[d] = { Android: aWorkers, iOS: iWorkers, All: allWorkers };

          dailyAllAvg.push(allAvg);
        }

        const releaseAvgAll = dailyAllAvg.length ? (dailyAllAvg.reduce((s,n)=>s+n,0) / dailyAllAvg.length) : 0;

        let totalACases = 0, totalICases = 0, totalAWorkers = 0, totalIWorkers = 0;
        for(const d of days){
          totalACases += toInt(amountByDay[d]?.Android || 0);
          totalICases += toInt(amountByDay[d]?.iOS || 0);
          totalAWorkers += toInt(workersByDay[d]?.Android || 0);
          totalIWorkers += toInt(workersByDay[d]?.iOS || 0);
        }
        const releaseAvgA = totalAWorkers > 0 ? (totalACases / totalAWorkers) : 0;
        const releaseAvgI = totalIWorkers > 0 ? (totalICases / totalIWorkers) : 0;

        EMP_STATE.release = release;
        EMP_STATE.days = days;
        EMP_STATE.rows = rowsEmp;
        EMP_STATE.overallAvgMMSS = overallAvgMMSS;

        EMP_STATE.sortKey = EMP_STATE.sortKey || 'name';
        EMP_STATE.sortDir = EMP_STATE.sortDir || 1;

        sortEmpRows();

        chipSwat.textContent = String(swatEntries.length || 0);
        chipLaunches.textContent = String(launches.length || 0);
        chipTotalCases.textContent = String(totalCasesAllAssignees || 0);
        chipAvg.textContent = overallAvgMMSS || '‚Äî';

        renderEmployeeTable();

        renderPlatformTable({
          days,
          amountByDay,
          avgByDay,
          workersByDay,
          releaseAvgA,
          releaseAvgI,
          releaseAvgAll,
          swatCountByDay
        });

        renderRetryTable({ rows: rowsRetry });

        showDashContent();
        applyTab(loadActiveTab());

        showToast(`–ì–æ—Ç–æ–≤–æ: SWAT ${swatEntries.length}, –∑–∞–ø—É—Å–∫–æ–≤ ${launches.length}`, true);
      }

      // ===== Events =====
      startBtn?.addEventListener('click', async () => {
        setRunning(true);
        try{
          await run();
        }catch(e){
          if(e && (e.name === 'AbortError' || String(e).includes('Aborted'))){
            showDashEmpty('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
            showToast('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', false);
          }else{
            console.error(e);
            showTokenError();
            showDashEmpty(`–û—à–∏–±–∫–∞: ${e?.message || e}`);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ', false);
          }
        }finally{
          setRunning(false);
        }
      });

      stopBtn?.addEventListener('click', () => {
        try{ window.__swatAbort?.abort(); }catch(e){}
      });

      tabEmp?.addEventListener('click', () => applyTab('emp'));
      tabPlat?.addEventListener('click', () => applyTab('plat'));
      tabRetry?.addEventListener('click', () => applyTab('retry'));

      btnExportEmp?.addEventListener('click', exportEmployeeTableToXls);

      inpToken?.addEventListener('input', () => { clearTokenError(); saveInputs(); });
      inpRelease?.addEventListener('input', () => saveInputs());

      // ===== Init =====
      restoreInputs();
      clearTokenError();
      applyTab(loadActiveTab());
      showDashEmpty('–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞');
    })();
  </script>
</body>
</html>
